{"version":3,"file":"spartacus-smartedit-core.js","sources":["../../../feature-libs/smartedit/core/services/smart-edit.service.ts","../../../feature-libs/smartedit/core/decorators/smart-edit-component-decorator.ts","../../../feature-libs/smartedit/core/decorators/smart-edit-slot-decorator.ts","../../../feature-libs/smartedit/core/decorators/index.ts","../../../feature-libs/smartedit/core/smart-edit-core.module.ts","../../../feature-libs/smartedit/core/spartacus-smartedit-core.ts"],"sourcesContent":["import { Injectable, NgZone, Renderer2, RendererFactory2 } from '@angular/core';\nimport {\n  BaseSiteService,\n  CmsService,\n  Page,\n  PageType,\n  RoutingService,\n  ScriptLoader,\n  WindowRef,\n} from '@spartacus/core';\nimport { SmartEditConfig } from '@spartacus/smartedit/root';\nimport { filter, take } from 'rxjs/operators';\n\n@Injectable({\n  providedIn: 'root',\n})\nexport class SmartEditService {\n  private isPreviewPage = false;\n  private _currentPageId: string | undefined;\n\n  private defaultPreviewProductCode: string | undefined;\n  private defaultPreviewCategoryCode: string | undefined;\n\n  constructor(\n    protected cmsService: CmsService,\n    protected routingService: RoutingService,\n    protected baseSiteService: BaseSiteService,\n    protected zone: NgZone,\n    protected winRef: WindowRef,\n    protected rendererFactory: RendererFactory2,\n    protected config: SmartEditConfig,\n    protected scriptLoader: ScriptLoader\n  ) {\n    // load webApplicationInjector.js first\n    this.loadScript();\n\n    if (winRef.nativeWindow) {\n      const window = winRef.nativeWindow as any;\n      // rerender components and slots after editing\n      window.smartedit = window.smartedit || {};\n      window.smartedit.renderComponent = (\n        componentId: string,\n        componentType: string,\n        parentId: string\n      ) => {\n        return this.renderComponent(componentId, componentType, parentId);\n      };\n\n      // reprocess page\n      window.smartedit.reprocessPage = this.reprocessPage;\n    }\n  }\n\n  public processCmsPage(): void {\n    this.baseSiteService\n      .get()\n      .pipe(\n        filter((site: any) => Boolean(site)),\n        take(1)\n      )\n      .subscribe((site) => {\n        this.defaultPreviewCategoryCode = site.defaultPreviewCategoryCode;\n        this.defaultPreviewProductCode = site.defaultPreviewProductCode;\n\n        this.cmsService\n          .getCurrentPage()\n          .pipe(filter<Page>(Boolean))\n          .subscribe((cmsPage) => {\n            this._currentPageId = cmsPage.pageId;\n            // before adding contract to page, we need redirect to that page\n            this.goToPreviewPage(cmsPage);\n            this.addPageContract(cmsPage);\n          });\n      });\n  }\n\n  /**\n   * load webApplicationInjector.js\n   */\n  protected loadScript(): void {\n    this.scriptLoader.embedScript({\n      src: 'assets/webApplicationInjector.js',\n      params: undefined,\n      attributes: {\n        id: 'text/smartedit-injector',\n        'data-smartedit-allow-origin': this.config.smartEdit?.allowOrigin,\n      },\n    });\n  }\n\n  /**\n   * add CSS classes in a body tag\n   */\n  protected addPageContract(cmsPage: Page) {\n    const renderer = this.rendererFactory.createRenderer('body', null);\n    const element = this.winRef.document.body;\n\n    // remove old page contract\n    const previousContract: string[] = [];\n    Array.from(element.classList).forEach((attr) =>\n      previousContract.push(attr)\n    );\n    previousContract.forEach((attr) => renderer.removeClass(element, attr));\n\n    // add new page contract\n    this.addSmartEditContract(element, renderer, cmsPage.properties);\n  }\n\n  /**\n   * go to the default preview page\n   */\n  protected goToPreviewPage(cmsPage: Page) {\n    // only the first page is the smartedit preview page\n    if (!this.isPreviewPage) {\n      this.isPreviewPage = true;\n      if (\n        cmsPage.type === PageType.PRODUCT_PAGE &&\n        this.defaultPreviewProductCode\n      ) {\n        this.routingService.go({\n          cxRoute: 'product',\n          params: { code: this.defaultPreviewProductCode, name: '' },\n        });\n      } else if (\n        cmsPage.type === PageType.CATEGORY_PAGE &&\n        this.defaultPreviewCategoryCode\n      ) {\n        this.routingService.go({\n          cxRoute: 'category',\n          params: { code: this.defaultPreviewCategoryCode },\n        });\n      }\n    }\n  }\n\n  /**\n   * re-render CMS components and slots\n   */\n  protected renderComponent(\n    componentId: string,\n    componentType?: string,\n    parentId?: string\n  ): boolean {\n    if (componentId) {\n      this.zone.run(() => {\n        // without parentId, it is slot\n        if (!parentId) {\n          if (this._currentPageId) {\n            this.cmsService.refreshPageById(this._currentPageId);\n          } else {\n            this.cmsService.refreshLatestPage();\n          }\n        } else if (componentType) {\n          this.cmsService.refreshComponent(componentId);\n        }\n      });\n    }\n\n    return true;\n  }\n\n  protected reprocessPage() {\n    // TODO: reprocess page API\n  }\n\n  /**\n   * add smartedit HTML markup contract\n   */\n  public addSmartEditContract(\n    element: Element,\n    renderer: Renderer2,\n    properties: any\n  ): void {\n    if (properties) {\n      // check each group of properties, e.g. smartedit\n      Object.keys(properties).forEach((group) => {\n        const name = 'data-' + group + '-';\n        const groupProps = properties[group];\n\n        // check each property in the group\n        Object.keys(groupProps).forEach((propName) => {\n          const propValue = groupProps[propName];\n          if (propName === 'classes') {\n            const classes = propValue.split(' ');\n            classes.forEach((classItem: string) => {\n              renderer.addClass(element, classItem);\n            });\n          } else {\n            renderer.setAttribute(\n              element,\n              name +\n                propName\n                  .split(/(?=[A-Z])/)\n                  .join('-')\n                  .toLowerCase(),\n              propValue\n            );\n          }\n        });\n      });\n    }\n  }\n}\n","import { Injectable, Renderer2 } from '@angular/core';\nimport { ComponentDecorator, ContentSlotComponentData } from '@spartacus/core';\nimport { SmartEditService } from '../services/smart-edit.service';\n\n@Injectable({\n  providedIn: 'root',\n})\nexport class SmartEditComponentDecorator extends ComponentDecorator {\n  constructor(protected smartEditService: SmartEditService) {\n    super();\n  }\n\n  decorate(\n    element: Element,\n    renderer: Renderer2,\n    component: ContentSlotComponentData\n  ): void {\n    if (component) {\n      this.smartEditService.addSmartEditContract(\n        element,\n        renderer,\n        component.properties\n      );\n    }\n  }\n}\n","import { Injectable, Renderer2 } from '@angular/core';\nimport { ContentSlotData, SlotDecorator } from '@spartacus/core';\nimport { SmartEditService } from '../services/smart-edit.service';\n\n@Injectable({\n  providedIn: 'root',\n})\nexport class SmartEditSlotDecorator extends SlotDecorator {\n  constructor(protected smartEditService: SmartEditService) {\n    super();\n  }\n\n  decorate(element: Element, renderer: Renderer2, slot: ContentSlotData): void {\n    if (slot) {\n      this.smartEditService.addSmartEditContract(\n        element,\n        renderer,\n        slot.properties\n      );\n    }\n  }\n}\n","import { Provider } from '@angular/core';\nimport { ComponentDecorator, SlotDecorator } from '@spartacus/core';\nimport { SmartEditComponentDecorator } from './smart-edit-component-decorator';\nimport { SmartEditSlotDecorator } from './smart-edit-slot-decorator';\n\nexport const smartEditDecorators: Provider[] = [\n  {\n    provide: ComponentDecorator,\n    useExisting: SmartEditComponentDecorator,\n    multi: true,\n  },\n  {\n    provide: SlotDecorator,\n    useExisting: SmartEditSlotDecorator,\n    multi: true,\n  },\n];\n","import { NgModule } from '@angular/core';\nimport { smartEditDecorators } from './decorators/index';\nimport { SmartEditService } from './services/smart-edit.service';\n\n@NgModule({\n  providers: [...smartEditDecorators],\n})\nexport class SmartEditCoreModule {\n  constructor(private smartEditService: SmartEditService) {\n    this.smartEditService.processCmsPage();\n  }\n}\n","/**\n * Generated bundle index. Do not edit.\n */\n\nexport * from './public_api';\n"],"names":[],"mappings":"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"}