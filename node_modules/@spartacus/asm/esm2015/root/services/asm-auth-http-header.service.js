import { Injectable } from '@angular/core';
import { AuthHttpHeaderService, GlobalMessageType, InterceptorUtil, USE_CUSTOMER_SUPPORT_AGENT_TOKEN, } from '@spartacus/core';
import { take } from 'rxjs/operators';
import * as i0 from "@angular/core";
import * as i1 from "@spartacus/core";
import * as i2 from "./csagent-auth.service";
/**
 * Overrides `AuthHttpHeaderService` to handle asm calls as well (not only OCC)
 * in cases of normal user session and on customer emulation.
 */
export class AsmAuthHttpHeaderService extends AuthHttpHeaderService {
    constructor(authService, authStorageService, csAgentAuthService, oAuthLibWrapperService, routingService, globalMessageService, occEndpointsService, authRedirectService) {
        super(authService, authStorageService, oAuthLibWrapperService, routingService, occEndpointsService, globalMessageService, authRedirectService);
        this.authService = authService;
        this.authStorageService = authStorageService;
        this.csAgentAuthService = csAgentAuthService;
        this.oAuthLibWrapperService = oAuthLibWrapperService;
        this.routingService = routingService;
        this.globalMessageService = globalMessageService;
        this.occEndpointsService = occEndpointsService;
        this.authRedirectService = authRedirectService;
    }
    /**
     * Checks if the authorization header should be added to the request
     *
     *  @override
     */
    shouldAddAuthorizationHeader(request) {
        return (super.shouldAddAuthorizationHeader(request) ||
            this.isCSAgentTokenRequest(request));
    }
    /**
     * @override
     *
     * Checks if particular request should be handled by this service.
     */
    shouldCatchError(request) {
        return (super.shouldCatchError(request) || this.isCSAgentTokenRequest(request));
    }
    /**
     * @override
     *
     * Adds `Authorization` header to occ and CS agent requests.
     * For CS agent requests also removes the `cx-use-csagent-token` header (to avoid problems with CORS).
     */
    alterRequest(request, token) {
        const hasAuthorizationHeader = !!this.getAuthorizationHeader(request);
        const isCSAgentRequest = this.isCSAgentTokenRequest(request);
        let req = super.alterRequest(request, token);
        if (!hasAuthorizationHeader && isCSAgentRequest) {
            req = request.clone({
                setHeaders: Object.assign({}, this.createAuthorizationHeader(token)),
            });
            return InterceptorUtil.removeHeader(USE_CUSTOMER_SUPPORT_AGENT_TOKEN, req);
        }
        return req;
    }
    isCSAgentTokenRequest(request) {
        const isRequestWithCSAgentToken = InterceptorUtil.getInterceptorParam(USE_CUSTOMER_SUPPORT_AGENT_TOKEN, request.headers);
        return Boolean(isRequestWithCSAgentToken);
    }
    /**
     * @override
     *
     * On backend errors indicating expired `refresh_token` we need to logout
     * currently logged in user and CS agent.
     */
    handleExpiredRefreshToken() {
        this.csAgentAuthService
            .isCustomerSupportAgentLoggedIn()
            .pipe(take(1))
            .subscribe((csAgentLoggedIn) => {
            if (csAgentLoggedIn) {
                this.authService.setLogoutProgress(true);
                this.csAgentAuthService.logoutCustomerSupportAgent();
                this.globalMessageService.add({
                    key: 'asm.csagentTokenExpired',
                }, GlobalMessageType.MSG_TYPE_ERROR);
            }
            else {
                super.handleExpiredRefreshToken();
            }
        });
    }
}
AsmAuthHttpHeaderService.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "12.0.5", ngImport: i0, type: AsmAuthHttpHeaderService, deps: [{ token: i1.AuthService }, { token: i1.AuthStorageService }, { token: i2.CsAgentAuthService }, { token: i1.OAuthLibWrapperService }, { token: i1.RoutingService }, { token: i1.GlobalMessageService }, { token: i1.OccEndpointsService }, { token: i1.AuthRedirectService }], target: i0.ɵɵFactoryTarget.Injectable });
AsmAuthHttpHeaderService.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "12.0.5", ngImport: i0, type: AsmAuthHttpHeaderService, providedIn: 'root' });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "12.0.5", ngImport: i0, type: AsmAuthHttpHeaderService, decorators: [{
            type: Injectable,
            args: [{
                    providedIn: 'root',
                }]
        }], ctorParameters: function () { return [{ type: i1.AuthService }, { type: i1.AuthStorageService }, { type: i2.CsAgentAuthService }, { type: i1.OAuthLibWrapperService }, { type: i1.RoutingService }, { type: i1.GlobalMessageService }, { type: i1.OccEndpointsService }, { type: i1.AuthRedirectService }]; } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXNtLWF1dGgtaHR0cC1oZWFkZXIuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uL2ZlYXR1cmUtbGlicy9hc20vcm9vdC9zZXJ2aWNlcy9hc20tYXV0aC1odHRwLWhlYWRlci5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUNBLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDM0MsT0FBTyxFQUNMLHFCQUFxQixFQU1yQixpQkFBaUIsRUFDakIsZUFBZSxFQUlmLGdDQUFnQyxHQUNqQyxNQUFNLGlCQUFpQixDQUFDO0FBQ3pCLE9BQU8sRUFBRSxJQUFJLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQzs7OztBQUd0Qzs7O0dBR0c7QUFJSCxNQUFNLE9BQU8sd0JBQXlCLFNBQVEscUJBQXFCO0lBQ2pFLFlBQ1ksV0FBd0IsRUFDeEIsa0JBQXNDLEVBQ3RDLGtCQUFzQyxFQUN0QyxzQkFBOEMsRUFDOUMsY0FBOEIsRUFDOUIsb0JBQTBDLEVBQzFDLG1CQUF3QyxFQUN4QyxtQkFBd0M7UUFFbEQsS0FBSyxDQUNILFdBQVcsRUFDWCxrQkFBa0IsRUFDbEIsc0JBQXNCLEVBQ3RCLGNBQWMsRUFDZCxtQkFBbUIsRUFDbkIsb0JBQW9CLEVBQ3BCLG1CQUFtQixDQUNwQixDQUFDO1FBakJRLGdCQUFXLEdBQVgsV0FBVyxDQUFhO1FBQ3hCLHVCQUFrQixHQUFsQixrQkFBa0IsQ0FBb0I7UUFDdEMsdUJBQWtCLEdBQWxCLGtCQUFrQixDQUFvQjtRQUN0QywyQkFBc0IsR0FBdEIsc0JBQXNCLENBQXdCO1FBQzlDLG1CQUFjLEdBQWQsY0FBYyxDQUFnQjtRQUM5Qix5QkFBb0IsR0FBcEIsb0JBQW9CLENBQXNCO1FBQzFDLHdCQUFtQixHQUFuQixtQkFBbUIsQ0FBcUI7UUFDeEMsd0JBQW1CLEdBQW5CLG1CQUFtQixDQUFxQjtJQVdwRCxDQUFDO0lBRUQ7Ozs7T0FJRztJQUNJLDRCQUE0QixDQUFDLE9BQXlCO1FBQzNELE9BQU8sQ0FDTCxLQUFLLENBQUMsNEJBQTRCLENBQUMsT0FBTyxDQUFDO1lBQzNDLElBQUksQ0FBQyxxQkFBcUIsQ0FBQyxPQUFPLENBQUMsQ0FDcEMsQ0FBQztJQUNKLENBQUM7SUFFRDs7OztPQUlHO0lBQ0ksZ0JBQWdCLENBQUMsT0FBeUI7UUFDL0MsT0FBTyxDQUNMLEtBQUssQ0FBQyxnQkFBZ0IsQ0FBQyxPQUFPLENBQUMsSUFBSSxJQUFJLENBQUMscUJBQXFCLENBQUMsT0FBTyxDQUFDLENBQ3ZFLENBQUM7SUFDSixDQUFDO0lBRUQ7Ozs7O09BS0c7SUFDSSxZQUFZLENBQ2pCLE9BQXlCLEVBQ3pCLEtBQWlCO1FBRWpCLE1BQU0sc0JBQXNCLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQyxzQkFBc0IsQ0FBQyxPQUFPLENBQUMsQ0FBQztRQUN0RSxNQUFNLGdCQUFnQixHQUFHLElBQUksQ0FBQyxxQkFBcUIsQ0FBQyxPQUFPLENBQUMsQ0FBQztRQUU3RCxJQUFJLEdBQUcsR0FBRyxLQUFLLENBQUMsWUFBWSxDQUFDLE9BQU8sRUFBRSxLQUFLLENBQUMsQ0FBQztRQUU3QyxJQUFJLENBQUMsc0JBQXNCLElBQUksZ0JBQWdCLEVBQUU7WUFDL0MsR0FBRyxHQUFHLE9BQU8sQ0FBQyxLQUFLLENBQUM7Z0JBQ2xCLFVBQVUsb0JBQ0wsSUFBSSxDQUFDLHlCQUF5QixDQUFDLEtBQUssQ0FBQyxDQUN6QzthQUNGLENBQUMsQ0FBQztZQUNILE9BQU8sZUFBZSxDQUFDLFlBQVksQ0FDakMsZ0NBQWdDLEVBQ2hDLEdBQUcsQ0FDSixDQUFDO1NBQ0g7UUFDRCxPQUFPLEdBQUcsQ0FBQztJQUNiLENBQUM7SUFFUyxxQkFBcUIsQ0FBQyxPQUF5QjtRQUN2RCxNQUFNLHlCQUF5QixHQUFHLGVBQWUsQ0FBQyxtQkFBbUIsQ0FDbkUsZ0NBQWdDLEVBQ2hDLE9BQU8sQ0FBQyxPQUFPLENBQ2hCLENBQUM7UUFDRixPQUFPLE9BQU8sQ0FBQyx5QkFBeUIsQ0FBQyxDQUFDO0lBQzVDLENBQUM7SUFFRDs7Ozs7T0FLRztJQUNJLHlCQUF5QjtRQUM5QixJQUFJLENBQUMsa0JBQWtCO2FBQ3BCLDhCQUE4QixFQUFFO2FBQ2hDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7YUFDYixTQUFTLENBQUMsQ0FBQyxlQUFlLEVBQUUsRUFBRTtZQUM3QixJQUFJLGVBQWUsRUFBRTtnQkFDbkIsSUFBSSxDQUFDLFdBQVcsQ0FBQyxpQkFBaUIsQ0FBQyxJQUFJLENBQUMsQ0FBQztnQkFDekMsSUFBSSxDQUFDLGtCQUFrQixDQUFDLDBCQUEwQixFQUFFLENBQUM7Z0JBQ3JELElBQUksQ0FBQyxvQkFBb0IsQ0FBQyxHQUFHLENBQzNCO29CQUNFLEdBQUcsRUFBRSx5QkFBeUI7aUJBQy9CLEVBQ0QsaUJBQWlCLENBQUMsY0FBYyxDQUNqQyxDQUFDO2FBQ0g7aUJBQU07Z0JBQ0wsS0FBSyxDQUFDLHlCQUF5QixFQUFFLENBQUM7YUFDbkM7UUFDSCxDQUFDLENBQUMsQ0FBQztJQUNQLENBQUM7O3FIQTFHVSx3QkFBd0I7eUhBQXhCLHdCQUF3QixjQUZ2QixNQUFNOzJGQUVQLHdCQUF3QjtrQkFIcEMsVUFBVTttQkFBQztvQkFDVixVQUFVLEVBQUUsTUFBTTtpQkFDbkIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBIdHRwUmVxdWVzdCB9IGZyb20gJ0Bhbmd1bGFyL2NvbW1vbi9odHRwJztcbmltcG9ydCB7IEluamVjdGFibGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7XG4gIEF1dGhIdHRwSGVhZGVyU2VydmljZSxcbiAgQXV0aFJlZGlyZWN0U2VydmljZSxcbiAgQXV0aFNlcnZpY2UsXG4gIEF1dGhTdG9yYWdlU2VydmljZSxcbiAgQXV0aFRva2VuLFxuICBHbG9iYWxNZXNzYWdlU2VydmljZSxcbiAgR2xvYmFsTWVzc2FnZVR5cGUsXG4gIEludGVyY2VwdG9yVXRpbCxcbiAgT0F1dGhMaWJXcmFwcGVyU2VydmljZSxcbiAgT2NjRW5kcG9pbnRzU2VydmljZSxcbiAgUm91dGluZ1NlcnZpY2UsXG4gIFVTRV9DVVNUT01FUl9TVVBQT1JUX0FHRU5UX1RPS0VOLFxufSBmcm9tICdAc3BhcnRhY3VzL2NvcmUnO1xuaW1wb3J0IHsgdGFrZSB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcbmltcG9ydCB7IENzQWdlbnRBdXRoU2VydmljZSB9IGZyb20gJy4vY3NhZ2VudC1hdXRoLnNlcnZpY2UnO1xuXG4vKipcbiAqIE92ZXJyaWRlcyBgQXV0aEh0dHBIZWFkZXJTZXJ2aWNlYCB0byBoYW5kbGUgYXNtIGNhbGxzIGFzIHdlbGwgKG5vdCBvbmx5IE9DQylcbiAqIGluIGNhc2VzIG9mIG5vcm1hbCB1c2VyIHNlc3Npb24gYW5kIG9uIGN1c3RvbWVyIGVtdWxhdGlvbi5cbiAqL1xuQEluamVjdGFibGUoe1xuICBwcm92aWRlZEluOiAncm9vdCcsXG59KVxuZXhwb3J0IGNsYXNzIEFzbUF1dGhIdHRwSGVhZGVyU2VydmljZSBleHRlbmRzIEF1dGhIdHRwSGVhZGVyU2VydmljZSB7XG4gIGNvbnN0cnVjdG9yKFxuICAgIHByb3RlY3RlZCBhdXRoU2VydmljZTogQXV0aFNlcnZpY2UsXG4gICAgcHJvdGVjdGVkIGF1dGhTdG9yYWdlU2VydmljZTogQXV0aFN0b3JhZ2VTZXJ2aWNlLFxuICAgIHByb3RlY3RlZCBjc0FnZW50QXV0aFNlcnZpY2U6IENzQWdlbnRBdXRoU2VydmljZSxcbiAgICBwcm90ZWN0ZWQgb0F1dGhMaWJXcmFwcGVyU2VydmljZTogT0F1dGhMaWJXcmFwcGVyU2VydmljZSxcbiAgICBwcm90ZWN0ZWQgcm91dGluZ1NlcnZpY2U6IFJvdXRpbmdTZXJ2aWNlLFxuICAgIHByb3RlY3RlZCBnbG9iYWxNZXNzYWdlU2VydmljZTogR2xvYmFsTWVzc2FnZVNlcnZpY2UsXG4gICAgcHJvdGVjdGVkIG9jY0VuZHBvaW50c1NlcnZpY2U6IE9jY0VuZHBvaW50c1NlcnZpY2UsXG4gICAgcHJvdGVjdGVkIGF1dGhSZWRpcmVjdFNlcnZpY2U6IEF1dGhSZWRpcmVjdFNlcnZpY2VcbiAgKSB7XG4gICAgc3VwZXIoXG4gICAgICBhdXRoU2VydmljZSxcbiAgICAgIGF1dGhTdG9yYWdlU2VydmljZSxcbiAgICAgIG9BdXRoTGliV3JhcHBlclNlcnZpY2UsXG4gICAgICByb3V0aW5nU2VydmljZSxcbiAgICAgIG9jY0VuZHBvaW50c1NlcnZpY2UsXG4gICAgICBnbG9iYWxNZXNzYWdlU2VydmljZSxcbiAgICAgIGF1dGhSZWRpcmVjdFNlcnZpY2VcbiAgICApO1xuICB9XG5cbiAgLyoqXG4gICAqIENoZWNrcyBpZiB0aGUgYXV0aG9yaXphdGlvbiBoZWFkZXIgc2hvdWxkIGJlIGFkZGVkIHRvIHRoZSByZXF1ZXN0XG4gICAqXG4gICAqICBAb3ZlcnJpZGVcbiAgICovXG4gIHB1YmxpYyBzaG91bGRBZGRBdXRob3JpemF0aW9uSGVhZGVyKHJlcXVlc3Q6IEh0dHBSZXF1ZXN0PGFueT4pOiBib29sZWFuIHtcbiAgICByZXR1cm4gKFxuICAgICAgc3VwZXIuc2hvdWxkQWRkQXV0aG9yaXphdGlvbkhlYWRlcihyZXF1ZXN0KSB8fFxuICAgICAgdGhpcy5pc0NTQWdlbnRUb2tlblJlcXVlc3QocmVxdWVzdClcbiAgICApO1xuICB9XG5cbiAgLyoqXG4gICAqIEBvdmVycmlkZVxuICAgKlxuICAgKiBDaGVja3MgaWYgcGFydGljdWxhciByZXF1ZXN0IHNob3VsZCBiZSBoYW5kbGVkIGJ5IHRoaXMgc2VydmljZS5cbiAgICovXG4gIHB1YmxpYyBzaG91bGRDYXRjaEVycm9yKHJlcXVlc3Q6IEh0dHBSZXF1ZXN0PGFueT4pOiBib29sZWFuIHtcbiAgICByZXR1cm4gKFxuICAgICAgc3VwZXIuc2hvdWxkQ2F0Y2hFcnJvcihyZXF1ZXN0KSB8fCB0aGlzLmlzQ1NBZ2VudFRva2VuUmVxdWVzdChyZXF1ZXN0KVxuICAgICk7XG4gIH1cblxuICAvKipcbiAgICogQG92ZXJyaWRlXG4gICAqXG4gICAqIEFkZHMgYEF1dGhvcml6YXRpb25gIGhlYWRlciB0byBvY2MgYW5kIENTIGFnZW50IHJlcXVlc3RzLlxuICAgKiBGb3IgQ1MgYWdlbnQgcmVxdWVzdHMgYWxzbyByZW1vdmVzIHRoZSBgY3gtdXNlLWNzYWdlbnQtdG9rZW5gIGhlYWRlciAodG8gYXZvaWQgcHJvYmxlbXMgd2l0aCBDT1JTKS5cbiAgICovXG4gIHB1YmxpYyBhbHRlclJlcXVlc3QoXG4gICAgcmVxdWVzdDogSHR0cFJlcXVlc3Q8YW55PixcbiAgICB0b2tlbj86IEF1dGhUb2tlblxuICApOiBIdHRwUmVxdWVzdDxhbnk+IHtcbiAgICBjb25zdCBoYXNBdXRob3JpemF0aW9uSGVhZGVyID0gISF0aGlzLmdldEF1dGhvcml6YXRpb25IZWFkZXIocmVxdWVzdCk7XG4gICAgY29uc3QgaXNDU0FnZW50UmVxdWVzdCA9IHRoaXMuaXNDU0FnZW50VG9rZW5SZXF1ZXN0KHJlcXVlc3QpO1xuXG4gICAgbGV0IHJlcSA9IHN1cGVyLmFsdGVyUmVxdWVzdChyZXF1ZXN0LCB0b2tlbik7XG5cbiAgICBpZiAoIWhhc0F1dGhvcml6YXRpb25IZWFkZXIgJiYgaXNDU0FnZW50UmVxdWVzdCkge1xuICAgICAgcmVxID0gcmVxdWVzdC5jbG9uZSh7XG4gICAgICAgIHNldEhlYWRlcnM6IHtcbiAgICAgICAgICAuLi50aGlzLmNyZWF0ZUF1dGhvcml6YXRpb25IZWFkZXIodG9rZW4pLFxuICAgICAgICB9LFxuICAgICAgfSk7XG4gICAgICByZXR1cm4gSW50ZXJjZXB0b3JVdGlsLnJlbW92ZUhlYWRlcihcbiAgICAgICAgVVNFX0NVU1RPTUVSX1NVUFBPUlRfQUdFTlRfVE9LRU4sXG4gICAgICAgIHJlcVxuICAgICAgKTtcbiAgICB9XG4gICAgcmV0dXJuIHJlcTtcbiAgfVxuXG4gIHByb3RlY3RlZCBpc0NTQWdlbnRUb2tlblJlcXVlc3QocmVxdWVzdDogSHR0cFJlcXVlc3Q8YW55Pik6IGJvb2xlYW4ge1xuICAgIGNvbnN0IGlzUmVxdWVzdFdpdGhDU0FnZW50VG9rZW4gPSBJbnRlcmNlcHRvclV0aWwuZ2V0SW50ZXJjZXB0b3JQYXJhbShcbiAgICAgIFVTRV9DVVNUT01FUl9TVVBQT1JUX0FHRU5UX1RPS0VOLFxuICAgICAgcmVxdWVzdC5oZWFkZXJzXG4gICAgKTtcbiAgICByZXR1cm4gQm9vbGVhbihpc1JlcXVlc3RXaXRoQ1NBZ2VudFRva2VuKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBAb3ZlcnJpZGVcbiAgICpcbiAgICogT24gYmFja2VuZCBlcnJvcnMgaW5kaWNhdGluZyBleHBpcmVkIGByZWZyZXNoX3Rva2VuYCB3ZSBuZWVkIHRvIGxvZ291dFxuICAgKiBjdXJyZW50bHkgbG9nZ2VkIGluIHVzZXIgYW5kIENTIGFnZW50LlxuICAgKi9cbiAgcHVibGljIGhhbmRsZUV4cGlyZWRSZWZyZXNoVG9rZW4oKTogdm9pZCB7XG4gICAgdGhpcy5jc0FnZW50QXV0aFNlcnZpY2VcbiAgICAgIC5pc0N1c3RvbWVyU3VwcG9ydEFnZW50TG9nZ2VkSW4oKVxuICAgICAgLnBpcGUodGFrZSgxKSlcbiAgICAgIC5zdWJzY3JpYmUoKGNzQWdlbnRMb2dnZWRJbikgPT4ge1xuICAgICAgICBpZiAoY3NBZ2VudExvZ2dlZEluKSB7XG4gICAgICAgICAgdGhpcy5hdXRoU2VydmljZS5zZXRMb2dvdXRQcm9ncmVzcyh0cnVlKTtcbiAgICAgICAgICB0aGlzLmNzQWdlbnRBdXRoU2VydmljZS5sb2dvdXRDdXN0b21lclN1cHBvcnRBZ2VudCgpO1xuICAgICAgICAgIHRoaXMuZ2xvYmFsTWVzc2FnZVNlcnZpY2UuYWRkKFxuICAgICAgICAgICAge1xuICAgICAgICAgICAgICBrZXk6ICdhc20uY3NhZ2VudFRva2VuRXhwaXJlZCcsXG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgR2xvYmFsTWVzc2FnZVR5cGUuTVNHX1RZUEVfRVJST1JcbiAgICAgICAgICApO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHN1cGVyLmhhbmRsZUV4cGlyZWRSZWZyZXNoVG9rZW4oKTtcbiAgICAgICAgfVxuICAgICAgfSk7XG4gIH1cbn1cbiJdfQ==