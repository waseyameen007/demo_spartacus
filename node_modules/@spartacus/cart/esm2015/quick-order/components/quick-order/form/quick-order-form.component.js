import { ChangeDetectionStrategy, Component, } from '@angular/core';
import { FormControl, FormGroup } from '@angular/forms';
import { ICON_TYPE } from '@spartacus/storefront';
import { Subscription } from 'rxjs';
import { debounceTime, distinctUntilChanged, filter, switchMap, take, } from 'rxjs/operators';
import * as i0 from "@angular/core";
import * as i1 from "@spartacus/core";
import * as i2 from "@spartacus/cart/quick-order/root";
import * as i3 from "@spartacus/storefront";
import * as i4 from "@angular/forms";
import * as i5 from "@angular/common";
export class QuickOrderFormComponent {
    constructor(globalMessageService, // TODO(#14058): Remove it as it is not in use anymore
    quickOrderService, config, // TODO(#14058): Make it required
    cd, // TODO(#14058): Make it required
    winRef // TODO(#14058): Make it required
    ) {
        this.globalMessageService = globalMessageService;
        this.quickOrderService = quickOrderService;
        this.config = config;
        this.cd = cd;
        this.winRef = winRef;
        this.iconTypes = ICON_TYPE;
        this.isSearching = false;
        this.noResults = false;
        this.results = [];
        this.subscription = new Subscription();
        this.searchSubscription = new Subscription();
    }
    ngOnInit() {
        this.buildForm();
        this.subscription.add(this.watchProductAdd());
        this.subscription.add(this.watchQueryChange());
    }
    onBlur(event) {
        // Use timeout to detect changes
        setTimeout(() => {
            if (!this.isSuggestionFocused()) {
                this.blurSuggestionBox(event);
            }
        });
    }
    clear(event) {
        var _a, _b;
        event === null || event === void 0 ? void 0 : event.preventDefault();
        if (this.isResultsBoxOpen()) {
            this.toggleBodyClass('quick-order-searchbox-is-active', false);
        }
        let product = (_a = this.form.get('product')) === null || _a === void 0 ? void 0 : _a.value;
        if (!!product) {
            this.form.reset();
        }
        // We have to call 'close' method every time to make sure results list is empty and call detectChanges to change icon type in form
        this.close();
        (_b = this.cd) === null || _b === void 0 ? void 0 : _b.detectChanges();
    }
    add(product, event) {
        event === null || event === void 0 ? void 0 : event.preventDefault();
        // TODO change to nonpurchasable flag once we will support multidimensional products in search and when the purchasable flag will be available in search product response
        // Check if product is purchasable / non multidimensional
        if (product.multidimensional) {
            this.quickOrderService.setNonPurchasableProductError(product);
            this.clear();
            return;
        }
        else {
            this.quickOrderService.clearNonPurchasableProductError();
        }
        this.quickOrderService.addProduct(product);
    }
    addProduct(event) {
        this.quickOrderService
            .canAdd()
            .pipe(take(1))
            .subscribe((canAdd) => {
            if (canAdd) {
                // Add product if there is only one in the result list
                if (this.results.length === 1) {
                    this.add(this.results[0], event);
                    // Add product if there is focus on it
                }
                else if (this.getFocusedIndex() !== -1) {
                    const product = this.results[this.getFocusedIndex()];
                    this.add(product, event);
                }
            }
        });
    }
    focusNextChild(event) {
        event.preventDefault(); // Negate normal keyscroll
        if (!this.results.length) {
            return;
        }
        const [results, focusedIndex] = [
            this.getResultElements(),
            this.getFocusedIndex(),
        ];
        // Focus on first index moving to last
        if (results.length) {
            if (focusedIndex >= results.length - 1) {
                results[0].focus();
            }
            else {
                results[focusedIndex + 1].focus();
            }
        }
    }
    focusPreviousChild(event) {
        event.preventDefault(); // Negate normal keyscroll
        if (!this.results.length) {
            return;
        }
        const [results, focusedIndex] = [
            this.getResultElements(),
            this.getFocusedIndex(),
        ];
        // Focus on last index moving to first
        if (results.length) {
            if (focusedIndex < 1) {
                results[results.length - 1].focus();
            }
            else {
                results[focusedIndex - 1].focus();
            }
        }
    }
    isResultsBoxOpen() {
        return this.winRef
            ? !!this.winRef.document.querySelector('.quick-order-searchbox-is-active')
            : false;
    }
    canAddProduct() {
        return this.quickOrderService.canAdd();
    }
    open() {
        this.toggleBodyClass('quick-order-searchbox-is-active', true);
    }
    // Return result list as HTMLElement array
    getResultElements() {
        if (this.winRef) {
            return Array.from(this.winRef.document.querySelectorAll('.quick-order-results-products > li button'));
        }
        else {
            return [];
        }
    }
    blurSuggestionBox(event) {
        this.toggleBodyClass('quick-order-searchbox-is-active', false);
        if (event && event.target) {
            event.target.blur();
        }
    }
    // Return focused element as HTMLElement
    getFocusedElement() {
        if (this.winRef) {
            return this.winRef.document.activeElement;
        }
    }
    getFocusedIndex() {
        return this.getResultElements().indexOf(this.getFocusedElement());
    }
    isSuggestionFocused() {
        return this.getResultElements().includes(this.getFocusedElement());
    }
    toggleBodyClass(className, add) {
        // TODO(#14058): Remove condition
        if (this.winRef) {
            if (add === undefined) {
                this.winRef.document.body.classList.toggle(className);
            }
            else {
                add
                    ? this.winRef.document.body.classList.add(className)
                    : this.winRef.document.body.classList.remove(className);
            }
        }
    }
    buildForm() {
        const form = new FormGroup({});
        form.setControl('product', new FormControl(null));
        this.form = form;
    }
    isEmpty(string) {
        return (string === null || string === void 0 ? void 0 : string.trim()) === '' || string == null;
    }
    watchQueryChange() {
        return this.form.valueChanges
            .pipe(distinctUntilChanged(), debounceTime(300), filter((value) => {
            var _a, _b, _c, _d;
            if ((_b = (_a = this.config) === null || _a === void 0 ? void 0 : _a.quickOrder) === null || _b === void 0 ? void 0 : _b.searchForm) {
                //Check if input to quick order is an empty after deleting input manually
                if (this.isEmpty(value.product)) {
                    //Clear recommendation results on empty string
                    this.clear();
                    return false;
                }
                return (!!value.product &&
                    value.product.length >=
                        ((_d = (_c = this.config.quickOrder) === null || _c === void 0 ? void 0 : _c.searchForm) === null || _d === void 0 ? void 0 : _d.minCharactersBeforeRequest));
            }
            return value;
        }))
            .subscribe((value) => {
            this.searchProducts(value.product);
        });
    }
    searchProducts(query) {
        this.searchSubscription.add(this.canAddProduct()
            .pipe(filter(Boolean), switchMap(() => {
            var _a, _b, _c;
            return this.quickOrderService
                .searchProducts(query, (_c = (_b = (_a = this.config) === null || _a === void 0 ? void 0 : _a.quickOrder) === null || _b === void 0 ? void 0 : _b.searchForm) === null || _c === void 0 ? void 0 : _c.maxProducts)
                .pipe(take(1));
        }))
            .subscribe((products) => {
            var _a;
            this.results = products;
            if (this.results.length) {
                this.noResults = false;
                this.open();
            }
            else {
                this.noResults = true;
            }
            (_a = this.cd) === null || _a === void 0 ? void 0 : _a.detectChanges();
        }));
    }
    clearResults() {
        this.results = [];
    }
    close() {
        this.resetSearchSubscription();
        this.clearResults();
        this.noResults = false;
    }
    resetSearchSubscription() {
        this.searchSubscription.unsubscribe();
        this.searchSubscription = new Subscription();
    }
    watchProductAdd() {
        return this.quickOrderService
            .getProductAdded()
            .subscribe(() => this.clear());
    }
    ngOnDestroy() {
        this.subscription.unsubscribe();
    }
}
QuickOrderFormComponent.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "12.0.5", ngImport: i0, type: QuickOrderFormComponent, deps: [{ token: i1.GlobalMessageService }, { token: i2.QuickOrderFacade }, { token: i1.Config }, { token: i0.ChangeDetectorRef }, { token: i1.WindowRef }], target: i0.ɵɵFactoryTarget.Component });
QuickOrderFormComponent.ɵcmp = i0.ɵɵngDeclareComponent({ minVersion: "12.0.0", version: "12.0.5", type: QuickOrderFormComponent, selector: "cx-quick-order-form", ngImport: i0, template: "<form [formGroup]=\"form\" class=\"quick-order-form-container\">\n  <div class=\"quick-order-form-input\">\n    <input\n      (blur)=\"onBlur($event)\"\n      (focus)=\"open()\"\n      (keydown.arrowdown)=\"focusNextChild($event)\"\n      (keydown.arrowup)=\"focusPreviousChild($event)\"\n      (keydown.enter)=\"addProduct($event)\"\n      (keydown.escape)=\"clear($event)\"\n      [attr.aria-label]=\"'common.search' | cxTranslate\"\n      class=\"form-control\"\n      formControlName=\"product\"\n      placeholder=\"{{ 'quickOrderForm.placeholder' | cxTranslate }}\"\n      type=\"text\"\n    />\n\n    <button\n      *ngIf=\"form.get('product')?.value; else searchIcon\"\n      (click)=\"clear($event)\"\n      (keydown.enter)=\"clear($event)\"\n      [attr.aria-label]=\"'common.reset' | cxTranslate\"\n      class=\"quick-order-form-reset-icon\"\n    >\n      <cx-icon [type]=\"iconTypes.RESET\"></cx-icon>\n    </button>\n\n    <ng-template #searchIcon>\n      <button\n        [attr.aria-label]=\"'common.search' | cxTranslate\"\n        class=\"quick-order-form-search-icon\"\n        tabindex=\"-1\"\n      >\n        <cx-icon [type]=\"iconTypes.SEARCH\"></cx-icon>\n      </button>\n    </ng-template>\n\n    <span\n      *ngIf=\"!(canAddProduct() | async) && form.get('product')?.dirty\"\n      class=\"list-limit-reached-text\"\n    >\n      {{ 'quickOrderForm.listLimitReached' | cxTranslate }}\n    </span>\n  </div>\n\n  <div *ngIf=\"isResultsBoxOpen()\" role=\"listbox\" class=\"quick-order-results\">\n    <ul *ngIf=\"results.length\" class=\"quick-order-results-products\">\n      <li\n        *ngFor=\"let product of results; let i = index\"\n        class=\"quick-order-results-product-container\"\n      >\n        <button\n          (blur)=\"onBlur($event)\"\n          (click)=\"add(product, $event)\"\n          (keydown.arrowdown)=\"focusNextChild($event)\"\n          (keydown.arrowup)=\"focusPreviousChild($event)\"\n          (keydown.enter)=\"add(product, $event)\"\n          (keydown.escape)=\"clear($event)\"\n          [attr.aria-label]=\"\n            'quickOrderForm.addProduct' | cxTranslate: { product: product.name }\n          \"\n          [class.has-media]=\"\n            config?.quickOrder?.searchForm?.displayProductImages\n          \"\n          class=\"quick-order-results-product\"\n        >\n          <cx-media\n            *ngIf=\"config?.quickOrder?.searchForm?.displayProductImages\"\n            [container]=\"product.images?.PRIMARY\"\n            class=\"media\"\n            format=\"thumbnail\"\n            role=\"presentation\"\n          ></cx-media>\n          <div class=\"name\" [innerHTML]=\"product.name\"></div>\n          <span class=\"id\">\n            {{\n              'quickOrderForm.id'\n                | cxTranslate\n                  : {\n                      id: product.code\n                    }\n            }}\n          </span>\n          <span class=\"price\">{{ product.price?.formattedValue }}</span>\n        </button>\n      </li>\n    </ul>\n\n    <span *ngIf=\"noResults\" class=\"quick-order-no-results\">\n      {{ 'quickOrderForm.noResults' | cxTranslate }}\n    </span>\n  </div>\n</form>\n", components: [{ type: i3.IconComponent, selector: "cx-icon,[cxIcon]", inputs: ["cxIcon", "type"] }, { type: i3.MediaComponent, selector: "cx-media", inputs: ["container", "format", "alt", "role", "loading"], outputs: ["loaded"] }], directives: [{ type: i4.ɵNgNoValidate, selector: "form:not([ngNoForm]):not([ngNativeValidate])" }, { type: i4.NgControlStatusGroup, selector: "[formGroupName],[formArrayName],[ngModelGroup],[formGroup],form:not([ngNoForm]),[ngForm]" }, { type: i4.FormGroupDirective, selector: "[formGroup]", inputs: ["formGroup"], outputs: ["ngSubmit"], exportAs: ["ngForm"] }, { type: i4.DefaultValueAccessor, selector: "input:not([type=checkbox])[formControlName],textarea[formControlName],input:not([type=checkbox])[formControl],textarea[formControl],input:not([type=checkbox])[ngModel],textarea[ngModel],[ngDefaultControl]" }, { type: i4.NgControlStatus, selector: "[formControlName],[ngModel],[formControl]" }, { type: i4.FormControlName, selector: "[formControlName]", inputs: ["disabled", "formControlName", "ngModel"], outputs: ["ngModelChange"] }, { type: i5.NgIf, selector: "[ngIf]", inputs: ["ngIf", "ngIfThen", "ngIfElse"] }, { type: i5.NgForOf, selector: "[ngFor][ngForOf]", inputs: ["ngForOf", "ngForTrackBy", "ngForTemplate"] }], pipes: { "cxTranslate": i1.TranslatePipe, "async": i5.AsyncPipe }, changeDetection: i0.ChangeDetectionStrategy.OnPush });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "12.0.5", ngImport: i0, type: QuickOrderFormComponent, decorators: [{
            type: Component,
            args: [{
                    selector: 'cx-quick-order-form',
                    templateUrl: './quick-order-form.component.html',
                    changeDetection: ChangeDetectionStrategy.OnPush,
                }]
        }], ctorParameters: function () { return [{ type: i1.GlobalMessageService }, { type: i2.QuickOrderFacade }, { type: i1.Config }, { type: i0.ChangeDetectorRef }, { type: i1.WindowRef }]; } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicXVpY2stb3JkZXItZm9ybS5jb21wb25lbnQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi8uLi9mZWF0dXJlLWxpYnMvY2FydC9xdWljay1vcmRlci9jb21wb25lbnRzL3F1aWNrLW9yZGVyL2Zvcm0vcXVpY2stb3JkZXItZm9ybS5jb21wb25lbnQudHMiLCIuLi8uLi8uLi8uLi8uLi8uLi8uLi9mZWF0dXJlLWxpYnMvY2FydC9xdWljay1vcmRlci9jb21wb25lbnRzL3F1aWNrLW9yZGVyL2Zvcm0vcXVpY2stb3JkZXItZm9ybS5jb21wb25lbnQuaHRtbCJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQ0wsdUJBQXVCLEVBRXZCLFNBQVMsR0FHVixNQUFNLGVBQWUsQ0FBQztBQUN2QixPQUFPLEVBQUUsV0FBVyxFQUFFLFNBQVMsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBUXhELE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSx1QkFBdUIsQ0FBQztBQUNsRCxPQUFPLEVBQWMsWUFBWSxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQ2hELE9BQU8sRUFDTCxZQUFZLEVBQ1osb0JBQW9CLEVBQ3BCLE1BQU0sRUFDTixTQUFTLEVBQ1QsSUFBSSxHQUNMLE1BQU0sZ0JBQWdCLENBQUM7Ozs7Ozs7QUFPeEIsTUFBTSxPQUFPLHVCQUF1QjtJQW9CbEMsWUFDWSxvQkFBMEMsRUFBRSxzREFBc0Q7SUFDbEcsaUJBQW1DLEVBQ3RDLE1BQWUsRUFBRSxpQ0FBaUM7SUFDL0MsRUFBc0IsRUFBRSxpQ0FBaUM7SUFDekQsTUFBa0IsQ0FBQyxpQ0FBaUM7O1FBSnBELHlCQUFvQixHQUFwQixvQkFBb0IsQ0FBc0I7UUFDMUMsc0JBQWlCLEdBQWpCLGlCQUFpQixDQUFrQjtRQUN0QyxXQUFNLEdBQU4sTUFBTSxDQUFTO1FBQ1osT0FBRSxHQUFGLEVBQUUsQ0FBb0I7UUFDdEIsV0FBTSxHQUFOLE1BQU0sQ0FBWTtRQXZCOUIsY0FB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QXVCLDJEQzlCcEMsd25HQTRGQTsyRkQ5RGEsdUJBQXVCO2tCQUxuQyxTQUFTO21CQUFDO29CQUNULFFBQVEsRUFBRSxxQkFBcUI7b0JBQy9CLFdBQVcsRUFBRSxtQ0FBbUM7b0JBQ2hELGVBQWUsRUFBRSx1QkFBdUIsQ0FBQyxNQUFNO2lCQUNoRCIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XG4gIENoYW5nZURldGVjdGlvblN0cmF0ZWd5LFxuICBDaGFuZ2VEZXRlY3RvclJlZixcbiAgQ29tcG9uZW50LFxuICBPbkRlc3Ryb3ksXG4gIE9uSW5pdCxcbn0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBGb3JtQ29udHJvbCwgRm9ybUdyb3VwIH0gZnJvbSAnQGFuZ3VsYXIvZm9ybXMnO1xuaW1wb3J0IHsgUXVpY2tPcmRlckZhY2FkZSB9IGZyb20gJ0BzcGFydGFjdXMvY2FydC9xdWljay1vcmRlci9yb290JztcbmltcG9ydCB7XG4gIENvbmZpZyxcbiAgR2xvYmFsTWVzc2FnZVNlcnZpY2UsXG4gIFByb2R1Y3QsXG4gIFdpbmRvd1JlZixcbn0gZnJvbSAnQHNwYXJ0YWN1cy9jb3JlJztcbmltcG9ydCB7IElDT05fVFlQRSB9IGZyb20gJ0BzcGFydGFjdXMvc3RvcmVmcm9udCc7XG5pbXBvcnQgeyBPYnNlcnZhYmxlLCBTdWJzY3JpcHRpb24gfSBmcm9tICdyeGpzJztcbmltcG9ydCB7XG4gIGRlYm91bmNlVGltZSxcbiAgZGlzdGluY3RVbnRpbENoYW5nZWQsXG4gIGZpbHRlcixcbiAgc3dpdGNoTWFwLFxuICB0YWtlLFxufSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5cbkBDb21wb25lbnQoe1xuICBzZWxlY3RvcjogJ2N4LXF1aWNrLW9yZGVyLWZvcm0nLFxuICB0ZW1wbGF0ZVVybDogJy4vcXVpY2stb3JkZXItZm9ybS5jb21wb25lbnQuaHRtbCcsXG4gIGNoYW5nZURldGVjdGlvbjogQ2hhbmdlRGV0ZWN0aW9uU3RyYXRlZ3kuT25QdXNoLFxufSlcbmV4cG9ydCBjbGFzcyBRdWlja09yZGVyRm9ybUNvbXBvbmVudCBpbXBsZW1lbnRzIE9uSW5pdCwgT25EZXN0cm95IHtcbiAgZm9ybTogRm9ybUdyb3VwO1xuICBpY29uVHlwZXMgPSBJQ09OX1RZUEU7XG4gIGlzU2VhcmNoaW5nOiBib29sZWFuID0gZmFsc2U7XG4gIG5vUmVzdWx0czogYm9vbGVhbiA9IGZhbHNlO1xuICByZXN1bHRzOiBQcm9kdWN0W10gPSBbXTtcblxuICBwcm90ZWN0ZWQgc3Vic2NyaXB0aW9uID0gbmV3IFN1YnNjcmlwdGlvbigpO1xuICBwcm90ZWN0ZWQgc2VhcmNoU3Vic2NyaXB0aW9uID0gbmV3IFN1YnNjcmlwdGlvbigpO1xuXG4gIC8qKlxuICAgKiBAZGVwcmVjYXRlZCBzaW5jZSB2ZXJzaW9uIDQuMlxuICAgKiBVc2UgY29uc3RydWN0b3IoZ2xvYmFsTWVzc2FnZVNlcnZpY2U6IEdsb2JhbE1lc3NhZ2VTZXJ2aWNlLCBxdWlja09yZGVyU2VydmljZTogUXVpY2tPcmRlckZhY2FkZSwgY29uZmlnOiBDb25maWcsIGNkOiBDaGFuZ2VEZXRlY3RvclJlZiwgd2luUmVmOiBXaW5kb3dSZWYpOyBpbnN0ZWFkXG4gICAqL1xuICAvLyBUT0RPKCMxNDA1OCk6IFJlbW92ZSBkZXByZWNhdGVkIGNvbnN0cnVjdG9yXG4gIGNvbnN0cnVjdG9yKFxuICAgIGdsb2JhbE1lc3NhZ2VTZXJ2aWNlOiBHbG9iYWxNZXNzYWdlU2VydmljZSxcbiAgICBxdWlja09yZGVyU2VydmljZTogUXVpY2tPcmRlckZhY2FkZVxuICApO1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHByb3RlY3RlZCBnbG9iYWxNZXNzYWdlU2VydmljZTogR2xvYmFsTWVzc2FnZVNlcnZpY2UsIC8vIFRPRE8oIzE0MDU4KTogUmVtb3ZlIGl0IGFzIGl0IGlzIG5vdCBpbiB1c2UgYW55bW9yZVxuICAgIHByb3RlY3RlZCBxdWlja09yZGVyU2VydmljZTogUXVpY2tPcmRlckZhY2FkZSxcbiAgICBwdWJsaWMgY29uZmlnPzogQ29uZmlnLCAvLyBUT0RPKCMxNDA1OCk6IE1ha2UgaXQgcmVxdWlyZWRcbiAgICBwcm90ZWN0ZWQgY2Q/OiBDaGFuZ2VEZXRlY3RvclJlZiwgLy8gVE9ETygjMTQwNTgpOiBNYWtlIGl0IHJlcXVpcmVkXG4gICAgcHJvdGVjdGVkIHdpblJlZj86IFdpbmRvd1JlZiAvLyBUT0RPKCMxNDA1OCk6IE1ha2UgaXQgcmVxdWlyZWRcbiAgKSB7fVxuXG4gIG5nT25Jbml0KCk6IHZvaWQge1xuICAgIHRoaXMuYnVpbGRGb3JtKCk7XG4gICAgdGhpcy5zdWJzY3JpcHRpb24uYWRkKHRoaXMud2F0Y2hQcm9kdWN0QWRkKCkpO1xuICAgIHRoaXMuc3Vic2NyaXB0aW9uLmFkZCh0aGlzLndhdGNoUXVlcnlDaGFuZ2UoKSk7XG4gIH1cblxuICBvbkJsdXIoZXZlbnQ6IFVJRXZlbnQpOiB2b2lkIHtcbiAgICAvLyBVc2UgdGltZW91dCB0byBkZXRlY3QgY2hhbmdlc1xuICAgIHNldFRpbWVvdXQoKCkgPT4ge1xuICAgICAgaWYgKCF0aGlzLmlzU3VnZ2VzdGlvbkZvY3VzZWQoKSkge1xuICAgICAgICB0aGlzLmJsdXJTdWdnZXN0aW9uQm94KGV2ZW50KTtcbiAgICAgIH1cbiAgICB9KTtcbiAgfVxuXG4gIGNsZWFyKGV2ZW50PzogRXZlbnQpOiB2b2lkIHtcbiAgICBldmVudD8ucHJldmVudERlZmF1bHQoKTtcblxuICAgIGlmICh0aGlzLmlzUmVzdWx0c0JveE9wZW4oKSkge1xuICAgICAgdGhpcy50b2dnbGVCb2R5Q2xhc3MoJ3F1aWNrLW9yZGVyLXNlYXJjaGJveC1pcy1hY3RpdmUnLCBmYWxzZSk7XG4gICAgfVxuXG4gICAgbGV0IHByb2R1Y3QgPSB0aGlzLmZvcm0uZ2V0KCdwcm9kdWN0Jyk/LnZhbHVlO1xuXG4gICAgaWYgKCEhcHJvZHVjdCkge1xuICAgICAgdGhpcy5mb3JtLnJlc2V0KCk7XG4gICAgfVxuXG4gICAgLy8gV2UgaGF2ZSB0byBjYWxsICdjbG9zZScgbWV0aG9kIGV2ZXJ5IHRpbWUgdG8gbWFrZSBzdXJlIHJlc3VsdHMgbGlzdCBpcyBlbXB0eSBhbmQgY2FsbCBkZXRlY3RDaGFuZ2VzIHRvIGNoYW5nZSBpY29uIHR5cGUgaW4gZm9ybVxuICAgIHRoaXMuY2xvc2UoKTtcbiAgICB0aGlzLmNkPy5kZXRlY3RDaGFuZ2VzKCk7XG4gIH1cblxuICBhZGQocHJvZHVjdDogUHJvZHVjdCwgZXZlbnQ6IEV2ZW50KTogdm9pZCB7XG4gICAgZXZlbnQ/LnByZXZlbnREZWZhdWx0KCk7XG5cbiAgICAvLyBUT0RPIGNoYW5nZSB0byBub25wdXJjaGFzYWJsZSBmbGFnIG9uY2Ugd2Ugd2lsbCBzdXBwb3J0IG11bHRpZGltZW5zaW9uYWwgcHJvZHVjdHMgaW4gc2VhcmNoIGFuZCB3aGVuIHRoZSBwdXJjaGFzYWJsZSBmbGFnIHdpbGwgYmUgYXZhaWxhYmxlIGluIHNlYXJjaCBwcm9kdWN0IHJlc3BvbnNlXG5cbiAgICAvLyBDaGVjayBpZiBwcm9kdWN0IGlzIHB1cmNoYXNhYmxlIC8gbm9uIG11bHRpZGltZW5zaW9uYWxcbiAgICBpZiAocHJvZHVjdC5tdWx0aWRpbWVuc2lvbmFsKSB7XG4gICAgICB0aGlzLnF1aWNrT3JkZXJTZXJ2aWNlLnNldE5vblB1cmNoYXNhYmxlUHJvZHVjdEVycm9yKHByb2R1Y3QpO1xuICAgICAgdGhpcy5jbGVhcigpO1xuICAgICAgcmV0dXJuO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLnF1aWNrT3JkZXJTZXJ2aWNlLmNsZWFyTm9uUHVyY2hhc2FibGVQcm9kdWN0RXJyb3IoKTtcbiAgICB9XG5cbiAgICB0aGlzLnF1aWNrT3JkZXJTZXJ2aWNlLmFkZFByb2R1Y3QocHJvZHVjdCk7XG4gIH1cblxuICBhZGRQcm9kdWN0KGV2ZW50OiBFdmVudCk6IHZvaWQge1xuICAgIHRoaXMucXVpY2tPcmRlclNlcnZpY2VcbiAgICAgIC5jYW5BZGQoKVxuICAgICAgLnBpcGUodGFrZSgxKSlcbiAgICAgIC5zdWJzY3JpYmUoKGNhbkFkZDogYm9vbGVhbikgPT4ge1xuICAgICAgICBpZiAoY2FuQWRkKSB7XG4gICAgICAgICAgLy8gQWRkIHByb2R1Y3QgaWYgdGhlcmUgaXMgb25seSBvbmUgaW4gdGhlIHJlc3VsdCBsaXN0XG4gICAgICAgICAgaWYgKHRoaXMucmVzdWx0cy5sZW5ndGggPT09IDEpIHtcbiAgICAgICAgICAgIHRoaXMuYWRkKHRoaXMucmVzdWx0c1swXSwgZXZlbnQpO1xuICAgICAgICAgICAgLy8gQWRkIHByb2R1Y3QgaWYgdGhlcmUgaXMgZm9jdXMgb24gaXRcbiAgICAgICAgICB9IGVsc2UgaWYgKHRoaXMuZ2V0Rm9jdXNlZEluZGV4KCkgIT09IC0xKSB7XG4gICAgICAgICAgICBjb25zdCBwcm9kdWN0ID0gdGhpcy5yZXN1bHRzW3RoaXMuZ2V0Rm9jdXNlZEluZGV4KCldO1xuICAgICAgICAgICAgdGhpcy5hZGQocHJvZHVjdCwgZXZlbnQpO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfSk7XG4gIH1cblxuICBmb2N1c05leHRDaGlsZChldmVudDogVUlFdmVudCk6IHZvaWQge1xuICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7IC8vIE5lZ2F0ZSBub3JtYWwga2V5c2Nyb2xsXG4gICAgaWYgKCF0aGlzLnJlc3VsdHMubGVuZ3RoKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgY29uc3QgW3Jlc3VsdHMsIGZvY3VzZWRJbmRleF0gPSBbXG4gICAgICB0aGlzLmdldFJlc3VsdEVsZW1lbnRzKCksXG4gICAgICB0aGlzLmdldEZvY3VzZWRJbmRleCgpLFxuICAgIF07XG5cbiAgICAvLyBGb2N1cyBvbiBmaXJzdCBpbmRleCBtb3ZpbmcgdG8gbGFzdFxuICAgIGlmIChyZXN1bHRzLmxlbmd0aCkge1xuICAgICAgaWYgKGZvY3VzZWRJbmRleCA+PSByZXN1bHRzLmxlbmd0aCAtIDEpIHtcbiAgICAgICAgcmVzdWx0c1swXS5mb2N1cygpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgcmVzdWx0c1tmb2N1c2VkSW5kZXggKyAxXS5mb2N1cygpO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIGZvY3VzUHJldmlvdXNDaGlsZChldmVudDogVUlFdmVudCk6IHZvaWQge1xuICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7IC8vIE5lZ2F0ZSBub3JtYWwga2V5c2Nyb2xsXG4gICAgaWYgKCF0aGlzLnJlc3VsdHMubGVuZ3RoKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgY29uc3QgW3Jlc3VsdHMsIGZvY3VzZWRJbmRleF0gPSBbXG4gICAgICB0aGlzLmdldFJlc3VsdEVsZW1lbnRzKCksXG4gICAgICB0aGlzLmdldEZvY3VzZWRJbmRleCgpLFxuICAgIF07XG5cbiAgICAvLyBGb2N1cyBvbiBsYXN0IGluZGV4IG1vdmluZyB0byBmaXJzdFxuICAgIGlmIChyZXN1bHRzLmxlbmd0aCkge1xuICAgICAgaWYgKGZvY3VzZWRJbmRleCA8IDEpIHtcbiAgICAgICAgcmVzdWx0c1tyZXN1bHRzLmxlbmd0aCAtIDFdLmZvY3VzKCk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICByZXN1bHRzW2ZvY3VzZWRJbmRleCAtIDFdLmZvY3VzKCk7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgaXNSZXN1bHRzQm94T3BlbigpOiBib29sZWFuIHtcbiAgICByZXR1cm4gdGhpcy53aW5SZWZcbiAgICAgID8gISF0aGlzLndpblJlZi5kb2N1bWVudC5xdWVyeVNlbGVjdG9yKCcucXVpY2stb3JkZXItc2VhcmNoYm94LWlzLWFjdGl2ZScpXG4gICAgICA6IGZhbHNlO1xuICB9XG5cbiAgY2FuQWRkUHJvZHVjdCgpOiBPYnNlcnZhYmxlPGJvb2xlYW4+IHtcbiAgICByZXR1cm4gdGhpcy5xdWlja09yZGVyU2VydmljZS5jYW5BZGQoKTtcbiAgfVxuXG4gIG9wZW4oKTogdm9pZCB7XG4gICAgdGhpcy50b2dnbGVCb2R5Q2xhc3MoJ3F1aWNrLW9yZGVyLXNlYXJjaGJveC1pcy1hY3RpdmUnLCB0cnVlKTtcbiAgfVxuXG4gIC8vIFJldHVybiByZXN1bHQgbGlzdCBhcyBIVE1MRWxlbWVudCBhcnJheVxuICBwcm90ZWN0ZWQgZ2V0UmVzdWx0RWxlbWVudHMoKTogSFRNTEVsZW1lbnRbXSB7XG4gICAgaWYgKHRoaXMud2luUmVmKSB7XG4gICAgICByZXR1cm4gQXJyYXkuZnJvbShcbiAgICAgICAgdGhpcy53aW5SZWYuZG9jdW1lbnQucXVlcnlTZWxlY3RvckFsbChcbiAgICAgICAgICAnLnF1aWNrLW9yZGVyLXJlc3VsdHMtcHJvZHVjdHMgPiBsaSBidXR0b24nXG4gICAgICAgIClcbiAgICAgICk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiBbXTtcbiAgICB9XG4gIH1cblxuICBwcm90ZWN0ZWQgYmx1clN1Z2dlc3Rpb25Cb3goZXZlbnQ6IFVJRXZlbnQpOiB2b2lkIHtcbiAgICB0aGlzLnRvZ2dsZUJvZHlDbGFzcygncXVpY2stb3JkZXItc2VhcmNoYm94LWlzLWFjdGl2ZScsIGZhbHNlKTtcblxuICAgIGlmIChldmVudCAmJiBldmVudC50YXJnZXQpIHtcbiAgICAgICg8SFRNTEVsZW1lbnQ+ZXZlbnQudGFyZ2V0KS5ibHVyKCk7XG4gICAgfVxuICB9XG5cbiAgLy8gUmV0dXJuIGZvY3VzZWQgZWxlbWVudCBhcyBIVE1MRWxlbWVudFxuICBwcm90ZWN0ZWQgZ2V0Rm9jdXNlZEVsZW1lbnQoKTogSFRNTEVsZW1lbnQgfCBhbnkge1xuICAgIGlmICh0aGlzLndpblJlZikge1xuICAgICAgcmV0dXJuIDxIVE1MRWxlbWVudD50aGlzLndpblJlZi5kb2N1bWVudC5hY3RpdmVFbGVtZW50O1xuICAgIH1cbiAgfVxuXG4gIHByb3RlY3RlZCBnZXRGb2N1c2VkSW5kZXgoKTogbnVtYmVyIHtcbiAgICByZXR1cm4gdGhpcy5nZXRSZXN1bHRFbGVtZW50cygpLmluZGV4T2YodGhpcy5nZXRGb2N1c2VkRWxlbWVudCgpKTtcbiAgfVxuXG4gIHByb3RlY3RlZCBpc1N1Z2dlc3Rpb25Gb2N1c2VkKCk6IGJvb2xlYW4ge1xuICAgIHJldHVybiB0aGlzLmdldFJlc3VsdEVsZW1lbnRzKCkuaW5jbHVkZXModGhpcy5nZXRGb2N1c2VkRWxlbWVudCgpKTtcbiAgfVxuXG4gIHByb3RlY3RlZCB0b2dnbGVCb2R5Q2xhc3MoY2xhc3NOYW1lOiBzdHJpbmcsIGFkZD86IGJvb2xlYW4pIHtcbiAgICAvLyBUT0RPKCMxNDA1OCk6IFJlbW92ZSBjb25kaXRpb25cbiAgICBpZiAodGhpcy53aW5SZWYpIHtcbiAgICAgIGlmIChhZGQgPT09IHVuZGVmaW5lZCkge1xuICAgICAgICB0aGlzLndpblJlZi5kb2N1bWVudC5ib2R5LmNsYXNzTGlzdC50b2dnbGUoY2xhc3NOYW1lKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGFkZFxuICAgICAgICAgID8gdGhpcy53aW5SZWYuZG9jdW1lbnQuYm9keS5jbGFzc0xpc3QuYWRkKGNsYXNzTmFtZSlcbiAgICAgICAgICA6IHRoaXMud2luUmVmLmRvY3VtZW50LmJvZHkuY2xhc3NMaXN0LnJlbW92ZShjbGFzc05hbWUpO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIHByb3RlY3RlZCBidWlsZEZvcm0oKSB7XG4gICAgY29uc3QgZm9ybSA9IG5ldyBGb3JtR3JvdXAoe30pO1xuICAgIGZvcm0uc2V0Q29udHJvbCgncHJvZHVjdCcsIG5ldyBGb3JtQ29udHJvbChudWxsKSk7XG5cbiAgICB0aGlzLmZvcm0gPSBmb3JtO1xuICB9XG5cbiAgcHJvdGVjdGVkIGlzRW1wdHkoc3RyaW5nPzogc3RyaW5nKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIHN0cmluZz8udHJpbSgpID09PSAnJyB8fCBzdHJpbmcgPT0gbnVsbDtcbiAgfVxuXG4gIHByb3RlY3RlZCB3YXRjaFF1ZXJ5Q2hhbmdlKCk6IFN1YnNjcmlwdGlvbiB7XG4gICAgcmV0dXJuIHRoaXMuZm9ybS52YWx1ZUNoYW5nZXNcbiAgICAgIC5waXBlKFxuICAgICAgICBkaXN0aW5jdFVudGlsQ2hhbmdlZCgpLFxuICAgICAgICBkZWJvdW5jZVRpbWUoMzAwKSxcbiAgICAgICAgZmlsdGVyKCh2YWx1ZSkgPT4ge1xuICAgICAgICAgIGlmICh0aGlzLmNvbmZpZz8ucXVpY2tPcmRlcj8uc2VhcmNoRm9ybSkge1xuICAgICAgICAgICAgLy9DaGVjayBpZiBpbnB1dCB0byBxdWljayBvcmRlciBpcyBhbiBlbXB0eSBhZnRlciBkZWxldGluZyBpbnB1dCBtYW51YWxseVxuICAgICAgICAgICAgaWYgKHRoaXMuaXNFbXB0eSh2YWx1ZS5wcm9kdWN0KSkge1xuICAgICAgICAgICAgICAvL0NsZWFyIHJlY29tbWVuZGF0aW9uIHJlc3VsdHMgb24gZW1wdHkgc3RyaW5nXG4gICAgICAgICAgICAgIHRoaXMuY2xlYXIoKTtcbiAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmV0dXJuIChcbiAgICAgICAgICAgICAgISF2YWx1ZS5wcm9kdWN0ICYmXG4gICAgICAgICAgICAgIHZhbHVlLnByb2R1Y3QubGVuZ3RoID49XG4gICAgICAgICAgICAgICAgdGhpcy5jb25maWcucXVpY2tPcmRlcj8uc2VhcmNoRm9ybT8ubWluQ2hhcmFjdGVyc0JlZm9yZVJlcXVlc3RcbiAgICAgICAgICAgICk7XG4gICAgICAgICAgfVxuXG4gICAgICAgICAgcmV0dXJuIHZhbHVlO1xuICAgICAgICB9KVxuICAgICAgKVxuICAgICAgLnN1YnNjcmliZSgodmFsdWUpID0+IHtcbiAgICAgICAgdGhpcy5zZWFyY2hQcm9kdWN0cyh2YWx1ZS5wcm9kdWN0KTtcbiAgICAgIH0pO1xuICB9XG5cbiAgcHJvdGVjdGVkIHNlYXJjaFByb2R1Y3RzKHF1ZXJ5OiBzdHJpbmcpOiB2b2lkIHtcbiAgICB0aGlzLnNlYXJjaFN1YnNjcmlwdGlvbi5hZGQoXG4gICAgICB0aGlzLmNhbkFkZFByb2R1Y3QoKVxuICAgICAgICAucGlwZShcbiAgICAgICAgICBmaWx0ZXIoQm9vbGVhbiksXG4gICAgICAgICAgc3dpdGNoTWFwKCgpID0+XG4gICAgICAgICAgICB0aGlzLnF1aWNrT3JkZXJTZXJ2aWNlXG4gICAgICAgICAgICAgIC5zZWFyY2hQcm9kdWN0cyhcbiAgICAgICAgICAgICAgICBxdWVyeSxcbiAgICAgICAgICAgICAgICB0aGlzLmNvbmZpZz8ucXVpY2tPcmRlcj8uc2VhcmNoRm9ybT8ubWF4UHJvZHVjdHNcbiAgICAgICAgICAgICAgKVxuICAgICAgICAgICAgICAucGlwZSh0YWtlKDEpKVxuICAgICAgICAgIClcbiAgICAgICAgKVxuICAgICAgICAuc3Vic2NyaWJlKChwcm9kdWN0cykgPT4ge1xuICAgICAgICAgIHRoaXMucmVzdWx0cyA9IHByb2R1Y3RzO1xuXG4gICAgICAgICAgaWYgKHRoaXMucmVzdWx0cy5sZW5ndGgpIHtcbiAgICAgICAgICAgIHRoaXMubm9SZXN1bHRzID0gZmFsc2U7XG4gICAgICAgICAgICB0aGlzLm9wZW4oKTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhpcy5ub1Jlc3VsdHMgPSB0cnVlO1xuICAgICAgICAgIH1cblxuICAgICAgICAgIHRoaXMuY2Q/LmRldGVjdENoYW5nZXMoKTtcbiAgICAgICAgfSlcbiAgICApO1xuICB9XG5cbiAgcHJvdGVjdGVkIGNsZWFyUmVzdWx0cygpOiB2b2lkIHtcbiAgICB0aGlzLnJlc3VsdHMgPSBbXTtcbiAgfVxuXG4gIHByb3RlY3RlZCBjbG9zZSgpOiB2b2lkIHtcbiAgICB0aGlzLnJlc2V0U2VhcmNoU3Vic2NyaXB0aW9uKCk7XG4gICAgdGhpcy5jbGVhclJlc3VsdHMoKTtcbiAgICB0aGlzLm5vUmVzdWx0cyA9IGZhbHNlO1xuICB9XG5cbiAgcHJvdGVjdGVkIHJlc2V0U2VhcmNoU3Vic2NyaXB0aW9uKCk6IHZvaWQge1xuICAgIHRoaXMuc2VhcmNoU3Vic2NyaXB0aW9uLnVuc3Vic2NyaWJlKCk7XG4gICAgdGhpcy5zZWFyY2hTdWJzY3JpcHRpb24gPSBuZXcgU3Vic2NyaXB0aW9uKCk7XG4gIH1cblxuICBwcm90ZWN0ZWQgd2F0Y2hQcm9kdWN0QWRkKCk6IFN1YnNjcmlwdGlvbiB7XG4gICAgcmV0dXJuIHRoaXMucXVpY2tPcmRlclNlcnZpY2VcbiAgICAgIC5nZXRQcm9kdWN0QWRkZWQoKVxuICAgICAgLnN1YnNjcmliZSgoKSA9PiB0aGlzLmNsZWFyKCkpO1xuICB9XG5cbiAgbmdPbkRlc3Ryb3koKTogdm9pZCB7XG4gICAgdGhpcy5zdWJzY3JpcHRpb24udW5zdWJzY3JpYmUoKTtcbiAgfVxufVxuIiwiPGZvcm0gW2Zvcm1Hcm91cF09XCJmb3JtXCIgY2xhc3M9XCJxdWljay1vcmRlci1mb3JtLWNvbnRhaW5lclwiPlxuICA8ZGl2IGNsYXNzPVwicXVpY2stb3JkZXItZm9ybS1pbnB1dFwiPlxuICAgIDxpbnB1dFxuICAgICAgKGJsdXIpPVwib25CbHVyKCRldmVudClcIlxuICAgICAgKGZvY3VzKT1cIm9wZW4oKVwiXG4gICAgICAoa2V5ZG93bi5hcnJvd2Rvd24pPVwiZm9jdXNOZXh0Q2hpbGQoJGV2ZW50KVwiXG4gICAgICAoa2V5ZG93bi5hcnJvd3VwKT1cImZvY3VzUHJldmlvdXNDaGlsZCgkZXZlbnQpXCJcbiAgICAgIChrZXlkb3duLmVudGVyKT1cImFkZFByb2R1Y3QoJGV2ZW50KVwiXG4gICAgICAoa2V5ZG93bi5lc2NhcGUpPVwiY2xlYXIoJGV2ZW50KVwiXG4gICAgICBbYXR0ci5hcmlhLWxhYmVsXT1cIidjb21tb24uc2VhcmNoJyB8IGN4VHJhbnNsYXRlXCJcbiAgICAgIGNsYXNzPVwiZm9ybS1jb250cm9sXCJcbiAgICAgIGZvcm1Db250cm9sTmFtZT1cInByb2R1Y3RcIlxuICAgICAgcGxhY2Vob2xkZXI9XCJ7eyAncXVpY2tPcmRlckZvcm0ucGxhY2Vob2xkZXInIHwgY3hUcmFuc2xhdGUgfX1cIlxuICAgICAgdHlwZT1cInRleHRcIlxuICAgIC8+XG5cbiAgICA8YnV0dG9uXG4gICAgICAqbmdJZj1cImZvcm0uZ2V0KCdwcm9kdWN0Jyk/LnZhbHVlOyBlbHNlIHNlYXJjaEljb25cIlxuICAgICAgKGNsaWNrKT1cImNsZWFyKCRldmVudClcIlxuICAgICAgKGtleWRvd24uZW50ZXIpPVwiY2xlYXIoJGV2ZW50KVwiXG4gICAgICBbYXR0ci5hcmlhLWxhYmVsXT1cIidjb21tb24ucmVzZXQnIHwgY3hUcmFuc2xhdGVcIlxuICAgICAgY2xhc3M9XCJxdWljay1vcmRlci1mb3JtLXJlc2V0LWljb25cIlxuICAgID5cbiAgICAgIDxjeC1pY29uIFt0eXBlXT1cImljb25UeXBlcy5SRVNFVFwiPjwvY3gtaWNvbj5cbiAgICA8L2J1dHRvbj5cblxuICAgIDxuZy10ZW1wbGF0ZSAjc2VhcmNoSWNvbj5cbiAgICAgIDxidXR0b25cbiAgICAgICAgW2F0dHIuYXJpYS1sYWJlbF09XCInY29tbW9uLnNlYXJjaCcgfCBjeFRyYW5zbGF0ZVwiXG4gICAgICAgIGNsYXNzPVwicXVpY2stb3JkZXItZm9ybS1zZWFyY2gtaWNvblwiXG4gICAgICAgIHRhYmluZGV4PVwiLTFcIlxuICAgICAgPlxuICAgICAgICA8Y3gtaWNvbiBbdHlwZV09XCJpY29uVHlwZXMuU0VBUkNIXCI+PC9jeC1pY29uPlxuICAgICAgPC9idXR0b24+XG4gICAgPC9uZy10ZW1wbGF0ZT5cblxuICAgIDxzcGFuXG4gICAgICAqbmdJZj1cIiEoY2FuQWRkUHJvZHVjdCgpIHwgYXN5bmMpICYmIGZvcm0uZ2V0KCdwcm9kdWN0Jyk/LmRpcnR5XCJcbiAgICAgIGNsYXNzPVwibGlzdC1saW1pdC1yZWFjaGVkLXRleHRcIlxuICAgID5cbiAgICAgIHt7ICdxdWlja09yZGVyRm9ybS5saXN0TGltaXRSZWFjaGVkJyB8IGN4VHJhbnNsYXRlIH19XG4gICAgPC9zcGFuPlxuICA8L2Rpdj5cblxuICA8ZGl2ICpuZ0lmPVwiaXNSZXN1bHRzQm94T3BlbigpXCIgcm9sZT1cImxpc3Rib3hcIiBjbGFzcz1cInF1aWNrLW9yZGVyLXJlc3VsdHNcIj5cbiAgICA8dWwgKm5nSWY9XCJyZXN1bHRzLmxlbmd0aFwiIGNsYXNzPVwicXVpY2stb3JkZXItcmVzdWx0cy1wcm9kdWN0c1wiPlxuICAgICAgPGxpXG4gICAgICAgICpuZ0Zvcj1cImxldCBwcm9kdWN0IG9mIHJlc3VsdHM7IGxldCBpID0gaW5kZXhcIlxuICAgICAgICBjbGFzcz1cInF1aWNrLW9yZGVyLXJlc3VsdHMtcHJvZHVjdC1jb250YWluZXJcIlxuICAgICAgPlxuICAgICAgICA8YnV0dG9uXG4gICAgICAgICAgKGJsdXIpPVwib25CbHVyKCRldmVudClcIlxuICAgICAgICAgIChjbGljayk9XCJhZGQocHJvZHVjdCwgJGV2ZW50KVwiXG4gICAgICAgICAgKGtleWRvd24uYXJyb3dkb3duKT1cImZvY3VzTmV4dENoaWxkKCRldmVudClcIlxuICAgICAgICAgIChrZXlkb3duLmFycm93dXApPVwiZm9jdXNQcmV2aW91c0NoaWxkKCRldmVudClcIlxuICAgICAgICAgIChrZXlkb3duLmVudGVyKT1cImFkZChwcm9kdWN0LCAkZXZlbnQpXCJcbiAgICAgICAgICAoa2V5ZG93bi5lc2NhcGUpPVwiY2xlYXIoJGV2ZW50KVwiXG4gICAgICAgICAgW2F0dHIuYXJpYS1sYWJlbF09XCJcbiAgICAgICAgICAgICdxdWlja09yZGVyRm9ybS5hZGRQcm9kdWN0JyB8IGN4VHJhbnNsYXRlOiB7IHByb2R1Y3Q6IHByb2R1Y3QubmFtZSB9XG4gICAgICAgICAgXCJcbiAgICAgICAgICBbY2xhc3MuaGFzLW1lZGlhXT1cIlxuICAgICAgICAgICAgY29uZmlnPy5xdWlja09yZGVyPy5zZWFyY2hGb3JtPy5kaXNwbGF5UHJvZHVjdEltYWdlc1xuICAgICAgICAgIFwiXG4gICAgICAgICAgY2xhc3M9XCJxdWljay1vcmRlci1yZXN1bHRzLXByb2R1Y3RcIlxuICAgICAgICA+XG4gICAgICAgICAgPGN4LW1lZGlhXG4gICAgICAgICAgICAqbmdJZj1cImNvbmZpZz8ucXVpY2tPcmRlcj8uc2VhcmNoRm9ybT8uZGlzcGxheVByb2R1Y3RJbWFnZXNcIlxuICAgICAgICAgICAgW2NvbnRhaW5lcl09XCJwcm9kdWN0LmltYWdlcz8uUFJJTUFSWVwiXG4gICAgICAgICAgICBjbGFzcz1cIm1lZGlhXCJcbiAgICAgICAgICAgIGZvcm1hdD1cInRodW1ibmFpbFwiXG4gICAgICAgICAgICByb2xlPVwicHJlc2VudGF0aW9uXCJcbiAgICAgICAgICA+PC9jeC1tZWRpYT5cbiAgICAgICAgICA8ZGl2IGNsYXNzPVwibmFtZVwiIFtpbm5lckhUTUxdPVwicHJvZHVjdC5uYW1lXCI+PC9kaXY+XG4gICAgICAgICAgPHNwYW4gY2xhc3M9XCJpZFwiPlxuICAgICAgICAgICAge3tcbiAgICAgICAgICAgICAgJ3F1aWNrT3JkZXJGb3JtLmlkJ1xuICAgICAgICAgICAgICAgIHwgY3hUcmFuc2xhdGVcbiAgICAgICAgICAgICAgICAgIDoge1xuICAgICAgICAgICAgICAgICAgICAgIGlkOiBwcm9kdWN0LmNvZGVcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfX1cbiAgICAgICAgICA8L3NwYW4+XG4gICAgICAgICAgPHNwYW4gY2xhc3M9XCJwcmljZVwiPnt7IHByb2R1Y3QucHJpY2U/LmZvcm1hdHRlZFZhbHVlIH19PC9zcGFuPlxuICAgICAgICA8L2J1dHRvbj5cbiAgICAgIDwvbGk+XG4gICAgPC91bD5cblxuICAgIDxzcGFuICpuZ0lmPVwibm9SZXN1bHRzXCIgY2xhc3M9XCJxdWljay1vcmRlci1uby1yZXN1bHRzXCI+XG4gICAgICB7eyAncXVpY2tPcmRlckZvcm0ubm9SZXN1bHRzJyB8IGN4VHJhbnNsYXRlIH19XG4gICAgPC9zcGFuPlxuICA8L2Rpdj5cbjwvZm9ybT5cbiJdfQ==