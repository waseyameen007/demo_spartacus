import { ChangeDetectionStrategy, Component, EventEmitter, Input, Output, } from '@angular/core';
import { FormControl, FormGroup, Validators } from '@angular/forms';
import { FormUtils, } from '@spartacus/storefront';
import { of, Subject } from 'rxjs';
import { filter, startWith, switchMap, take, tap } from 'rxjs/operators';
import * as i0 from "@angular/core";
import * as i1 from "@spartacus/storefront";
import * as i2 from "../../import-products-from-csv.service";
import * as i3 from "@spartacus/cart/import-export/core";
import * as i4 from "@angular/common";
import * as i5 from "@angular/forms";
import * as i6 from "@spartacus/core";
export class ImportEntriesFormComponent {
    constructor(launchDialogService, importToCartService, importCsvService, filesFormValidators, importExportConfig) {
        this.launchDialogService = launchDialogService;
        this.importToCartService = importToCartService;
        this.importCsvService = importCsvService;
        this.filesFormValidators = filesFormValidators;
        this.importExportConfig = importExportConfig;
        this.formSubmitSubject$ = new Subject();
        this.submitEvent = new EventEmitter();
    }
    ngOnInit() {
        this.form = this.buildForm();
        this.formSubmitSubject$
            .pipe(tap(() => {
            if (this.form.invalid) {
                this.form.markAllAsTouched();
                FormUtils.deepUpdateValueAndValidity(this.form);
            }
        }), switchMap(() => {
            var _a;
            return this.form.statusChanges.pipe(startWith((_a = this.form.get('file')) === null || _a === void 0 ? void 0 : _a.status), filter((status) => status !== 'PENDING'), take(1));
        }), filter((status) => status === 'VALID'))
            .subscribe(() => {
            this.save();
        });
    }
    close(reason) {
        this.launchDialogService.closeDialog(reason);
    }
    save() {
        var _a, _b;
        const file = (_b = (_a = this.form.get('file')) === null || _a === void 0 ? void 0 : _a.value) === null || _b === void 0 ? void 0 : _b[0];
        if (this.separator !== undefined) {
            this.importCsvService
                .loadFile(file, this.separator)
                .subscribe((loadedFile) => {
                this.submitEvent.emit({
                    products: this.importToCartService.csvDataToProduct(loadedFile),
                });
            });
        }
    }
    buildForm() {
        const form = new FormGroup({});
        form.setControl('file', new FormControl('', [Validators.required, this.filesFormValidators.maxSize(this.maxSize)], [
            (control) => this.separator !== undefined
                ? this.importCsvService.validateFile(control.value[0], {
                    separator: this.separator,
                    isDataParsable: this.importToCartService.isDataParsableToProducts,
                    maxEntries: this.maxEntries,
                })
                : of(null),
        ]));
        return form;
    }
    get allowedTypes() {
        var _a, _b, _c;
        return (_c = (_b = (_a = this.importExportConfig.cartImportExport) === null || _a === void 0 ? void 0 : _a.import) === null || _b === void 0 ? void 0 : _b.fileValidity) === null || _c === void 0 ? void 0 : _c.allowedTypes;
    }
    get maxSize() {
        var _a, _b, _c;
        return (_c = (_b = (_a = this.importExportConfig.cartImportExport) === null || _a === void 0 ? void 0 : _a.import) === null || _b === void 0 ? void 0 : _b.fileValidity) === null || _c === void 0 ? void 0 : _c.maxSize;
    }
    get maxEntries() {
        var _a, _b, _c, _d;
        return (_d = (_c = (_b = (_a = this.importExportConfig.cartImportExport) === null || _a === void 0 ? void 0 : _a.import) === null || _b === void 0 ? void 0 : _b.fileValidity) === null || _c === void 0 ? void 0 : _c.maxEntries) === null || _d === void 0 ? void 0 : _d[this.type];
    }
    get separator() {
        var _a;
        return (_a = this.importExportConfig.cartImportExport) === null || _a === void 0 ? void 0 : _a.file.separator;
    }
}
ImportEntriesFormComponent.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "12.0.5", ngImport: i0, type: ImportEntriesFormComponent, deps: [{ token: i1.LaunchDialogService }, { token: i2.ImportProductsFromCsvService }, { token: i1.ImportCsvFileService }, { token: i1.FilesFormValidators }, { token: i3.ImportExportConfig }], target: i0.ɵɵFactoryTarget.Component });
ImportEntriesFormComponent.ɵcmp = i0.ɵɵngDeclareComponent({ minVersion: "12.0.0", version: "12.0.5", type: ImportEntriesFormComponent, selector: "cx-import-entries-form", inputs: { type: "type" }, outputs: { submitEvent: "submitEvent" }, ngImport: i0, template: "<form *ngIf=\"form\" [formGroup]=\"form\" (submit)=\"formSubmitSubject$.next()\">\n  <p class=\"cx-import-entries-subtitle\">\n    {{ 'importEntriesDialog.importProductsSubtitle' | cxTranslate }}\n  </p>\n  <p>\n    {{ 'importEntriesDialog.importProductFileDetails' | cxTranslate }}\n  </p>\n  <label>\n    <cx-file-upload [formControl]=\"form.get('file')\" [accept]=\"allowedTypes\">\n      {{ 'importEntriesDialog.selectFile' | cxTranslate }}\n    </cx-file-upload>\n    <cx-form-errors\n      [control]=\"form.get('file')\"\n      prefix=\"formErrors.file\"\n    ></cx-form-errors>\n  </label>\n  <div class=\"cx-import-entries-footer\">\n    <button\n      (click)=\"close('Close Import Products Dialog')\"\n      class=\"btn btn-action\"\n      type=\"button\"\n    >\n      {{ 'importEntriesDialog.cancel' | cxTranslate }}\n    </button>\n    <button\n      class=\"btn btn-primary\"\n      type=\"submit\"\n      [disabled]=\"form.get('file')?.status === 'PENDING'\"\n    >\n      {{ 'importEntriesDialog.upload' | cxTranslate }}\n    </button>\n  </div>\n</form>\n", components: [{ type: i1.FileUploadComponent, selector: "cx-file-upload", inputs: ["accept", "multiple"], outputs: ["update"] }, { type: i1.FormErrorsComponent, selector: "cx-form-errors", inputs: ["prefix", "translationParams", "control"] }], directives: [{ type: i4.NgIf, selector: "[ngIf]", inputs: ["ngIf", "ngIfThen", "ngIfElse"] }, { type: i5.ɵNgNoValidate, selector: "form:not([ngNoForm]):not([ngNativeValidate])" }, { type: i5.NgControlStatusGroup, selector: "[formGroupName],[formArrayName],[ngModelGroup],[formGroup],form:not([ngNoForm]),[ngForm]" }, { type: i5.FormGroupDirective, selector: "[formGroup]", inputs: ["formGroup"], outputs: ["ngSubmit"], exportAs: ["ngForm"] }, { type: i5.NgControlStatus, selector: "[formControlName],[ngModel],[formControl]" }, { type: i5.FormControlDirective, selector: "[formControl]", inputs: ["disabled", "formControl", "ngModel"], outputs: ["ngModelChange"], exportAs: ["ngForm"] }], pipes: { "cxTranslate": i6.TranslatePipe }, changeDetection: i0.ChangeDetectionStrategy.OnPush });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "12.0.5", ngImport: i0, type: ImportEntriesFormComponent, decorators: [{
            type: Component,
            args: [{
                    selector: 'cx-import-entries-form',
                    templateUrl: './import-entries-form.component.html',
                    changeDetection: ChangeDetectionStrategy.OnPush,
                }]
        }], ctorParameters: function () { return [{ type: i1.LaunchDialogService }, { type: i2.ImportProductsFromCsvService }, { type: i1.ImportCsvFileService }, { type: i1.FilesFormValidators }, { type: i3.ImportExportConfig }]; }, propDecorators: { submitEvent: [{
                type: Output
            }], type: [{
                type: Input
            }] } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW1wb3J0LWVudHJpZXMtZm9ybS5jb21wb25lbnQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi8uLi8uLi9mZWF0dXJlLWxpYnMvY2FydC9pbXBvcnQtZXhwb3J0L2NvbXBvbmVudHMvaW1wb3J0LXRvLWNhcnQvaW1wb3J0LWVudHJpZXMtZGlhbG9nL2ltcG9ydC1lbnRyaWVzLWZvcm0vaW1wb3J0LWVudHJpZXMtZm9ybS5jb21wb25lbnQudHMiLCIuLi8uLi8uLi8uLi8uLi8uLi8uLi8uLi9mZWF0dXJlLWxpYnMvY2FydC9pbXBvcnQtZXhwb3J0L2NvbXBvbmVudHMvaW1wb3J0LXRvLWNhcnQvaW1wb3J0LWVudHJpZXMtZGlhbG9nL2ltcG9ydC1lbnRyaWVzLWZvcm0vaW1wb3J0LWVudHJpZXMtZm9ybS5jb21wb25lbnQuaHRtbCJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQ0wsdUJBQXVCLEVBQ3ZCLFNBQVMsRUFDVCxZQUFZLEVBQ1osS0FBSyxFQUVMLE1BQU0sR0FDUCxNQUFNLGVBQWUsQ0FBQztBQUN2QixPQUFPLEVBQUUsV0FBVyxFQUFFLFNBQVMsRUFBRSxVQUFVLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUVwRSxPQUFPLEVBR0wsU0FBUyxHQUlWLE1BQU0sdUJBQXVCLENBQUM7QUFDL0IsT0FBTyxFQUFFLEVBQUUsRUFBRSxPQUFPLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDbkMsT0FBTyxFQUFFLE1BQU0sRUFBRSxTQUFTLEVBQUUsU0FBUyxFQUFFLElBQUksRUFBRSxHQUFHLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQzs7Ozs7Ozs7QUFRekUsTUFBTSxPQUFPLDBCQUEwQjtJQWFyQyxZQUNZLG1CQUF3QyxFQUN4QyxtQkFBaUQsRUFDakQsZ0JBQXNDLEVBQ3RDLG1CQUF3QyxFQUN4QyxrQkFBc0M7UUFKdEMsd0JBQW1CLEdBQW5CLG1CQUFtQixDQUFxQjtRQUN4Qyx3QkFBbUIsR0FBbkIs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LFxuICBFdmVudEVtaXR0ZXIsXG4gIElucHV0LFxuICBPbkluaXQsXG4gIE91dHB1dCxcbn0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBGb3JtQ29udHJvbCwgRm9ybUdyb3VwLCBWYWxpZGF0b3JzIH0gZnJvbSAnQGFuZ3VsYXIvZm9ybXMnO1xuaW1wb3J0IHsgSW1wb3J0RXhwb3J0Q29uZmlnIH0gZnJvbSAnQHNwYXJ0YWN1cy9jYXJ0L2ltcG9ydC1leHBvcnQvY29yZSc7XG5pbXBvcnQge1xuICBPcmRlckVudHJpZXNTb3VyY2UsXG4gIEZpbGVzRm9ybVZhbGlkYXRvcnMsXG4gIEZvcm1VdGlscyxcbiAgSW1wb3J0Q3N2RmlsZVNlcnZpY2UsXG4gIExhdW5jaERpYWxvZ1NlcnZpY2UsXG4gIFByb2R1Y3REYXRhLFxufSBmcm9tICdAc3BhcnRhY3VzL3N0b3JlZnJvbnQnO1xuaW1wb3J0IHsgb2YsIFN1YmplY3QgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IGZpbHRlciwgc3RhcnRXaXRoLCBzd2l0Y2hNYXAsIHRha2UsIHRhcCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcbmltcG9ydCB7IEltcG9ydFByb2R1Y3RzRnJvbUNzdlNlcnZpY2UgfSBmcm9tICcuLi8uLi9pbXBvcnQtcHJvZHVjdHMtZnJvbS1jc3Yuc2VydmljZSc7XG5cbkBDb21wb25lbnQoe1xuICBzZWxlY3RvcjogJ2N4LWltcG9ydC1lbnRyaWVzLWZvcm0nLFxuICB0ZW1wbGF0ZVVybDogJy4vaW1wb3J0LWVudHJpZXMtZm9ybS5jb21wb25lbnQuaHRtbCcsXG4gIGNoYW5nZURldGVjdGlvbjogQ2hhbmdlRGV0ZWN0aW9uU3RyYXRlZ3kuT25QdXNoLFxufSlcbmV4cG9ydCBjbGFzcyBJbXBvcnRFbnRyaWVzRm9ybUNvbXBvbmVudCBpbXBsZW1lbnRzIE9uSW5pdCB7XG4gIGZvcm06IEZvcm1Hcm91cDtcbiAgbG9hZGVkRmlsZTogc3RyaW5nW11bXSB8IG51bGw7XG4gIGZvcm1TdWJtaXRTdWJqZWN0JCA9IG5ldyBTdWJqZWN0KCk7XG5cbiAgQE91dHB1dCgpXG4gIHN1Ym1pdEV2ZW50ID0gbmV3IEV2ZW50RW1pdHRlcjx7XG4gICAgcHJvZHVjdHM6IFByb2R1Y3REYXRhW107XG4gIH0+KCk7XG5cbiAgQElucHV0KClcbiAgdHlwZTogT3JkZXJFbnRyaWVzU291cmNlO1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHByb3RlY3RlZCBsYXVuY2hEaWFsb2dTZXJ2aWNlOiBMYXVuY2hEaWFsb2dTZXJ2aWNlLFxuICAgIHByb3RlY3RlZCBpbXBvcnRUb0NhcnRTZXJ2aWNlOiBJbXBvcnRQcm9kdWN0c0Zyb21Dc3ZTZXJ2aWNlLFxuICAgIHByb3RlY3RlZCBpbXBvcnRDc3ZTZXJ2aWNlOiBJbXBvcnRDc3ZGaWxlU2VydmljZSxcbiAgICBwcm90ZWN0ZWQgZmlsZXNGb3JtVmFsaWRhdG9yczogRmlsZXNGb3JtVmFsaWRhdG9ycyxcbiAgICBwcm90ZWN0ZWQgaW1wb3J0RXhwb3J0Q29uZmlnOiBJbXBvcnRFeHBvcnRDb25maWdcbiAgKSB7fVxuXG4gIG5nT25Jbml0KCkge1xuICAgIHRoaXMuZm9ybSA9IHRoaXMuYnVpbGRGb3JtKCk7XG5cbiAgICB0aGlzLmZvcm1TdWJtaXRTdWJqZWN0JFxuICAgICAgLnBpcGUoXG4gICAgICAgIHRhcCgoKSA9PiB7XG4gICAgICAgICAgaWYgKHRoaXMuZm9ybS5pbnZhbGlkKSB7XG4gICAgICAgICAgICB0aGlzLmZvcm0ubWFya0FsbEFzVG91Y2hlZCgpO1xuICAgICAgICAgICAgRm9ybVV0aWxzLmRlZXBVcGRhdGVWYWx1ZUFuZFZhbGlkaXR5KHRoaXMuZm9ybSk7XG4gICAgICAgICAgfVxuICAgICAgICB9KSxcbiAgICAgICAgc3dpdGNoTWFwKCgpID0+XG4gICAgICAgICAgdGhpcy5mb3JtLnN0YXR1c0NoYW5nZXMucGlwZShcbiAgICAgICAgICAgIHN0YXJ0V2l0aCh0aGlzLmZvcm0uZ2V0KCdmaWxlJyk/LnN0YXR1cyksXG4gICAgICAgICAgICBmaWx0ZXIoKHN0YXR1cykgPT4gc3RhdHVzICE9PSAnUEVORElORycpLFxuICAgICAgICAgICAgdGFrZSgxKVxuICAgICAgICAgIClcbiAgICAgICAgKSxcbiAgICAgICAgZmlsdGVyKChzdGF0dXMpID0+IHN0YXR1cyA9PT0gJ1ZBTElEJylcbiAgICAgIClcbiAgICAgIC5zdWJzY3JpYmUoKCkgPT4ge1xuICAgICAgICB0aGlzLnNhdmUoKTtcbiAgICAgIH0pO1xuICB9XG5cbiAgY2xvc2UocmVhc29uOiBzdHJpbmcpOiB2b2lkIHtcbiAgICB0aGlzLmxhdW5jaERpYWxvZ1NlcnZpY2UuY2xvc2VEaWFsb2cocmVhc29uKTtcbiAgfVxuXG4gIHNhdmUoKTogdm9pZCB7XG4gICAgY29uc3QgZmlsZTogRmlsZSA9IHRoaXMuZm9ybS5nZXQoJ2ZpbGUnKT8udmFsdWU/LlswXTtcbiAgICBpZiAodGhpcy5zZXBhcmF0b3IgIT09IHVuZGVmaW5lZCkge1xuICAgICAgdGhpcy5pbXBvcnRDc3ZTZXJ2aWNlXG4gICAgICAgIC5sb2FkRmlsZShmaWxlLCB0aGlzLnNlcGFyYXRvcilcbiAgICAgICAgLnN1YnNjcmliZSgobG9hZGVkRmlsZTogc3RyaW5nW11bXSkgPT4ge1xuICAgICAgICAgIHRoaXMuc3VibWl0RXZlbnQuZW1pdCh7XG4gICAgICAgICAgICBwcm9kdWN0czogdGhpcy5pbXBvcnRUb0NhcnRTZXJ2aWNlLmNzdkRhdGFUb1Byb2R1Y3QobG9hZGVkRmlsZSksXG4gICAgICAgICAgfSk7XG4gICAgICAgIH0pO1xuICAgIH1cbiAgfVxuXG4gIHByb3RlY3RlZCBidWlsZEZvcm0oKTogRm9ybUdyb3VwIHtcbiAgICBjb25zdCBmb3JtID0gbmV3IEZvcm1Hcm91cCh7fSk7XG4gICAgZm9ybS5zZXRDb250cm9sKFxuICAgICAgJ2ZpbGUnLFxuICAgICAgbmV3IEZvcm1Db250cm9sKFxuICAgICAgICAnJyxcbiAgICAgICAgW1ZhbGlkYXRvcnMucmVxdWlyZWQsIHRoaXMuZmlsZXNGb3JtVmFsaWRhdG9ycy5tYXhTaXplKHRoaXMubWF4U2l6ZSldLFxuICAgICAgICBbXG4gICAgICAgICAgKGNvbnRyb2wpID0+XG4gICAgICAgICAgICB0aGlzLnNlcGFyYXRvciAhPT0gdW5kZWZpbmVkXG4gICAgICAgICAgICAgID8gdGhpcy5pbXBvcnRDc3ZTZXJ2aWNlLnZhbGlkYXRlRmlsZShjb250cm9sLnZhbHVlWzBdLCB7XG4gICAgICAgICAgICAgICAgICBzZXBhcmF0b3I6IHRoaXMuc2VwYXJhdG9yLFxuICAgICAgICAgICAgICAgICAgaXNEYXRhUGFyc2FibGU6XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuaW1wb3J0VG9DYXJ0U2VydmljZS5pc0RhdGFQYXJzYWJsZVRvUHJvZHVjdHMsXG4gICAgICAgICAgICAgICAgICBtYXhFbnRyaWVzOiB0aGlzLm1heEVudHJpZXMsXG4gICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgOiBvZihudWxsKSxcbiAgICAgICAgXVxuICAgICAgKVxuICAgICk7XG4gICAgcmV0dXJuIGZvcm07XG4gIH1cblxuICBwdWJsaWMgZ2V0IGFsbG93ZWRUeXBlcygpOiBzdHJpbmdbXSB8IHVuZGVmaW5lZCB7XG4gICAgcmV0dXJuIHRoaXMuaW1wb3J0RXhwb3J0Q29uZmlnLmNhcnRJbXBvcnRFeHBvcnQ/LmltcG9ydD8uZmlsZVZhbGlkaXR5XG4gICAgICA/LmFsbG93ZWRUeXBlcztcbiAgfVxuXG4gIHByb3RlY3RlZCBnZXQgbWF4U2l6ZSgpOiBudW1iZXIgfCB1bmRlZmluZWQge1xuICAgIHJldHVybiB0aGlzLmltcG9ydEV4cG9ydENvbmZpZy5jYXJ0SW1wb3J0RXhwb3J0Py5pbXBvcnQ/LmZpbGVWYWxpZGl0eVxuICAgICAgPy5tYXhTaXplO1xuICB9XG5cbiAgcHJvdGVjdGVkIGdldCBtYXhFbnRyaWVzKCk6IG51bWJlciB8IHVuZGVmaW5lZCB7XG4gICAgcmV0dXJuIHRoaXMuaW1wb3J0RXhwb3J0Q29uZmlnLmNhcnRJbXBvcnRFeHBvcnQ/LmltcG9ydD8uZmlsZVZhbGlkaXR5XG4gICAgICA/Lm1heEVudHJpZXM/Llt0aGlzLnR5cGVdO1xuICB9XG5cbiAgcHJvdGVjdGVkIGdldCBzZXBhcmF0b3IoKTogc3RyaW5nIHwgdW5kZWZpbmVkIHtcbiAgICByZXR1cm4gdGhpcy5pbXBvcnRFeHBvcnRDb25maWcuY2FydEltcG9ydEV4cG9ydD8uZmlsZS5zZXBhcmF0b3I7XG4gIH1cbn1cbiIsIjxmb3JtICpuZ0lmPVwiZm9ybVwiIFtmb3JtR3JvdXBdPVwiZm9ybVwiIChzdWJtaXQpPVwiZm9ybVN1Ym1pdFN1YmplY3QkLm5leHQoKVwiPlxuICA8cCBjbGFzcz1cImN4LWltcG9ydC1lbnRyaWVzLXN1YnRpdGxlXCI+XG4gICAge3sgJ2ltcG9ydEVudHJpZXNEaWFsb2cuaW1wb3J0UHJvZHVjdHNTdWJ0aXRsZScgfCBjeFRyYW5zbGF0ZSB9fVxuICA8L3A+XG4gIDxwPlxuICAgIHt7ICdpbXBvcnRFbnRyaWVzRGlhbG9nLmltcG9ydFByb2R1Y3RGaWxlRGV0YWlscycgfCBjeFRyYW5zbGF0ZSB9fVxuICA8L3A+XG4gIDxsYWJlbD5cbiAgICA8Y3gtZmlsZS11cGxvYWQgW2Zvcm1Db250cm9sXT1cImZvcm0uZ2V0KCdmaWxlJylcIiBbYWNjZXB0XT1cImFsbG93ZWRUeXBlc1wiPlxuICAgICAge3sgJ2ltcG9ydEVudHJpZXNEaWFsb2cuc2VsZWN0RmlsZScgfCBjeFRyYW5zbGF0ZSB9fVxuICAgIDwvY3gtZmlsZS11cGxvYWQ+XG4gICAgPGN4LWZvcm0tZXJyb3JzXG4gICAgICBbY29udHJvbF09XCJmb3JtLmdldCgnZmlsZScpXCJcbiAgICAgIHByZWZpeD1cImZvcm1FcnJvcnMuZmlsZVwiXG4gICAgPjwvY3gtZm9ybS1lcnJvcnM+XG4gIDwvbGFiZWw+XG4gIDxkaXYgY2xhc3M9XCJjeC1pbXBvcnQtZW50cmllcy1mb290ZXJcIj5cbiAgICA8YnV0dG9uXG4gICAgICAoY2xpY2spPVwiY2xvc2UoJ0Nsb3NlIEltcG9ydCBQcm9kdWN0cyBEaWFsb2cnKVwiXG4gICAgICBjbGFzcz1cImJ0biBidG4tYWN0aW9uXCJcbiAgICAgIHR5cGU9XCJidXR0b25cIlxuICAgID5cbiAgICAgIHt7ICdpbXBvcnRFbnRyaWVzRGlhbG9nLmNhbmNlbCcgfCBjeFRyYW5zbGF0ZSB9fVxuICAgIDwvYnV0dG9uPlxuICAgIDxidXR0b25cbiAgICAgIGNsYXNzPVwiYnRuIGJ0bi1wcmltYXJ5XCJcbiAgICAgIHR5cGU9XCJzdWJtaXRcIlxuICAgICAgW2Rpc2FibGVkXT1cImZvcm0uZ2V0KCdmaWxlJyk/LnN0YXR1cyA9PT0gJ1BFTkRJTkcnXCJcbiAgICA+XG4gICAgICB7eyAnaW1wb3J0RW50cmllc0RpYWxvZy51cGxvYWQnIHwgY3hUcmFuc2xhdGUgfX1cbiAgICA8L2J1dHRvbj5cbiAgPC9kaXY+XG48L2Zvcm0+XG4iXX0=