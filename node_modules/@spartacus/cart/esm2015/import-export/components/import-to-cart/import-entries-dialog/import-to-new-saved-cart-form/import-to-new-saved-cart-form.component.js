import { ChangeDetectionStrategy, Component, EventEmitter, Output, } from '@angular/core';
import { FormControl, FormGroup, Validators, } from '@angular/forms';
import { CartNameSource, } from '@spartacus/cart/import-export/core';
import { CxDatePipe } from '@spartacus/core';
import { of } from 'rxjs';
import { ImportEntriesFormComponent } from '../import-entries-form/import-entries-form.component';
import * as i0 from "@angular/core";
import * as i1 from "@spartacus/storefront";
import * as i2 from "../../import-products-from-csv.service";
import * as i3 from "@spartacus/cart/import-export/core";
import * as i4 from "@spartacus/core";
import * as i5 from "@angular/common";
import * as i6 from "@angular/forms";
export class ImportToNewSavedCartFormComponent extends ImportEntriesFormComponent {
    constructor(launchDialogService, importToCartService, importCsvService, filesFormValidators, importExportConfig, datePipe) {
        super(launchDialogService, importToCartService, importCsvService, filesFormValidators, importExportConfig);
        this.launchDialogService = launchDialogService;
        this.importToCartService = importToCartService;
        this.importCsvService = importCsvService;
        this.filesFormValidators = filesFormValidators;
        this.importExportConfig = importExportConfig;
        this.datePipe = datePipe;
        this.descriptionMaxLength = 250;
        this.nameMaxLength = 50;
        this.submitEvent = new EventEmitter();
    }
    get descriptionsCharacterLeft() {
        var _a, _b;
        return (this.descriptionMaxLength -
            (((_b = (_a = this.form.get('description')) === null || _a === void 0 ? void 0 : _a.value) === null || _b === void 0 ? void 0 : _b.length) || 0));
    }
    save() {
        var _a, _b;
        const file = (_b = (_a = this.form.get('file')) === null || _a === void 0 ? void 0 : _a.value) === null || _b === void 0 ? void 0 : _b[0];
        if (this.separator !== undefined) {
            this.importCsvService
                .loadFile(file, this.separator)
                .subscribe((loadedFile) => {
                var _a, _b;
                this.submitEvent.emit({
                    products: this.importToCartService.csvDataToProduct(loadedFile),
                    savedCartInfo: {
                        name: (_a = this.form.get('name')) === null || _a === void 0 ? void 0 : _a.value,
                        description: (_b = this.form.get('description')) === null || _b === void 0 ? void 0 : _b.value,
                    },
                });
            });
        }
    }
    buildForm() {
        const form = new FormGroup({});
        form.setControl('file', new FormControl('', [Validators.required, this.filesFormValidators.maxSize(this.maxSize)], [
            (control) => this.separator !== undefined
                ? this.importCsvService.validateFile(control.value[0], {
                    separator: this.separator,
                    isDataParsable: this.importToCartService.isDataParsableToProducts,
                    maxEntries: this.maxEntries,
                })
                : of(null),
        ]));
        form.setControl('name', new FormControl('', [
            Validators.required,
            Validators.maxLength(this.nameMaxLength),
        ]));
        form.setControl('description', new FormControl('', [Validators.maxLength(this.descriptionMaxLength)]));
        return form;
    }
    updateCartName() {
        var _a;
        const nameField = this.form.get('name');
        if (nameField && !(nameField === null || nameField === void 0 ? void 0 : nameField.value) && ((_a = this.cartNameGeneration) === null || _a === void 0 ? void 0 : _a.source)) {
            switch (this.cartNameGeneration.source) {
                case CartNameSource.FILE_NAME: {
                    this.setFieldValueByFileName(nameField);
                    break;
                }
                case CartNameSource.DATE_TIME: {
                    this.setFieldValueByDatetime(nameField);
                    break;
                }
                default: {
                    break;
                }
            }
        }
    }
    setFieldValueByFileName(nameField) {
        var _a, _b, _c, _d;
        const fileName = (_d = (_c = (_b = (_a = this.form
            .get('file')) === null || _a === void 0 ? void 0 : _a.value) === null || _b === void 0 ? void 0 : _b[0]) === null || _c === void 0 ? void 0 : _c.name) === null || _d === void 0 ? void 0 : _d.replace(/\.[^/.]+$/, '');
        nameField.setValue(fileName);
    }
    setFieldValueByDatetime(nameField) {
        var _a, _b, _c;
        const date = new Date();
        const fromDateOptions = (_a = this.cartNameGeneration) === null || _a === void 0 ? void 0 : _a.fromDateOptions;
        const mask = fromDateOptions === null || fromDateOptions === void 0 ? void 0 : fromDateOptions.mask;
        const prefix = (_b = fromDateOptions === null || fromDateOptions === void 0 ? void 0 : fromDateOptions.prefix) !== null && _b !== void 0 ? _b : '';
        const suffix = (_c = fromDateOptions === null || fromDateOptions === void 0 ? void 0 : fromDateOptions.suffix) !== null && _c !== void 0 ? _c : '';
        const dateString = mask
            ? this.datePipe.transform(date, mask)
            : this.datePipe.transform(date);
        nameField.setValue(`${prefix}${dateString}${suffix}`);
    }
    get cartNameGeneration() {
        var _a, _b;
        return (_b = (_a = this.importExportConfig.cartImportExport) === null || _a === void 0 ? void 0 : _a.import) === null || _b === void 0 ? void 0 : _b.cartNameGeneration;
    }
}
ImportToNewSavedCartFormComponent.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "12.0.5", ngImport: i0, type: ImportToNewSavedCartFormComponent, deps: [{ token: i1.LaunchDialogService }, { token: i2.ImportProductsFromCsvService }, { token: i1.ImportCsvFileService }, { token: i1.FilesFormValidators }, { token: i3.ImportExportConfig }, { token: i4.CxDatePipe }], target: i0.ɵɵFactoryTarget.Component });
ImportToNewSavedCartFormComponent.ɵcmp = i0.ɵɵngDeclareComponent({ minVersion: "12.0.0", version: "12.0.5", type: ImportToNewSavedCartFormComponent, selector: "cx-import-to-new-saved-cart-form", outputs: { submitEvent: "submitEvent" }, providers: [CxDatePipe], usesInheritance: true, ngImport: i0, template: "<form *ngIf=\"form\" [formGroup]=\"form\" (submit)=\"formSubmitSubject$.next()\">\n  <p class=\"cx-import-entries-subtitle\">\n    {{ 'importEntriesDialog.importProductsNewSavedCartSubtitle' | cxTranslate }}\n  </p>\n  <p>\n    {{ 'importEntriesDialog.importProductFileDetails' | cxTranslate }}\n  </p>\n  <label>\n    <cx-file-upload\n      [formControl]=\"form.get('file')\"\n      (update)=\"updateCartName()\"\n      [accept]=\"allowedTypes\"\n    >\n      {{ 'importEntriesDialog.selectFile' | cxTranslate }}\n    </cx-file-upload>\n    <cx-form-errors\n      [control]=\"form.get('file')\"\n      prefix=\"formErrors.file\"\n    ></cx-form-errors>\n  </label>\n  <div class=\"cx-import-entries-row\">\n    <label>\n      <span class=\"cx-import-entries-label label-content\">\n        {{ 'importEntriesDialog.savedCartName' | cxTranslate }}\n      </span>\n      <input\n        [maxLength]=\"nameMaxLength\"\n        class=\"form-control\"\n        formControlName=\"name\"\n        required\n        type=\"text\"\n      />\n      <cx-form-errors [control]=\"form.get('name')\"></cx-form-errors>\n    </label>\n  </div>\n\n  <div class=\"cx-import-entries-row\">\n    <label>\n      <span class=\"cx-import-entries-label label-content\">\n        {{ 'importEntriesDialog.savedCartDescription' | cxTranslate }}\n        <span class=\"cx-import-entries-label-optional\">\n          ({{ 'importEntriesDialog.optional' | cxTranslate }})\n        </span></span\n      >\n      <textarea\n        [maxLength]=\"descriptionMaxLength\"\n        class=\"form-control\"\n        formControlName=\"description\"\n        rows=\"5\"\n      ></textarea>\n      <cx-form-errors [control]=\"form.get('description')\"></cx-form-errors>\n\n      <p class=\"cx-import-entries-input-hint\">\n        {{\n          'importEntriesDialog.charactersLeft'\n            | cxTranslate: { count: descriptionsCharacterLeft }\n        }}\n      </p>\n    </label>\n  </div>\n  <div class=\"cx-import-entries-footer\">\n    <button\n      (click)=\"close('Close Import Products Dialog')\"\n      class=\"btn btn-action\"\n      type=\"button\"\n    >\n      {{ 'importEntriesDialog.cancel' | cxTranslate }}\n    </button>\n    <button\n      class=\"btn btn-primary\"\n      type=\"submit\"\n      [disabled]=\"form.get('file')?.status === 'PENDING'\"\n    >\n      {{ 'importEntriesDialog.upload' | cxTranslate }}\n    </button>\n  </div>\n</form>\n", components: [{ type: i1.FileUploadComponent, selector: "cx-file-upload", inputs: ["accept", "multiple"], outputs: ["update"] }, { type: i1.FormErrorsComponent, selector: "cx-form-errors", inputs: ["prefix", "translationParams", "control"] }], directives: [{ type: i5.NgIf, selector: "[ngIf]", inputs: ["ngIf", "ngIfThen", "ngIfElse"] }, { type: i6.ɵNgNoValidate, selector: "form:not([ngNoForm]):not([ngNativeValidate])" }, { type: i6.NgControlStatusGroup, selector: "[formGroupName],[formArrayName],[ngModelGroup],[formGroup],form:not([ngNoForm]),[ngForm]" }, { type: i6.FormGroupDirective, selector: "[formGroup]", inputs: ["formGroup"], outputs: ["ngSubmit"], exportAs: ["ngForm"] }, { type: i6.NgControlStatus, selector: "[formControlName],[ngModel],[formControl]" }, { type: i6.FormControlDirective, selector: "[formControl]", inputs: ["disabled", "formControl", "ngModel"], outputs: ["ngModelChange"], exportAs: ["ngForm"] }, { type: i6.DefaultValueAccessor, selector: "input:not([type=checkbox])[formControlName],textarea[formControlName],input:not([type=checkbox])[formControl],textarea[formControl],input:not([type=checkbox])[ngModel],textarea[ngModel],[ngDefaultControl]" }, { type: i6.FormControlName, selector: "[formControlName]", inputs: ["disabled", "formControlName", "ngModel"], outputs: ["ngModelChange"] }, { type: i6.RequiredValidator, selector: ":not([type=checkbox])[required][formControlName],:not([type=checkbox])[required][formControl],:not([type=checkbox])[required][ngModel]", inputs: ["required"] }], pipes: { "cxTranslate": i4.TranslatePipe }, changeDetection: i0.ChangeDetectionStrategy.OnPush });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "12.0.5", ngImport: i0, type: ImportToNewSavedCartFormComponent, decorators: [{
            type: Component,
            args: [{
                    selector: 'cx-import-to-new-saved-cart-form',
                    templateUrl: './import-to-new-saved-cart-form.component.html',
                    changeDetection: ChangeDetectionStrategy.OnPush,
                    providers: [CxDatePipe],
                }]
        }], ctorParameters: function () { return [{ type: i1.LaunchDialogService }, { type: i2.ImportProductsFromCsvService }, { type: i1.ImportCsvFileService }, { type: i1.FilesFormValidators }, { type: i3.ImportExportConfig }, { type: i4.CxDatePipe }]; }, propDecorators: { submitEvent: [{
                type: Output
            }] } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW1wb3J0LXRvLW5ldy1zYXZlZC1jYXJ0LWZvcm0uY29tcG9uZW50LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vLi4vLi4vZmVhdHVyZS1saWJzL2NhcnQvaW1wb3J0LWV4cG9ydC9jb21wb25lbnRzL2ltcG9ydC10by1jYXJ0L2ltcG9ydC1lbnRyaWVzLWRpYWxvZy9pbXBvcnQtdG8tbmV3LXNhdmVkLWNhcnQtZm9ybS9pbXBvcnQtdG8tbmV3LXNhdmVkLWNhcnQtZm9ybS5jb21wb25lbnQudHMiLCIuLi8uLi8uLi8uLi8uLi8uLi8uLi8uLi9mZWF0dXJlLWxpYnMvY2FydC9pbXBvcnQtZXhwb3J0L2NvbXBvbmVudHMvaW1wb3J0LXRvLWNhcnQvaW1wb3J0LWVudHJpZXMtZGlhbG9nL2ltcG9ydC10by1uZXctc2F2ZWQtY2FydC1mb3JtL2ltcG9ydC10by1uZXctc2F2ZWQtY2FydC1mb3JtLmNvbXBvbmVudC5odG1sIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFDTCx1QkFBdUIsRUFDdkIsU0FBUyxFQUNULFlBQVksRUFDWixNQUFNLEdBQ1AsTUFBTSxlQUFlLENBQUM7QUFDdkIsT0FBTyxFQUVMLFdBQVcsRUFDWCxTQUFTLEVBQ1QsVUFBVSxHQUNYLE1BQU0sZ0JBQWdCLENBQUM7QUFDeEIsT0FBTyxFQUVMLGNBQWMsR0FFZixNQUFNLG9DQUFvQyxDQUFDO0FBQzVDLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQU83QyxPQUFPLEVBQUUsRUFBRSxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBRTFCLE9BQU8sRUFBRSwwQkFBMEIsRUFBRSxNQUFNLHNEQUFzRCxDQUFDOzs7Ozs7OztBQVFsRyxNQUFNLE9BQU8saUNBQWtDLFNBQVEsMEJBQTBCO0lBb0IvRSxZQUNZLG1CQUF3QyxFQUN4QyxtQkFBaUQsRUFDakQsZ0JBQXNDLEVBQ3RDLG1CQUF3QyxFQUN4QyxrQkFBc0MsRUFDdEMsUUFBb0I7UUFFOUIsS0FBSyxDQUNILG1CQUFtQixFQUNuQixtQkFBbUIsRUFDbkIsZ0JBQWdCLEVBQ2hCLG1CQUFtQixFQUNuQixrQkFBa0IsQ0FDbkIsQ0FBQztRQWJRLHdCQUFtQixHQUFuQixtQkFBbUIsQ0FBcUI7UUFDeEMsd0JBQW1CLEdBQW5CLG1CQUFtQixDQUE4QjtRQUNqRCxxQkFBZ0IsR0FBaEIsZ0JBQWdCLENBQXNCO1FBQ3RDLHdCQUFtQixHQUFuQixtQkFBbUIsQ0FBcUI7UUFDeEMsdUJBQWtCLEdBQWxCLGtCQUFrQixDQUFvQjtRQUN0QyxhQUFRLEdBQVIsUUFBUSxDQUFZO1FBekJoQyx5QkFBb0IsR0FBVyxHQUFHLENBQUM7UUFDbkMsa0JBQWEsR0FBVyxFQUFFLENBQUM7UUFHM0IsZ0JBQVcsR0FBRyxJQUFJLFlBQVksRUFNMUIsQ0FBQztJQXdCTCxDQUFDO0lBdEJELElBQUkseUJBQXlCOztRQUMzQixPQUFPLENBQ0wsSUFBSSxDQUFDLG9CQUFvQjtZQUN6QixDQUFDLENBQUEsTUFBQSxNQUFBLElBQUksQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLGFBQWEsQ0FBQywwQ0FBRSxLQUFLLDBDQUFFLE1BQU0sS0FBSSxDQUFDLENBQUMsQ0FDbkQsQ0FBQztJQUNKLENBQUM7SUFtQkQsSUFBSTs7UUFDRixNQUFNLElBQUksR0FBUyxNQUFBLE1BQUEsSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsTUFBTSxDQUFDLDBDQUFFLEtBQUssMENBQUcsQ0FBQyxDQUFDLENBQUM7UUFDckQsSUFBSSxJQUFJLENBQUMsU0FBUyxLQUFLLFNBQVMsRUFBRTtZQUNoQyxJQUFJLENBQUMsZ0JBQWdCO2lCQUNsQixRQUFRLENBQUMsSUFBSSxFQUFFLElBQUksQ0FBQyxTQUFTLENBQUM7aUJBQzlCLFNBQVMsQ0FBQyxDQUFDLFVBQXNCLEVBQUUsRUFBRTs7Z0JBQ3BDLElBQUksQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDO29CQUNwQixRQUFRLEVBQUUsSUFBSSxDQUFDLG1CQUFtQixDQUFDLGdCQUFnQixDQUFDLFVBQVUsQ0FBQztvQkFDL0QsYUFBYSxFQUFFO3dCQUNiLElBQUksRUFBRSxNQUFBLElBQUksQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQywwQ0FBRSxLQUFLO3dCQUNsQyxXQUFXLEVBQUUsTUFBQSxJQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxhQUFhLENBQUMsMENBQUUsS0FBSztxQkFDakQ7aUJBQ0YsQ0FBQyxDQUFDO1lBQ0wsQ0FBQyxDQUFDLENBQUM7U0FDTjtJQUNILENBQUM7SUFFUyxTQUFTO1FBQ2pCLE1BQU0sSUFBSSxHQUFHLElBQUksU0FBUyxDQUFDLEVBQUUsQ0FBQyxDQUFDO1FBQy9CLElBQUksQ0FBQyxVQUFVLENBQ2IsTUFBTSxFQUNOLElBQUksV0FBVyxDQUNiLEVBQUUsRUFDRixDQUFDLFVBQVUsQ0FBQyxRQUFRLEVBQUUsSUFBSSxDQUFDLG1CQUFtQixDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUMsRUFDckU7WUFDRSxDQUFDLE9BQU8sRUFBRSxFQUFFLENBQ1YsSUFBSSxDQUFDLFNBQVMsS0FBSyxTQUFTO2dCQUMxQixDQUFDLENBQUMsSUFBSSxDQUFDLGdCQUFnQixDQUFDLFlBQVksQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxFQUFFO29CQUNuRCxTQUFTLEVBQUUsSUFBSSxDQUFDLFNBQVM7b0JBQ3pCLGNBQWMsRUFDWixJQUFJLENBQUMsbUJBQW1CLENBQUMsd0JBQXdCO29CQUNuRCxVQUFVLEVBQUUsSUFBSSxDQUFDLFVBQVU7aUJBQzVCLENBQUM7Z0JBQ0osQ0FBQyxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUM7U0FDZixDQUNGLENBQ0YsQ0FBQztRQUNGLElBQUksQ0FBQyxVQUFVLENBQ2IsTUFBTSxFQUNOLElBQUksV0FBVyxDQUFDLEVBQUUsRUFBRTtZQUNsQixVQUFVLENBQUMsUUFBUTtZQUNuQixVQUFVLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxhQUFhLENBQUM7U0FDekMsQ0FBQyxDQUNILENBQUM7UUFDRixJQUFJLENBQUMsVUFBVSxDQUNiLGFBQWEsRUFDYixJQUFJLFdBQVcsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxVQUFVLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxvQkFBb0IsQ0FBQyxDQUFDLENBQUMsQ0FDdkUsQ0FBQztRQUNGLE9BQU8sSUFBSSxDQUFDO0lBQ2QsQ0FBQztJQUVELGNBQWM7O1FBQ1osTUFBTSxTQUFTLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsTUFBTSxDQUFDLENBQUM7UUFDeEMsSUFBSSxTQUFTLElBQUksQ0FBQyxDQUFBLFNBQVMsYUFBVCxTQUFTLHVCQUFULFNBQVMsQ0FBRSxLQUFLLENBQUEsS0FBSSxNQUFBLElBQUksQ0FBQyxrQkFBa0IsMENBQUUsTUFBTSxDQUFBLEVBQUU7WUFDckUsUUFBUSxJQUFJLENBQUMsa0JBQWtCLENBQUMsTUFBTSxFQUFFO2dCQUN0QyxLQUFLLGNBQWMsQ0FBQyxTQUFTLENBQUMsQ0FBQztvQkFDN0IsSUFBSSxDQUFDLHVCQUF1QixDQUFDLFNBQVMsQ0FBQyxDQUFDO29CQUN4QyxNQUFNO2lCQUNQO2dCQUNELEtBQUssY0FBYyxDQUFDLFNBQVMsQ0FBQyxDQUFDO29CQUM3QixJQUFJLENBQUMsdUJBQXVCLENBQUMsU0FBUyxDQUFDLENBQUM7b0JBQ3hDLE1BQU07aUJBQ1A7Z0JBQ0QsT0FBTyxDQUFDLENBQUM7b0JBQ1AsTUFBTTtpQkFDUDthQUNGO1NBQ0Y7SUFDSCxDQUFDO0lBRVMsdUJBQXVCLENBQUMsU0FBMEI7O1FBQzFELE1BQU0sUUFBUSxHQUFHLE1BQUEsTUFBQSxNQUFBLE1BQUEsSUFBSSxDQUFDLElBQUk7YUFDdkIsR0FBRyxDQUFDLE1BQU0sQ0FBQywwQ0FDVixLQUFLLDBDQUFHLENBQUMsQ0FBQywwQ0FBRSxJQUFJLDBDQUFFLE9BQU8sQ0FBQyxXQUFXLEVBQUUsRUFBRSxDQUFDLENBQUM7UUFDL0MsU0FBUyxDQUFDLFFBQVEsQ0FBQyxRQUFRLENBQUMsQ0FBQztJQUMvQixDQUFDO0lBRVMsdUJBQXVCLENBQUMsU0FBMEI7O1FBQzFELE1BQU0sSUFBSSxHQUFHLElBQUksSUFBSSxFQUFFLENBQUM7UUFDeEIsTUFBTSxlQUFlLEdBQUcsTUFBQSxJQUFJLENBQUMsa0JBQWtCLDBDQUFFLGVBQWUsQ0FBQztRQUNqRSxNQUFNLElBQUksR0FBRyxlQUFlLGFBQWYsZUFBZSx1QkFBZixlQUFlLENBQUUsSUFBSSxDQUFDO1FBQ25DLE1BQU0sTUFBTSxHQUFHLE1BQUEsZUFBZSxhQUFmLGVBQWUsdUJBQWYsZUFBZSxDQUFFLE1BQU0sbUNBQUksRUFBRSxDQUFDO1FBQzdDLE1BQU0sTUFBTSxHQUFHLE1BQUEsZUFBZSxhQUFmLGVBQWUsdUJBQWYsZUFBZSxDQUFFLE1BQU0sbUNBQUksRUFBRSxDQUFDO1FBQzdDLE1BQU0sVUFBVSxHQUFHLElBQUk7WUFDckIsQ0FBQyxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsU0FBUyxDQUFDLElBQUksRUFBRSxJQUFJLENBQUM7WUFDckMsQ0FBQyxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQ2xDLFNBQVMsQ0FBQyxRQUFRLENBQUMsR0FBRyxNQUFNLEdBQUcsVUFBVSxHQUFHLE1BQU0sRUFBRSxDQUFDLENBQUM7SUFDeEQsQ0FBQztJQUVELElBQWMsa0JBQWtCOztRQUM5QixPQUFPLE1BQUEsTUFBQSxJQUFJLENBQUMsa0JBQWtCLENBQUMsZ0JBQWdCLDBDQUFFLE1BQU0sMENBQUUsa0JBQWtCLENBQUM7SUFDOUUsQ0FBQzs7OEhBaElVLGlDQUFpQztrSEFBakMsaUNBQWlDLG9HQUZqQyxDQUFDLFVBQVUsQ0FBQyxpRENoQ3pCLDgzRUE2RUE7MkZEM0NhLGlDQUFpQztrQkFON0MsU0FBUzttQkFBQztvQkFDVCxRQUFRLEVBQUUsa0NBQWtDO29CQUM1QyxXQUFXLEVBQUUsZ0RBQWdEO29CQUM3RCxlQUFlLEVBQUUsdUJBQXVCLENBQUMsTUFBTTtvQkFDL0MsU0FBUyxFQUFFLENBQUMsVUFBVSxDQUFDO2lCQUN4QjtvUkFNQyxXQUFXO3NCQURWLE1BQU0iLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICBDaGFuZ2VEZXRlY3Rpb25TdHJhdGVneSxcbiAgQ29tcG9uZW50LFxuICBFdmVudEVtaXR0ZXIsXG4gIE91dHB1dCxcbn0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQge1xuICBBYnN0cmFjdENvbnRyb2wsXG4gIEZvcm1Db250cm9sLFxuICBGb3JtR3JvdXAsXG4gIFZhbGlkYXRvcnMsXG59IGZyb20gJ0Bhbmd1bGFyL2Zvcm1zJztcbmltcG9ydCB7XG4gIENhcnROYW1lR2VuZXJhdGlvbixcbiAgQ2FydE5hbWVTb3VyY2UsXG4gIEltcG9ydEV4cG9ydENvbmZpZyxcbn0gZnJvbSAnQHNwYXJ0YWN1cy9jYXJ0L2ltcG9ydC1leHBvcnQvY29yZSc7XG5pbXBvcnQgeyBDeERhdGVQaXBlIH0gZnJvbSAnQHNwYXJ0YWN1cy9jb3JlJztcbmltcG9ydCB7XG4gIEZpbGVzRm9ybVZhbGlkYXRvcnMsXG4gIEltcG9ydENzdkZpbGVTZXJ2aWNlLFxuICBMYXVuY2hEaWFsb2dTZXJ2aWNlLFxuICBQcm9kdWN0RGF0YSxcbn0gZnJvbSAnQHNwYXJ0YWN1cy9zdG9yZWZyb250JztcbmltcG9ydCB7IG9mIH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBJbXBvcnRQcm9kdWN0c0Zyb21Dc3ZTZXJ2aWNlIH0gZnJvbSAnLi4vLi4vaW1wb3J0LXByb2R1Y3RzLWZyb20tY3N2LnNlcnZpY2UnO1xuaW1wb3J0IHsgSW1wb3J0RW50cmllc0Zvcm1Db21wb25lbnQgfSBmcm9tICcuLi9pbXBvcnQtZW50cmllcy1mb3JtL2ltcG9ydC1lbnRyaWVzLWZvcm0uY29tcG9uZW50JztcblxuQENvbXBvbmVudCh7XG4gIHNlbGVjdG9yOiAnY3gtaW1wb3J0LXRvLW5ldy1zYXZlZC1jYXJ0LWZvcm0nLFxuICB0ZW1wbGF0ZVVybDogJy4vaW1wb3J0LXRvLW5ldy1zYXZlZC1jYXJ0LWZvcm0uY29tcG9uZW50Lmh0bWwnLFxuICBjaGFuZ2VEZXRlY3Rpb246IENoYW5nZURldGVjdGlvblN0cmF0ZWd5Lk9uUHVzaCxcbiAgcHJvdmlkZXJzOiBbQ3hEYXRlUGlwZV0sXG59KVxuZXhwb3J0IGNsYXNzIEltcG9ydFRvTmV3U2F2ZWRDYXJ0Rm9ybUNvbXBvbmVudCBleHRlbmRzIEltcG9ydEVudHJpZXNGb3JtQ29tcG9uZW50IHtcbiAgZGVzY3JpcHRpb25NYXhMZW5ndGg6IG51bWJlciA9IDI1MDtcbiAgbmFtZU1heExlbmd0aDogbnVtYmVyID0gNTA7XG5cbiAgQE91dHB1dCgpXG4gIHN1Ym1pdEV2ZW50ID0gbmV3IEV2ZW50RW1pdHRlcjx7XG4gICAgcHJvZHVjdHM6IFByb2R1Y3REYXRhW107XG4gICAgc2F2ZWRDYXJ0SW5mbz86IHtcbiAgICAgIG5hbWU6IHN0cmluZztcbiAgICAgIGRlc2NyaXB0aW9uOiBzdHJpbmc7XG4gICAgfTtcbiAgfT4oKTtcblxuICBnZXQgZGVzY3JpcHRpb25zQ2hhcmFjdGVyTGVmdCgpOiBudW1iZXIge1xuICAgIHJldHVybiAoXG4gICAgICB0aGlzLmRlc2NyaXB0aW9uTWF4TGVuZ3RoIC1cbiAgICAgICh0aGlzLmZvcm0uZ2V0KCdkZXNjcmlwdGlvbicpPy52YWx1ZT8ubGVuZ3RoIHx8IDApXG4gICAgKTtcbiAgfVxuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHByb3RlY3RlZCBsYXVuY2hEaWFsb2dTZXJ2aWNlOiBMYXVuY2hEaWFsb2dTZXJ2aWNlLFxuICAgIHByb3RlY3RlZCBpbXBvcnRUb0NhcnRTZXJ2aWNlOiBJbXBvcnRQcm9kdWN0c0Zyb21Dc3ZTZXJ2aWNlLFxuICAgIHByb3RlY3RlZCBpbXBvcnRDc3ZTZXJ2aWNlOiBJbXBvcnRDc3ZGaWxlU2VydmljZSxcbiAgICBwcm90ZWN0ZWQgZmlsZXNGb3JtVmFsaWRhdG9yczogRmlsZXNGb3JtVmFsaWRhdG9ycyxcbiAgICBwcm90ZWN0ZWQgaW1wb3J0RXhwb3J0Q29uZmlnOiBJbXBvcnRFeHBvcnRDb25maWcsXG4gICAgcHJvdGVjdGVkIGRhdGVQaXBlOiBDeERhdGVQaXBlXG4gICkge1xuICAgIHN1cGVyKFxuICAgICAgbGF1bmNoRGlhbG9nU2VydmljZSxcbiAgICAgIGltcG9ydFRvQ2FydFNlcnZpY2UsXG4gICAgICBpbXBvcnRDc3ZTZXJ2aWNlLFxuICAgICAgZmlsZXNGb3JtVmFsaWRhdG9ycyxcbiAgICAgIGltcG9ydEV4cG9ydENvbmZpZ1xuICAgICk7XG4gIH1cblxuICBzYXZlKCk6IHZvaWQge1xuICAgIGNvbnN0IGZpbGU6IEZpbGUgPSB0aGlzLmZvcm0uZ2V0KCdmaWxlJyk/LnZhbHVlPy5bMF07XG4gICAgaWYgKHRoaXMuc2VwYXJhdG9yICE9PSB1bmRlZmluZWQpIHtcbiAgICAgIHRoaXMuaW1wb3J0Q3N2U2VydmljZVxuICAgICAgICAubG9hZEZpbGUoZmlsZSwgdGhpcy5zZXBhcmF0b3IpXG4gICAgICAgIC5zdWJzY3JpYmUoKGxvYWRlZEZpbGU6IHN0cmluZ1tdW10pID0+IHtcbiAgICAgICAgICB0aGlzLnN1Ym1pdEV2ZW50LmVtaXQoe1xuICAgICAgICAgICAgcHJvZHVjdHM6IHRoaXMuaW1wb3J0VG9DYXJ0U2VydmljZS5jc3ZEYXRhVG9Qcm9kdWN0KGxvYWRlZEZpbGUpLFxuICAgICAgICAgICAgc2F2ZWRDYXJ0SW5mbzoge1xuICAgICAgICAgICAgICBuYW1lOiB0aGlzLmZvcm0uZ2V0KCduYW1lJyk/LnZhbHVlLFxuICAgICAgICAgICAgICBkZXNjcmlwdGlvbjogdGhpcy5mb3JtLmdldCgnZGVzY3JpcHRpb24nKT8udmFsdWUsXG4gICAgICAgICAgICB9LFxuICAgICAgICAgIH0pO1xuICAgICAgICB9KTtcbiAgICB9XG4gIH1cblxuICBwcm90ZWN0ZWQgYnVpbGRGb3JtKCk6IEZvcm1Hcm91cCB7XG4gICAgY29uc3QgZm9ybSA9IG5ldyBGb3JtR3JvdXAoe30pO1xuICAgIGZvcm0uc2V0Q29udHJvbChcbiAgICAgICdmaWxlJyxcbiAgICAgIG5ldyBGb3JtQ29udHJvbChcbiAgICAgICAgJycsXG4gICAgICAgIFtWYWxpZGF0b3JzLnJlcXVpcmVkLCB0aGlzLmZpbGVzRm9ybVZhbGlkYXRvcnMubWF4U2l6ZSh0aGlzLm1heFNpemUpXSxcbiAgICAgICAgW1xuICAgICAgICAgIChjb250cm9sKSA9PlxuICAgICAgICAgICAgdGhpcy5zZXBhcmF0b3IgIT09IHVuZGVmaW5lZFxuICAgICAgICAgICAgICA/IHRoaXMuaW1wb3J0Q3N2U2VydmljZS52YWxpZGF0ZUZpbGUoY29udHJvbC52YWx1ZVswXSwge1xuICAgICAgICAgICAgICAgICAgc2VwYXJhdG9yOiB0aGlzLnNlcGFyYXRvcixcbiAgICAgICAgICAgICAgICAgIGlzRGF0YVBhcnNhYmxlOlxuICAgICAgICAgICAgICAgICAgICB0aGlzLmltcG9ydFRvQ2FydFNlcnZpY2UuaXNEYXRhUGFyc2FibGVUb1Byb2R1Y3RzLFxuICAgICAgICAgICAgICAgICAgbWF4RW50cmllczogdGhpcy5tYXhFbnRyaWVzLFxuICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgIDogb2YobnVsbCksXG4gICAgICAgIF1cbiAgICAgIClcbiAgICApO1xuICAgIGZvcm0uc2V0Q29udHJvbChcbiAgICAgICduYW1lJyxcbiAgICAgIG5ldyBGb3JtQ29udHJvbCgnJywgW1xuICAgICAgICBWYWxpZGF0b3JzLnJlcXVpcmVkLFxuICAgICAgICBWYWxpZGF0b3JzLm1heExlbmd0aCh0aGlzLm5hbWVNYXhMZW5ndGgpLFxuICAgICAgXSlcbiAgICApO1xuICAgIGZvcm0uc2V0Q29udHJvbChcbiAgICAgICdkZXNjcmlwdGlvbicsXG4gICAgICBuZXcgRm9ybUNvbnRyb2woJycsIFtWYWxpZGF0b3JzLm1heExlbmd0aCh0aGlzLmRlc2NyaXB0aW9uTWF4TGVuZ3RoKV0pXG4gICAgKTtcbiAgICByZXR1cm4gZm9ybTtcbiAgfVxuXG4gIHVwZGF0ZUNhcnROYW1lKCk6IHZvaWQge1xuICAgIGNvbnN0IG5hbWVGaWVsZCA9IHRoaXMuZm9ybS5nZXQoJ25hbWUnKTtcbiAgICBpZiAobmFtZUZpZWxkICYmICFuYW1lRmllbGQ/LnZhbHVlICYmIHRoaXMuY2FydE5hbWVHZW5lcmF0aW9uPy5zb3VyY2UpIHtcbiAgICAgIHN3aXRjaCAodGhpcy5jYXJ0TmFtZUdlbmVyYXRpb24uc291cmNlKSB7XG4gICAgICAgIGNhc2UgQ2FydE5hbWVTb3VyY2UuRklMRV9OQU1FOiB7XG4gICAgICAgICAgdGhpcy5zZXRGaWVsZFZhbHVlQnlGaWxlTmFtZShuYW1lRmllbGQpO1xuICAgICAgICAgIGJyZWFrO1xuICAgICAgICB9XG4gICAgICAgIGNhc2UgQ2FydE5hbWVTb3VyY2UuREFURV9USU1FOiB7XG4gICAgICAgICAgdGhpcy5zZXRGaWVsZFZhbHVlQnlEYXRldGltZShuYW1lRmllbGQpO1xuICAgICAgICAgIGJyZWFrO1xuICAgICAgICB9XG4gICAgICAgIGRlZmF1bHQ6IHtcbiAgICAgICAgICBicmVhaztcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIHByb3RlY3RlZCBzZXRGaWVsZFZhbHVlQnlGaWxlTmFtZShuYW1lRmllbGQ6IEFic3RyYWN0Q29udHJvbCk6IHZvaWQge1xuICAgIGNvbnN0IGZpbGVOYW1lID0gdGhpcy5mb3JtXG4gICAgICAuZ2V0KCdmaWxlJylcbiAgICAgID8udmFsdWU/LlswXT8ubmFtZT8ucmVwbGFjZSgvXFwuW14vLl0rJC8sICcnKTtcbiAgICBuYW1lRmllbGQuc2V0VmFsdWUoZmlsZU5hbWUpO1xuICB9XG5cbiAgcHJvdGVjdGVkIHNldEZpZWxkVmFsdWVCeURhdGV0aW1lKG5hbWVGaWVsZDogQWJzdHJhY3RDb250cm9sKTogdm9pZCB7XG4gICAgY29uc3QgZGF0ZSA9IG5ldyBEYXRlKCk7XG4gICAgY29uc3QgZnJvbURhdGVPcHRpb25zID0gdGhpcy5jYXJ0TmFtZUdlbmVyYXRpb24/LmZyb21EYXRlT3B0aW9ucztcbiAgICBjb25zdCBtYXNrID0gZnJvbURhdGVPcHRpb25zPy5tYXNrO1xuICAgIGNvbnN0IHByZWZpeCA9IGZyb21EYXRlT3B0aW9ucz8ucHJlZml4ID8/ICcnO1xuICAgIGNvbnN0IHN1ZmZpeCA9IGZyb21EYXRlT3B0aW9ucz8uc3VmZml4ID8/ICcnO1xuICAgIGNvbnN0IGRhdGVTdHJpbmcgPSBtYXNrXG4gICAgICA/IHRoaXMuZGF0ZVBpcGUudHJhbnNmb3JtKGRhdGUsIG1hc2spXG4gICAgICA6IHRoaXMuZGF0ZVBpcGUudHJhbnNmb3JtKGRhdGUpO1xuICAgIG5hbWVGaWVsZC5zZXRWYWx1ZShgJHtwcmVmaXh9JHtkYXRlU3RyaW5nfSR7c3VmZml4fWApO1xuICB9XG5cbiAgcHJvdGVjdGVkIGdldCBjYXJ0TmFtZUdlbmVyYXRpb24oKTogQ2FydE5hbWVHZW5lcmF0aW9uIHwgdW5kZWZpbmVkIHtcbiAgICByZXR1cm4gdGhpcy5pbXBvcnRFeHBvcnRDb25maWcuY2FydEltcG9ydEV4cG9ydD8uaW1wb3J0Py5jYXJ0TmFtZUdlbmVyYXRpb247XG4gIH1cbn1cbiIsIjxmb3JtICpuZ0lmPVwiZm9ybVwiIFtmb3JtR3JvdXBdPVwiZm9ybVwiIChzdWJtaXQpPVwiZm9ybVN1Ym1pdFN1YmplY3QkLm5leHQoKVwiPlxuICA8cCBjbGFzcz1cImN4LWltcG9ydC1lbnRyaWVzLXN1YnRpdGxlXCI+XG4gICAge3sgJ2ltcG9ydEVudHJpZXNEaWFsb2cuaW1wb3J0UHJvZHVjdHNOZXdTYXZlZENhcnRTdWJ0aXRsZScgfCBjeFRyYW5zbGF0ZSB9fVxuICA8L3A+XG4gIDxwPlxuICAgIHt7ICdpbXBvcnRFbnRyaWVzRGlhbG9nLmltcG9ydFByb2R1Y3RGaWxlRGV0YWlscycgfCBjeFRyYW5zbGF0ZSB9fVxuICA8L3A+XG4gIDxsYWJlbD5cbiAgICA8Y3gtZmlsZS11cGxvYWRcbiAgICAgIFtmb3JtQ29udHJvbF09XCJmb3JtLmdldCgnZmlsZScpXCJcbiAgICAgICh1cGRhdGUpPVwidXBkYXRlQ2FydE5hbWUoKVwiXG4gICAgICBbYWNjZXB0XT1cImFsbG93ZWRUeXBlc1wiXG4gICAgPlxuICAgICAge3sgJ2ltcG9ydEVudHJpZXNEaWFsb2cuc2VsZWN0RmlsZScgfCBjeFRyYW5zbGF0ZSB9fVxuICAgIDwvY3gtZmlsZS11cGxvYWQ+XG4gICAgPGN4LWZvcm0tZXJyb3JzXG4gICAgICBbY29udHJvbF09XCJmb3JtLmdldCgnZmlsZScpXCJcbiAgICAgIHByZWZpeD1cImZvcm1FcnJvcnMuZmlsZVwiXG4gICAgPjwvY3gtZm9ybS1lcnJvcnM+XG4gIDwvbGFiZWw+XG4gIDxkaXYgY2xhc3M9XCJjeC1pbXBvcnQtZW50cmllcy1yb3dcIj5cbiAgICA8bGFiZWw+XG4gICAgICA8c3BhbiBjbGFzcz1cImN4LWltcG9ydC1lbnRyaWVzLWxhYmVsIGxhYmVsLWNvbnRlbnRcIj5cbiAgICAgICAge3sgJ2ltcG9ydEVudHJpZXNEaWFsb2cuc2F2ZWRDYXJ0TmFtZScgfCBjeFRyYW5zbGF0ZSB9fVxuICAgICAgPC9zcGFuPlxuICAgICAgPGlucHV0XG4gICAgICAgIFttYXhMZW5ndGhdPVwibmFtZU1heExlbmd0aFwiXG4gICAgICAgIGNsYXNzPVwiZm9ybS1jb250cm9sXCJcbiAgICAgICAgZm9ybUNvbnRyb2xOYW1lPVwibmFtZVwiXG4gICAgICAgIHJlcXVpcmVkXG4gICAgICAgIHR5cGU9XCJ0ZXh0XCJcbiAgICAgIC8+XG4gICAgICA8Y3gtZm9ybS1lcnJvcnMgW2NvbnRyb2xdPVwiZm9ybS5nZXQoJ25hbWUnKVwiPjwvY3gtZm9ybS1lcnJvcnM+XG4gICAgPC9sYWJlbD5cbiAgPC9kaXY+XG5cbiAgPGRpdiBjbGFzcz1cImN4LWltcG9ydC1lbnRyaWVzLXJvd1wiPlxuICAgIDxsYWJlbD5cbiAgICAgIDxzcGFuIGNsYXNzPVwiY3gtaW1wb3J0LWVudHJpZXMtbGFiZWwgbGFiZWwtY29udGVudFwiPlxuICAgICAgICB7eyAnaW1wb3J0RW50cmllc0RpYWxvZy5zYXZlZENhcnREZXNjcmlwdGlvbicgfCBjeFRyYW5zbGF0ZSB9fVxuICAgICAgICA8c3BhbiBjbGFzcz1cImN4LWltcG9ydC1lbnRyaWVzLWxhYmVsLW9wdGlvbmFsXCI+XG4gICAgICAgICAgKHt7ICdpbXBvcnRFbnRyaWVzRGlhbG9nLm9wdGlvbmFsJyB8IGN4VHJhbnNsYXRlIH19KVxuICAgICAgICA8L3NwYW4+PC9zcGFuXG4gICAgICA+XG4gICAgICA8dGV4dGFyZWFcbiAgICAgICAgW21heExlbmd0aF09XCJkZXNjcmlwdGlvbk1heExlbmd0aFwiXG4gICAgICAgIGNsYXNzPVwiZm9ybS1jb250cm9sXCJcbiAgICAgICAgZm9ybUNvbnRyb2xOYW1lPVwiZGVzY3JpcHRpb25cIlxuICAgICAgICByb3dzPVwiNVwiXG4gICAgICA+PC90ZXh0YXJlYT5cbiAgICAgIDxjeC1mb3JtLWVycm9ycyBbY29udHJvbF09XCJmb3JtLmdldCgnZGVzY3JpcHRpb24nKVwiPjwvY3gtZm9ybS1lcnJvcnM+XG5cbiAgICAgIDxwIGNsYXNzPVwiY3gtaW1wb3J0LWVudHJpZXMtaW5wdXQtaGludFwiPlxuICAgICAgICB7e1xuICAgICAgICAgICdpbXBvcnRFbnRyaWVzRGlhbG9nLmNoYXJhY3RlcnNMZWZ0J1xuICAgICAgICAgICAgfCBjeFRyYW5zbGF0ZTogeyBjb3VudDogZGVzY3JpcHRpb25zQ2hhcmFjdGVyTGVmdCB9XG4gICAgICAgIH19XG4gICAgICA8L3A+XG4gICAgPC9sYWJlbD5cbiAgPC9kaXY+XG4gIDxkaXYgY2xhc3M9XCJjeC1pbXBvcnQtZW50cmllcy1mb290ZXJcIj5cbiAgICA8YnV0dG9uXG4gICAgICAoY2xpY2spPVwiY2xvc2UoJ0Nsb3NlIEltcG9ydCBQcm9kdWN0cyBEaWFsb2cnKVwiXG4gICAgICBjbGFzcz1cImJ0biBidG4tYWN0aW9uXCJcbiAgICAgIHR5cGU9XCJidXR0b25cIlxuICAgID5cbiAgICAgIHt7ICdpbXBvcnRFbnRyaWVzRGlhbG9nLmNhbmNlbCcgfCBjeFRyYW5zbGF0ZSB9fVxuICAgIDwvYnV0dG9uPlxuICAgIDxidXR0b25cbiAgICAgIGNsYXNzPVwiYnRuIGJ0bi1wcmltYXJ5XCJcbiAgICAgIHR5cGU9XCJzdWJtaXRcIlxuICAgICAgW2Rpc2FibGVkXT1cImZvcm0uZ2V0KCdmaWxlJyk/LnN0YXR1cyA9PT0gJ1BFTkRJTkcnXCJcbiAgICA+XG4gICAgICB7eyAnaW1wb3J0RW50cmllc0RpYWxvZy51cGxvYWQnIHwgY3hUcmFuc2xhdGUgfX1cbiAgICA8L2J1dHRvbj5cbiAgPC9kaXY+XG48L2Zvcm0+XG4iXX0=