{"version":3,"file":"spartacus-tracking-personalization-core.umd.js","sources":["../../../feature-libs/tracking/personalization/core/personalization-core.module.ts","../../../feature-libs/tracking/personalization/core/services/personalization-context.service.ts","../../../feature-libs/tracking/personalization/core/spartacus-tracking-personalization-core.ts"],"sourcesContent":["import { NgModule } from '@angular/core';\n\n@NgModule({})\nexport class PersonalizationCoreModule {}\n","import { Injectable, isDevMode } from '@angular/core';\nimport { CmsService, ContentSlotComponentData, Page } from '@spartacus/core';\nimport { PersonalizationConfig } from '@spartacus/tracking/personalization/root';\nimport { EMPTY, Observable } from 'rxjs';\nimport { filter, map } from 'rxjs/operators';\nimport { PersonalizationContext } from '../model/personalization-context.model';\n\n@Injectable({\n  providedIn: 'root',\n})\nexport class PersonalizationContextService {\n  constructor(\n    protected config: PersonalizationConfig,\n    protected cmsService: CmsService\n  ) {}\n\n  getPersonalizationContext(): Observable<PersonalizationContext | undefined> {\n    if (!this.config.personalization?.context) {\n      if (isDevMode()) {\n        console.warn(`There is no context configured in Personalization.`);\n      }\n      return EMPTY;\n    } else {\n      const context = this.config.personalization.context;\n      return this.cmsService.getCurrentPage().pipe(\n        filter<Page>(Boolean),\n        map((page: Page) => page.slots?.[context.slotPosition]),\n        filter<any>(Boolean),\n        map((slot) => {\n          const scriptComponent = slot.components?.find(\n            (i: ContentSlotComponentData) => i.uid === context.componentId\n          );\n          return this.buildPersonalizationContext(\n            scriptComponent?.properties?.script?.data\n          );\n        })\n      );\n    }\n  }\n\n  private buildPersonalizationContext(\n    data: string\n  ): PersonalizationContext | undefined {\n    if (data) {\n      const context = JSON.parse(atob(data));\n      context.actions.forEach((action: any) => {\n        Object.keys(action).forEach((key) => {\n          action[key] = atob(action[key]);\n        });\n      });\n      for (let i = 0; i < context.segments.length; i++) {\n        context.segments[i] = atob(context.segments[i]);\n      }\n      return context;\n    }\n  }\n}\n","/**\n * Generated bundle index. Do not edit.\n */\n\nexport * from './public_api';\n"],"names":["NgModule","isDevMode","EMPTY","filter","map","Injectable"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;YAGA;;;;oJAAa,yBAAyB;qJAAzB,yBAAyB;qJAAzB,yBAAyB;yHAAzB,yBAAyB;0BADrCA,WAAQ;2BAAC,EAAE;;;;YCSV,uCACY,MAA6B,EAC7B,UAAsB;gBADtB,WAAM,GAAN,MAAM,CAAuB;gBAC7B,eAAU,GAAV,UAAU,CAAY;aAC9B;YAEJ,iEAAyB,GAAzB;gBAAA,iBAsBC;;gBArBC,IAAI,EAAC,MAAA,IAAI,CAAC,MAAM,CAAC,eAAe,0CAAE,OAAO,CAAA,EAAE;oBACzC,IAAIC,YAAS,EAAE,EAAE;wBACf,OAAO,CAAC,IAAI,CAAC,oDAAoD,CAAC,CAAC;qBACpE;oBACD,OAAOC,UAAK,CAAC;iBACd;qBAAM;oBACL,IAAM,SAAO,GAAG,IAAI,CAAC,MAAM,CAAC,eAAe,CAAC,OAAO,CAAC;oBACpD,OAAO,IAAI,CAAC,UAAU,CAAC,cAAc,EAAE,CAAC,IAAI,CAC1CC,gBAAM,CAAO,OAAO,CAAC,EACrBC,aAAG,CAAC,UAAC,IAAU,YAAK,OAAA,MAAA,IAAI,CAAC,KAAK,0CAAG,SAAO,CAAC,YAAY,CAAC,CAAA,EAAA,CAAC,EACvDD,gBAAM,CAAM,OAAO,CAAC,EACpBC,aAAG,CAAC,UAAC,IAAI;;wBACP,IAAM,eAAe,GAAG,MAAA,IAAI,CAAC,UAAU,0CAAE,IAAI,CAC3C,UAAC,CAA2B,IAAK,OAAA,CAAC,CAAC,GAAG,KAAK,SAAO,CAAC,WAAW,GAAA,CAC/D,CAAC;wBACF,OAAO,KAAI,CAAC,2BAA2B,CACrC,MAAA,MAAA,eAAe,aAAf,eAAe,uBAAf,eAAe,CAAE,UAAU,0CAAE,MAAM,0CAAE,IAAI,CAC1C,CAAC;qBACH,CAAC,CACH,CAAC;iBACH;aACF;YAEO,mEAA2B,GAA3B,UACN,IAAY;gBAEZ,IAAI,IAAI,EAAE;oBACR,IAAM,OAAO,GAAG,IAAI,CAAC,KAAK,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC,CAAC;oBACvC,OAAO,CAAC,OAAO,CAAC,OAAO,CAAC,UAAC,MAAW;wBAClC,MAAM,CAAC,IAAI,CAAC,MAAM,CAAC,CAAC,OAAO,CAAC,UAAC,GAAG;4BAC9B,MAAM,CAAC,GAAG,CAAC,GAAG,IAAI,CAAC,MAAM,CAAC,GAAG,CAAC,CAAC,CAAC;yBACjC,CAAC,CAAC;qBACJ,CAAC,CAAC;oBACH,KAAK,IAAI,CAAC,GAAG,CAAC,EAAE,CAAC,GAAG,OAAO,CAAC,QAAQ,CAAC,MAAM,EAAE,CAAC,EAAE,EAAE;wBAChD,OAAO,CAAC,QAAQ,CAAC,CAAC,CAAC,GAAG,IAAI,CAAC,OAAO,CAAC,QAAQ,CAAC,CAAC,CAAC,CAAC,CAAC;qBACjD;oBACD,OAAO,OAAO,CAAC;iBAChB;aACF;;;wJA7CU,6BAA6B;4JAA7B,6BAA6B,cAF5B,MAAM;yHAEP,6BAA6B;0BAHzCC,aAAU;2BAAC;4BACV,UAAU,EAAE,MAAM;yBACnB;;;QCTD;;;;;;;;;;;;;"}