{"version":3,"file":"spartacus-tracking-personalization-core.js","sources":["../../../feature-libs/tracking/personalization/core/personalization-core.module.ts","../../../feature-libs/tracking/personalization/core/services/personalization-context.service.ts","../../../feature-libs/tracking/personalization/core/spartacus-tracking-personalization-core.ts"],"sourcesContent":["import { NgModule } from '@angular/core';\n\n@NgModule({})\nexport class PersonalizationCoreModule {}\n","import { Injectable, isDevMode } from '@angular/core';\nimport { CmsService, ContentSlotComponentData, Page } from '@spartacus/core';\nimport { PersonalizationConfig } from '@spartacus/tracking/personalization/root';\nimport { EMPTY, Observable } from 'rxjs';\nimport { filter, map } from 'rxjs/operators';\nimport { PersonalizationContext } from '../model/personalization-context.model';\n\n@Injectable({\n  providedIn: 'root',\n})\nexport class PersonalizationContextService {\n  constructor(\n    protected config: PersonalizationConfig,\n    protected cmsService: CmsService\n  ) {}\n\n  getPersonalizationContext(): Observable<PersonalizationContext | undefined> {\n    if (!this.config.personalization?.context) {\n      if (isDevMode()) {\n        console.warn(`There is no context configured in Personalization.`);\n      }\n      return EMPTY;\n    } else {\n      const context = this.config.personalization.context;\n      return this.cmsService.getCurrentPage().pipe(\n        filter<Page>(Boolean),\n        map((page: Page) => page.slots?.[context.slotPosition]),\n        filter<any>(Boolean),\n        map((slot) => {\n          const scriptComponent = slot.components?.find(\n            (i: ContentSlotComponentData) => i.uid === context.componentId\n          );\n          return this.buildPersonalizationContext(\n            scriptComponent?.properties?.script?.data\n          );\n        })\n      );\n    }\n  }\n\n  private buildPersonalizationContext(\n    data: string\n  ): PersonalizationContext | undefined {\n    if (data) {\n      const context = JSON.parse(atob(data));\n      context.actions.forEach((action: any) => {\n        Object.keys(action).forEach((key) => {\n          action[key] = atob(action[key]);\n        });\n      });\n      for (let i = 0; i < context.segments.length; i++) {\n        context.segments[i] = atob(context.segments[i]);\n      }\n      return context;\n    }\n  }\n}\n","/**\n * Generated bundle index. Do not edit.\n */\n\nexport * from './public_api';\n"],"names":[],"mappings":";;;;;;;MAGa,yBAAyB;;sHAAzB,yBAAyB;uHAAzB,yBAAyB;uHAAzB,yBAAyB;2FAAzB,yBAAyB;kBADrC,QAAQ;mBAAC,EAAE;;;MCQC,6BAA6B;IACxC,YACY,MAA6B,EAC7B,UAAsB;QADtB,WAAM,GAAN,MAAM,CAAuB;QAC7B,eAAU,GAAV,UAAU,CAAY;KAC9B;IAEJ,yBAAyB;;QACvB,IAAI,EAAC,MAAA,IAAI,CAAC,MAAM,CAAC,eAAe,0CAAE,OAAO,CAAA,EAAE;YACzC,IAAI,SAAS,EAAE,EAAE;gBACf,OAAO,CAAC,IAAI,CAAC,oDAAoD,CAAC,CAAC;aACpE;YACD,OAAO,KAAK,CAAC;SACd;aAAM;YACL,MAAM,OAAO,GAAG,IAAI,CAAC,MAAM,CAAC,eAAe,CAAC,OAAO,CAAC;YACpD,OAAO,IAAI,CAAC,UAAU,CAAC,cAAc,EAAE,CAAC,IAAI,CAC1C,MAAM,CAAO,OAAO,CAAC,EACrB,GAAG,CAAC,CAAC,IAAU,eAAK,OAAA,MAAA,IAAI,CAAC,KAAK,0CAAG,OAAO,CAAC,YAAY,CAAC,CAAA,EAAA,CAAC,EACvD,MAAM,CAAM,OAAO,CAAC,EACpB,GAAG,CAAC,CAAC,IAAI;;gBACP,MAAM,eAAe,GAAG,MAAA,IAAI,CAAC,UAAU,0CAAE,IAAI,CAC3C,CAAC,CAA2B,KAAK,CAAC,CAAC,GAAG,KAAK,OAAO,CAAC,WAAW,CAC/D,CAAC;gBACF,OAAO,IAAI,CAAC,2BAA2B,CACrC,MAAA,MAAA,eAAe,aAAf,eAAe,uBAAf,eAAe,CAAE,UAAU,0CAAE,MAAM,0CAAE,IAAI,CAC1C,CAAC;aACH,CAAC,CACH,CAAC;SACH;KACF;IAEO,2BAA2B,CACjC,IAAY;QAEZ,IAAI,IAAI,EAAE;YACR,MAAM,OAAO,GAAG,IAAI,CAAC,KAAK,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC,CAAC;YACvC,OAAO,CAAC,OAAO,CAAC,OAAO,CAAC,CAAC,MAAW;gBAClC,MAAM,CAAC,IAAI,CAAC,MAAM,CAAC,CAAC,OAAO,CAAC,CAAC,GAAG;oBAC9B,MAAM,CAAC,GAAG,CAAC,GAAG,IAAI,CAAC,MAAM,CAAC,GAAG,CAAC,CAAC,CAAC;iBACjC,CAAC,CAAC;aACJ,CAAC,CAAC;YACH,KAAK,IAAI,CAAC,GAAG,CAAC,EAAE,CAAC,GAAG,OAAO,CAAC,QAAQ,CAAC,MAAM,EAAE,CAAC,EAAE,EAAE;gBAChD,OAAO,CAAC,QAAQ,CAAC,CAAC,CAAC,GAAG,IAAI,CAAC,OAAO,CAAC,QAAQ,CAAC,CAAC,CAAC,CAAC,CAAC;aACjD;YACD,OAAO,OAAO,CAAC;SAChB;KACF;;0HA7CU,6BAA6B;8HAA7B,6BAA6B,cAF5B,MAAM;2FAEP,6BAA6B;kBAHzC,UAAU;mBAAC;oBACV,UAAU,EAAE,MAAM;iBACnB;;;ACTD;;;;;;"}