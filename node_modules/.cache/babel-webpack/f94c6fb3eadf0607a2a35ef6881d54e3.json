{"ast":null,"code":"import * as i1 from '@angular/common';\nimport { CommonModule } from '@angular/common';\nimport * as i0 from '@angular/core';\nimport { Injectable, APP_INITIALIZER, NgModule } from '@angular/core';\nimport * as i3 from '@spartacus/storefront';\nimport { PageComponentModule } from '@spartacus/storefront';\nimport * as i1$1 from '@spartacus/core';\nimport { AuthStorageService, AuthActions, OCC_USER_ID_ANONYMOUS, OCC_USER_ID_CURRENT, AuthHttpHeaderService, InterceptorUtil, USE_CUSTOMER_SUPPORT_AGENT_TOKEN, GlobalMessageType, AuthService } from '@spartacus/core';\nimport { map, take, switchMap } from 'rxjs/operators';\nimport { __awaiter } from 'tslib';\nimport { BehaviorSubject, combineLatest, of, from } from 'rxjs';\nimport * as i3$1 from '@ngrx/store';\nconst ASM_ENABLED_LOCAL_STORAGE_KEY = 'asm_enabled';\n\n/**\n * The AsmEnablerService is used to enable ASM for those scenario's\n * where it's actually used. This service is added to avoid any polution\n * of the UI and runtime performance for the ordinary production user.\n */\nclass AsmEnablerService {\n  constructor(location, winRef, launchDialogService, featureModules) {\n    this.location = location;\n    this.winRef = winRef;\n    this.launchDialogService = launchDialogService;\n    this.featureModules = featureModules;\n  }\n  /**\n   * Loads the ASM UI if needed. The ASM UI will be added based on the\n   * existence of a URL parameter or previous usage given by local storage.\n   */\n  load() {\n    if (this.isEnabled()) {\n      this.addUi();\n    }\n  }\n  /**\n   * Indicates whether the ASM module is enabled.\n   */\n  isEnabled() {\n    if (this.isLaunched() && !this.isUsedBefore()) {\n      if (this.winRef.localStorage) {\n        this.winRef.localStorage.setItem(ASM_ENABLED_LOCAL_STORAGE_KEY, 'true');\n      }\n    }\n    return this.isLaunched() || this.isUsedBefore();\n  }\n  /**\n   * Indicates whether ASM is launched through the URL,\n   * using the asm flag in the URL.\n   */\n  isLaunched() {\n    const params = this.location.path().split('?')[1];\n    return !!params && params.split('&').includes('asm=true');\n  }\n  /**\n   * Evaluates local storage where we persist the usage of ASM.\n   */\n  isUsedBefore() {\n    if (this.winRef.localStorage) {\n      return this.winRef.localStorage.getItem(ASM_ENABLED_LOCAL_STORAGE_KEY) === 'true';\n    } else {\n      return false;\n    }\n  }\n  /**\n   * Adds the ASM UI by using the `cx-storefront` outlet.\n   */\n  addUi() {\n    this.featureModules.resolveFeature('asm').subscribe(() => this.launchDialogService.launch(\"ASM\" /* ASM */));\n  }\n}\n\nAsmEnablerService.ɵfac = function AsmEnablerService_Factory(t) {\n  return new (t || AsmEnablerService)(i0.ɵɵinject(i1.Location), i0.ɵɵinject(i1$1.WindowRef), i0.ɵɵinject(i3.LaunchDialogService), i0.ɵɵinject(i1$1.FeatureModulesService));\n};\nAsmEnablerService.ɵprov = /* @__PURE__ */i0.ɵɵdefineInjectable({\n  token: AsmEnablerService,\n  factory: AsmEnablerService.ɵfac,\n  providedIn: 'root'\n});\n(function () {\n  (typeof ngDevMode === \"undefined\" || ngDevMode) && i0.ɵsetClassMetadata(AsmEnablerService, [{\n    type: Injectable,\n    args: [{\n      providedIn: 'root'\n    }]\n  }], function () {\n    return [{\n      type: i1.Location\n    }, {\n      type: i1$1.WindowRef\n    }, {\n      type: i3.LaunchDialogService\n    }, {\n      type: i1$1.FeatureModulesService\n    }];\n  }, null);\n})();\n\n/**\n * The ASM loader module takes care of loading the ASM UI\n * only in case there's a reason to do so.\n */\nclass AsmLoaderModule {}\nAsmLoaderModule.ɵfac = function AsmLoaderModule_Factory(t) {\n  return new (t || AsmLoaderModule)();\n};\nAsmLoaderModule.ɵmod = /* @__PURE__ */i0.ɵɵdefineNgModule({\n  type: AsmLoaderModule\n});\nAsmLoaderModule.ɵinj = /* @__PURE__ */i0.ɵɵdefineInjector({\n  providers: [{\n    provide: APP_INITIALIZER,\n    useFactory: asmFactory,\n    deps: [AsmEnablerService],\n    multi: true\n  }],\n  imports: [[CommonModule, PageComponentModule]]\n});\n(function () {\n  (typeof ngDevMode === \"undefined\" || ngDevMode) && i0.ɵsetClassMetadata(AsmLoaderModule, [{\n    type: NgModule,\n    args: [{\n      imports: [CommonModule, PageComponentModule],\n      providers: [{\n        provide: APP_INITIALIZER,\n        useFactory: asmFactory,\n        deps: [AsmEnablerService],\n        multi: true\n      }]\n    }]\n  }], null, null);\n})();\n/**\n *\n * We do not like to block the UI, which is why we delgate loading of ASM\n * to a real component; the router and state aren't available in an optimized\n * way during the APP_INITIALIZER.\n */\nfunction asmFactory(asmEnablerService) {\n  const isReady = () => {\n    asmEnablerService.load();\n  };\n  return isReady;\n}\n\n/**\n * Indicates if auth token is for regular user or CS Agent.\n */\nvar TokenTarget;\n(function (TokenTarget) {\n  TokenTarget[\"CSAgent\"] = \"CSAgent\";\n  TokenTarget[\"User\"] = \"User\";\n})(TokenTarget || (TokenTarget = {}));\n/**\n * With AsmAuthStorageService apart from storing the token we also need to store\n * information for which user is the token (regular user or CS Agent).\n *\n * Overrides `AuthStorageService`.\n */\nclass AsmAuthStorageService extends AuthStorageService {\n  constructor() {\n    super(...arguments);\n    this._tokenTarget$ = new BehaviorSubject(TokenTarget.User);\n  }\n  /**\n   * Get target user for current auth token.\n   *\n   * @return observable with TokenTarget\n   */\n  getTokenTarget() {\n    return this._tokenTarget$;\n  }\n  /**\n   * Set new token target.\n   *\n   * @param tokenTarget\n   */\n  setTokenTarget(tokenTarget) {\n    this._tokenTarget$.next(tokenTarget);\n  }\n  /**\n   * Get token for previously user session, when it was interrupted by CS agent login.\n   *\n   * @return previously logged in user token.\n   */\n  getEmulatedUserToken() {\n    return this.emulatedUserToken;\n  }\n  /**\n   * Save user token on CS agent login.\n   *\n   * @param token\n   */\n  setEmulatedUserToken(token) {\n    this.emulatedUserToken = token;\n  }\n  /**\n   * Change token target to CS Agent.\n   */\n  switchTokenTargetToCSAgent() {\n    this._tokenTarget$.next(TokenTarget.CSAgent);\n  }\n  /**\n   * Change token target to user.\n   */\n  switchTokenTargetToUser() {\n    this._tokenTarget$.next(TokenTarget.User);\n  }\n  /**\n   * When we start emulation from the UI (not by ASM login) we can't restore user session on cs agent logout.\n   * Only available solution is to drop session we could restore, to avoid account hijack.\n   */\n  clearEmulatedUserToken() {\n    this.emulatedUserToken = undefined;\n  }\n}\nAsmAuthStorageService.ɵfac = /* @__PURE__ */function () {\n  let ɵAsmAuthStorageService_BaseFactory;\n  return function AsmAuthStorageService_Factory(t) {\n    return (ɵAsmAuthStorageService_BaseFactory || (ɵAsmAuthStorageService_BaseFactory = i0.ɵɵgetInheritedFactory(AsmAuthStorageService)))(t || AsmAuthStorageService);\n  };\n}();\nAsmAuthStorageService.ɵprov = /* @__PURE__ */i0.ɵɵdefineInjectable({\n  token: AsmAuthStorageService,\n  factory: AsmAuthStorageService.ɵfac,\n  providedIn: 'root'\n});\n(function () {\n  (typeof ngDevMode === \"undefined\" || ngDevMode) && i0.ɵsetClassMetadata(AsmAuthStorageService, [{\n    type: Injectable,\n    args: [{\n      providedIn: 'root'\n    }]\n  }], null, null);\n})();\n\n/**\n * Auth service for CS agent. Useful to login/logout agent, start emulation\n * or get information about the status of emulation.\n */\nclass CsAgentAuthService {\n  constructor(authService, authStorageService, userIdService, oAuthLibWrapperService, store, userService) {\n    this.authService = authService;\n    this.authStorageService = authStorageService;\n    this.userIdService = userIdService;\n    this.oAuthLibWrapperService = oAuthLibWrapperService;\n    this.store = store;\n    this.userService = userService;\n  }\n  /**\n   * Loads access token for a customer support agent.\n   * @param userId\n   * @param password\n   */\n  authorizeCustomerSupportAgent(userId, password) {\n    return __awaiter(this, void 0, void 0, function* () {\n      let userToken;\n      this.authStorageService.getToken().subscribe(token => userToken = token).unsubscribe();\n      this.authStorageService.switchTokenTargetToCSAgent();\n      try {\n        yield this.oAuthLibWrapperService.authorizeWithPasswordFlow(userId, password);\n        // Start emulation for currently logged in user\n        let customerId;\n        this.userService.get().subscribe(user => customerId = user === null || user === void 0 ? void 0 : user.customerId).unsubscribe();\n        this.store.dispatch(new AuthActions.Logout());\n        if (customerId !== undefined && userToken !== undefined) {\n          // OCC specific user id handling. Customize when implementing different backend\n          this.userIdService.setUserId(customerId);\n          this.authStorageService.setEmulatedUserToken(userToken);\n          this.store.dispatch(new AuthActions.Login());\n        } else {\n          // When we can't get the customerId just end all current sessions\n          this.userIdService.setUserId(OCC_USER_ID_ANONYMOUS);\n          this.authStorageService.clearEmulatedUserToken();\n        }\n      } catch (_a) {\n        this.authStorageService.switchTokenTargetToUser();\n      }\n    });\n  }\n  /**\n   * Starts an ASM customer emulation session.\n   * A customer emulation session is stopped by calling logout().\n   * @param customerId\n   */\n  startCustomerEmulationSession(customerId) {\n    this.authStorageService.clearEmulatedUserToken();\n    // OCC specific user id handling. Customize when implementing different backend\n    this.store.dispatch(new AuthActions.Logout());\n    this.userIdService.setUserId(customerId);\n    this.store.dispatch(new AuthActions.Login());\n  }\n  /**\n   * Check if CS agent is currently logged in.\n   *\n   * @returns observable emitting true when CS agent is logged in or false when not.\n   */\n  isCustomerSupportAgentLoggedIn() {\n    return combineLatest([this.authStorageService.getToken(), this.authStorageService.getTokenTarget()]).pipe(map(([token, tokenTarget]) => Boolean((token === null || token === void 0 ? void 0 : token.access_token) && tokenTarget === TokenTarget.CSAgent)));\n  }\n  /**\n   * Utility function to determine if customer is emulated.\n   *\n   * @returns observable emitting true when there is active emulation session or false when not.\n   */\n  isCustomerEmulated() {\n    return this.userIdService.isEmulated();\n  }\n  /**\n   * Returns the customer support agent's token loading status\n   */\n  getCustomerSupportAgentTokenLoading() {\n    // TODO(#8248): Create new loading state outside of store\n    return of(false);\n  }\n  /**\n   * Logout a customer support agent.\n   */\n  logoutCustomerSupportAgent() {\n    return __awaiter(this, void 0, void 0, function* () {\n      const emulatedToken = this.authStorageService.getEmulatedUserToken();\n      let isCustomerEmulated;\n      this.userIdService.isEmulated().subscribe(emulated => isCustomerEmulated = emulated).unsubscribe();\n      yield this.oAuthLibWrapperService.revokeAndLogout();\n      this.store.dispatch({\n        type: '[Auth] Logout Customer Support Agent'\n      });\n      this.authStorageService.setTokenTarget(TokenTarget.User);\n      if (isCustomerEmulated && emulatedToken) {\n        this.store.dispatch(new AuthActions.Logout());\n        this.authStorageService.setToken(emulatedToken);\n        this.userIdService.setUserId(OCC_USER_ID_CURRENT);\n        this.authStorageService.clearEmulatedUserToken();\n        this.store.dispatch(new AuthActions.Login());\n      } else {\n        this.authService.logout();\n      }\n    });\n  }\n}\nCsAgentAuthService.ɵfac = function CsAgentAuthService_Factory(t) {\n  return new (t || CsAgentAuthService)(i0.ɵɵinject(i1$1.AuthService), i0.ɵɵinject(AsmAuthStorageService), i0.ɵɵinject(i1$1.UserIdService), i0.ɵɵinject(i1$1.OAuthLibWrapperService), i0.ɵɵinject(i3$1.Store), i0.ɵɵinject(i1$1.UserService));\n};\nCsAgentAuthService.ɵprov = /* @__PURE__ */i0.ɵɵdefineInjectable({\n  token: CsAgentAuthService,\n  factory: CsAgentAuthService.ɵfac,\n  providedIn: 'root'\n});\n(function () {\n  (typeof ngDevMode === \"undefined\" || ngDevMode) && i0.ɵsetClassMetadata(CsAgentAuthService, [{\n    type: Injectable,\n    args: [{\n      providedIn: 'root'\n    }]\n  }], function () {\n    return [{\n      type: i1$1.AuthService\n    }, {\n      type: AsmAuthStorageService\n    }, {\n      type: i1$1.UserIdService\n    }, {\n      type: i1$1.OAuthLibWrapperService\n    }, {\n      type: i3$1.Store\n    }, {\n      type: i1$1.UserService\n    }];\n  }, null);\n})();\n\n/**\n * Overrides `AuthHttpHeaderService` to handle asm calls as well (not only OCC)\n * in cases of normal user session and on customer emulation.\n */\nclass AsmAuthHttpHeaderService extends AuthHttpHeaderService {\n  constructor(authService, authStorageService, csAgentAuthService, oAuthLibWrapperService, routingService, globalMessageService, occEndpointsService, authRedirectService) {\n    super(authService, authStorageService, oAuthLibWrapperService, routingService, occEndpointsService, globalMessageService, authRedirectService);\n    this.authService = authService;\n    this.authStorageService = authStorageService;\n    this.csAgentAuthService = csAgentAuthService;\n    this.oAuthLibWrapperService = oAuthLibWrapperService;\n    this.routingService = routingService;\n    this.globalMessageService = globalMessageService;\n    this.occEndpointsService = occEndpointsService;\n    this.authRedirectService = authRedirectService;\n  }\n  /**\n   * Checks if the authorization header should be added to the request\n   *\n   *  @override\n   */\n  shouldAddAuthorizationHeader(request) {\n    return super.shouldAddAuthorizationHeader(request) || this.isCSAgentTokenRequest(request);\n  }\n  /**\n   * @override\n   *\n   * Checks if particular request should be handled by this service.\n   */\n  shouldCatchError(request) {\n    return super.shouldCatchError(request) || this.isCSAgentTokenRequest(request);\n  }\n  /**\n   * @override\n   *\n   * Adds `Authorization` header to occ and CS agent requests.\n   * For CS agent requests also removes the `cx-use-csagent-token` header (to avoid problems with CORS).\n   */\n  alterRequest(request, token) {\n    const hasAuthorizationHeader = !!this.getAuthorizationHeader(request);\n    const isCSAgentRequest = this.isCSAgentTokenRequest(request);\n    let req = super.alterRequest(request, token);\n    if (!hasAuthorizationHeader && isCSAgentRequest) {\n      req = request.clone({\n        setHeaders: Object.assign({}, this.createAuthorizationHeader(token))\n      });\n      return InterceptorUtil.removeHeader(USE_CUSTOMER_SUPPORT_AGENT_TOKEN, req);\n    }\n    return req;\n  }\n  isCSAgentTokenRequest(request) {\n    const isRequestWithCSAgentToken = InterceptorUtil.getInterceptorParam(USE_CUSTOMER_SUPPORT_AGENT_TOKEN, request.headers);\n    return Boolean(isRequestWithCSAgentToken);\n  }\n  /**\n   * @override\n   *\n   * On backend errors indicating expired `refresh_token` we need to logout\n   * currently logged in user and CS agent.\n   */\n  handleExpiredRefreshToken() {\n    this.csAgentAuthService.isCustomerSupportAgentLoggedIn().pipe(take(1)).subscribe(csAgentLoggedIn => {\n      if (csAgentLoggedIn) {\n        this.authService.setLogoutProgress(true);\n        this.csAgentAuthService.logoutCustomerSupportAgent();\n        this.globalMessageService.add({\n          key: 'asm.csagentTokenExpired'\n        }, GlobalMessageType.MSG_TYPE_ERROR);\n      } else {\n        super.handleExpiredRefreshToken();\n      }\n    });\n  }\n}\nAsmAuthHttpHeaderService.ɵfac = function AsmAuthHttpHeaderService_Factory(t) {\n  return new (t || AsmAuthHttpHeaderService)(i0.ɵɵinject(i1$1.AuthService), i0.ɵɵinject(i1$1.AuthStorageService), i0.ɵɵinject(CsAgentAuthService), i0.ɵɵinject(i1$1.OAuthLibWrapperService), i0.ɵɵinject(i1$1.RoutingService), i0.ɵɵinject(i1$1.GlobalMessageService), i0.ɵɵinject(i1$1.OccEndpointsService), i0.ɵɵinject(i1$1.AuthRedirectService));\n};\nAsmAuthHttpHeaderService.ɵprov = /* @__PURE__ */i0.ɵɵdefineInjectable({\n  token: AsmAuthHttpHeaderService,\n  factory: AsmAuthHttpHeaderService.ɵfac,\n  providedIn: 'root'\n});\n(function () {\n  (typeof ngDevMode === \"undefined\" || ngDevMode) && i0.ɵsetClassMetadata(AsmAuthHttpHeaderService, [{\n    type: Injectable,\n    args: [{\n      providedIn: 'root'\n    }]\n  }], function () {\n    return [{\n      type: i1$1.AuthService\n    }, {\n      type: i1$1.AuthStorageService\n    }, {\n      type: CsAgentAuthService\n    }, {\n      type: i1$1.OAuthLibWrapperService\n    }, {\n      type: i1$1.RoutingService\n    }, {\n      type: i1$1.GlobalMessageService\n    }, {\n      type: i1$1.OccEndpointsService\n    }, {\n      type: i1$1.AuthRedirectService\n    }];\n  }, null);\n})();\n\n/**\n * Version of AuthService that is working for both user na CS agent.\n * Overrides AuthService when ASM module is enabled.\n */\nclass AsmAuthService extends AuthService {\n  constructor(store, userIdService, oAuthLibWrapperService, authStorageService, authRedirectService, globalMessageService, routingService) {\n    super(store, userIdService, oAuthLibWrapperService, authStorageService, authRedirectService, routingService);\n    this.store = store;\n    this.userIdService = userIdService;\n    this.oAuthLibWrapperService = oAuthLibWrapperService;\n    this.authStorageService = authStorageService;\n    this.authRedirectService = authRedirectService;\n    this.globalMessageService = globalMessageService;\n    this.routingService = routingService;\n  }\n  canUserLogin() {\n    let tokenTarget;\n    let token;\n    this.authStorageService.getToken().subscribe(tok => token = tok).unsubscribe();\n    this.authStorageService.getTokenTarget().subscribe(tokTarget => tokenTarget = tokTarget).unsubscribe();\n    return !(Boolean(token === null || token === void 0 ? void 0 : token.access_token) && tokenTarget === TokenTarget.CSAgent);\n  }\n  warnAboutLoggedCSAgent() {\n    this.globalMessageService.add({\n      key: 'asm.auth.agentLoggedInError'\n    }, GlobalMessageType.MSG_TYPE_ERROR);\n  }\n  /**\n   * Loads a new user token with Resource Owner Password Flow when CS agent is not logged in.\n   * @param userId\n   * @param password\n   */\n  loginWithCredentials(userId, password) {\n    const _super = Object.create(null, {\n      loginWithCredentials: {\n        get: () => super.loginWithCredentials\n      }\n    });\n    return __awaiter(this, void 0, void 0, function* () {\n      if (this.canUserLogin()) {\n        yield _super.loginWithCredentials.call(this, userId, password);\n      } else {\n        this.warnAboutLoggedCSAgent();\n      }\n    });\n  }\n  /**\n   * Initialize Implicit/Authorization Code flow by redirecting to OAuth server when CS agent is not logged in.\n   */\n  loginWithRedirect() {\n    if (this.canUserLogin()) {\n      super.loginWithRedirect();\n      return true;\n    } else {\n      this.warnAboutLoggedCSAgent();\n      return false;\n    }\n  }\n  /**\n   * Revokes tokens and clears state for logged user (tokens, userId).\n   * To perform logout it is best to use `logout` method. Use this method with caution.\n   */\n  coreLogout() {\n    return this.userIdService.isEmulated().pipe(take(1), switchMap(isEmulated => {\n      if (isEmulated) {\n        this.authStorageService.clearEmulatedUserToken();\n        this.userIdService.clearUserId();\n        this.store.dispatch(new AuthActions.Logout());\n        return of(true);\n      } else {\n        return from(super.coreLogout());\n      }\n    })).toPromise();\n  }\n  /**\n   * Returns `true` if user is logged in or being emulated.\n   */\n  isUserLoggedIn() {\n    return combineLatest([this.authStorageService.getToken(), this.userIdService.isEmulated(), this.authStorageService.getTokenTarget()]).pipe(map(([token, isEmulated, tokenTarget]) => Boolean(token === null || token === void 0 ? void 0 : token.access_token) && (tokenTarget === TokenTarget.User || tokenTarget === TokenTarget.CSAgent && isEmulated)));\n  }\n}\nAsmAuthService.ɵfac = function AsmAuthService_Factory(t) {\n  return new (t || AsmAuthService)(i0.ɵɵinject(i3$1.Store), i0.ɵɵinject(i1$1.UserIdService), i0.ɵɵinject(i1$1.OAuthLibWrapperService), i0.ɵɵinject(AsmAuthStorageService), i0.ɵɵinject(i1$1.AuthRedirectService), i0.ɵɵinject(i1$1.GlobalMessageService), i0.ɵɵinject(i1$1.RoutingService));\n};\nAsmAuthService.ɵprov = /* @__PURE__ */i0.ɵɵdefineInjectable({\n  token: AsmAuthService,\n  factory: AsmAuthService.ɵfac,\n  providedIn: 'root'\n});\n(function () {\n  (typeof ngDevMode === \"undefined\" || ngDevMode) && i0.ɵsetClassMetadata(AsmAuthService, [{\n    type: Injectable,\n    args: [{\n      providedIn: 'root'\n    }]\n  }], function () {\n    return [{\n      type: i3$1.Store\n    }, {\n      type: i1$1.UserIdService\n    }, {\n      type: i1$1.OAuthLibWrapperService\n    }, {\n      type: AsmAuthStorageService\n    }, {\n      type: i1$1.AuthRedirectService\n    }, {\n      type: i1$1.GlobalMessageService\n    }, {\n      type: i1$1.RoutingService\n    }];\n  }, null);\n})();\nclass AsmRootModule {}\nAsmRootModule.ɵfac = function AsmRootModule_Factory(t) {\n  return new (t || AsmRootModule)();\n};\nAsmRootModule.ɵmod = /* @__PURE__ */i0.ɵɵdefineNgModule({\n  type: AsmRootModule\n});\nAsmRootModule.ɵinj = /* @__PURE__ */i0.ɵɵdefineInjector({\n  providers: [{\n    provide: AuthStorageService,\n    useExisting: AsmAuthStorageService\n  }, {\n    provide: AuthService,\n    useExisting: AsmAuthService\n  }, {\n    provide: AuthHttpHeaderService,\n    useExisting: AsmAuthHttpHeaderService\n  }],\n  imports: [[AsmLoaderModule]]\n});\n(function () {\n  (typeof ngDevMode === \"undefined\" || ngDevMode) && i0.ɵsetClassMetadata(AsmRootModule, [{\n    type: NgModule,\n    args: [{\n      imports: [AsmLoaderModule],\n      providers: [{\n        provide: AuthStorageService,\n        useExisting: AsmAuthStorageService\n      }, {\n        provide: AuthService,\n        useExisting: AsmAuthService\n      }, {\n        provide: AuthHttpHeaderService,\n        useExisting: AsmAuthHttpHeaderService\n      }]\n    }]\n  }], null, null);\n})();\nconst ASM_FEATURE = 'asm';\n\n/**\n * Generated bundle index. Do not edit.\n */\n\nexport { ASM_ENABLED_LOCAL_STORAGE_KEY, ASM_FEATURE, AsmAuthHttpHeaderService, AsmAuthService, AsmAuthStorageService, AsmEnablerService, AsmLoaderModule, AsmRootModule, CsAgentAuthService, TokenTarget, asmFactory };\n//# sourceMappingURL=spartacus-asm-root.js.map","map":{"version":3,"names":["i1","CommonModule","i0","Injectable","APP_INITIALIZER","NgModule","i3","PageComponentModule","i1$1","AuthStorageService","AuthActions","OCC_USER_ID_ANONYMOUS","OCC_USER_ID_CURRENT","AuthHttpHeaderService","InterceptorUtil","USE_CUSTOMER_SUPPORT_AGENT_TOKEN","GlobalMessageType","AuthService","map","take","switchMap","__awaiter","BehaviorSubject","combineLatest","of","from","i3$1","ASM_ENABLED_LOCAL_STORAGE_KEY","AsmEnablerService","constructor","location","winRef","launchDialogService","featureModules","load","isEnabled","addUi","isLaunched","isUsedBefore","localStorage","setItem","params","path","split","includes","getItem","resolveFeature","subscribe","launch","ɵfac","AsmEnablerService_Factory","t","ɵɵinject","Location","WindowRef","LaunchDialogService","FeatureModulesService","ɵprov","ɵɵdefineInjectable","token","factory","providedIn","ngDevMode","ɵsetClassMetadata","type","args","AsmLoaderModule","AsmLoaderModule_Factory","ɵmod","ɵɵdefineNgModule","ɵinj","ɵɵdefineInjector","providers","provide","useFactory","asmFactory","deps","multi","imports","asmEnablerService","isReady","TokenTarget","AsmAuthStorageService","arguments","_tokenTarget$","User","getTokenTarget","setTokenTarget","tokenTarget","next","getEmulatedUserToken","emulatedUserToken","setEmulatedUserToken","switchTokenTargetToCSAgent","CSAgent","switchTokenTargetToUser","clearEmulatedUserToken","undefined","ɵAsmAuthStorageService_BaseFactory","AsmAuthStorageService_Factory","ɵɵgetInheritedFactory","CsAgentAuthService","authService","authStorageService","userIdService","oAuthLibWrapperService","store","userService","authorizeCustomerSupportAgent","userId","password","userToken","getToken","unsubscribe","authorizeWithPasswordFlow","customerId","get","user","dispatch","Logout","setUserId","Login","_a","startCustomerEmulationSession","isCustomerSupportAgentLoggedIn","pipe","Boolean","access_token","isCustomerEmulated","isEmulated","getCustomerSupportAgentTokenLoading","logoutCustomerSupportAgent","emulatedToken","emulated","revokeAndLogout","setToken","logout","CsAgentAuthService_Factory","UserIdService","OAuthLibWrapperService","Store","UserService","AsmAuthHttpHeaderService","csAgentAuthService","routingService","globalMessageService","occEndpointsService","authRedirectService","shouldAddAuthorizationHeader","request","isCSAgentTokenRequest","shouldCatchError","alterRequest","hasAuthorizationHeader","getAuthorizationHeader","isCSAgentRequest","req","clone","setHeaders","Object","assign","createAuthorizationHeader","removeHeader","isRequestWithCSAgentToken","getInterceptorParam","headers","handleExpiredRefreshToken","csAgentLoggedIn","setLogoutProgress","add","key","MSG_TYPE_ERROR","AsmAuthHttpHeaderService_Factory","RoutingService","GlobalMessageService","OccEndpointsService","AuthRedirectService","AsmAuthService","canUserLogin","tok","tokTarget","warnAboutLoggedCSAgent","loginWithCredentials","_super","create","call","loginWithRedirect","coreLogout","clearUserId","toPromise","isUserLoggedIn","AsmAuthService_Factory","AsmRootModule","AsmRootModule_Factory","useExisting","ASM_FEATURE"],"sources":["D:/demo_spartacus/node_modules/@spartacus/asm/fesm2015/spartacus-asm-root.js"],"sourcesContent":["import * as i1 from '@angular/common';\nimport { CommonModule } from '@angular/common';\nimport * as i0 from '@angular/core';\nimport { Injectable, APP_INITIALIZER, NgModule } from '@angular/core';\nimport * as i3 from '@spartacus/storefront';\nimport { PageComponentModule } from '@spartacus/storefront';\nimport * as i1$1 from '@spartacus/core';\nimport { AuthStorageService, AuthActions, OCC_USER_ID_ANONYMOUS, OCC_USER_ID_CURRENT, AuthHttpHeaderService, InterceptorUtil, USE_CUSTOMER_SUPPORT_AGENT_TOKEN, GlobalMessageType, AuthService } from '@spartacus/core';\nimport { map, take, switchMap } from 'rxjs/operators';\nimport { __awaiter } from 'tslib';\nimport { BehaviorSubject, combineLatest, of, from } from 'rxjs';\nimport * as i3$1 from '@ngrx/store';\n\nconst ASM_ENABLED_LOCAL_STORAGE_KEY = 'asm_enabled';\n\n/**\n * The AsmEnablerService is used to enable ASM for those scenario's\n * where it's actually used. This service is added to avoid any polution\n * of the UI and runtime performance for the ordinary production user.\n */\nclass AsmEnablerService {\n    constructor(location, winRef, launchDialogService, featureModules) {\n        this.location = location;\n        this.winRef = winRef;\n        this.launchDialogService = launchDialogService;\n        this.featureModules = featureModules;\n    }\n    /**\n     * Loads the ASM UI if needed. The ASM UI will be added based on the\n     * existence of a URL parameter or previous usage given by local storage.\n     */\n    load() {\n        if (this.isEnabled()) {\n            this.addUi();\n        }\n    }\n    /**\n     * Indicates whether the ASM module is enabled.\n     */\n    isEnabled() {\n        if (this.isLaunched() && !this.isUsedBefore()) {\n            if (this.winRef.localStorage) {\n                this.winRef.localStorage.setItem(ASM_ENABLED_LOCAL_STORAGE_KEY, 'true');\n            }\n        }\n        return this.isLaunched() || this.isUsedBefore();\n    }\n    /**\n     * Indicates whether ASM is launched through the URL,\n     * using the asm flag in the URL.\n     */\n    isLaunched() {\n        const params = this.location.path().split('?')[1];\n        return !!params && params.split('&').includes('asm=true');\n    }\n    /**\n     * Evaluates local storage where we persist the usage of ASM.\n     */\n    isUsedBefore() {\n        if (this.winRef.localStorage) {\n            return (this.winRef.localStorage.getItem(ASM_ENABLED_LOCAL_STORAGE_KEY) ===\n                'true');\n        }\n        else {\n            return false;\n        }\n    }\n    /**\n     * Adds the ASM UI by using the `cx-storefront` outlet.\n     */\n    addUi() {\n        this.featureModules\n            .resolveFeature('asm')\n            .subscribe(() => this.launchDialogService.launch(\"ASM\" /* ASM */));\n    }\n}\nAsmEnablerService.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: \"12.0.0\", version: \"12.0.5\", ngImport: i0, type: AsmEnablerService, deps: [{ token: i1.Location }, { token: i1$1.WindowRef }, { token: i3.LaunchDialogService }, { token: i1$1.FeatureModulesService }], target: i0.ɵɵFactoryTarget.Injectable });\nAsmEnablerService.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: \"12.0.0\", version: \"12.0.5\", ngImport: i0, type: AsmEnablerService, providedIn: 'root' });\ni0.ɵɵngDeclareClassMetadata({ minVersion: \"12.0.0\", version: \"12.0.5\", ngImport: i0, type: AsmEnablerService, decorators: [{\n            type: Injectable,\n            args: [{\n                    providedIn: 'root',\n                }]\n        }], ctorParameters: function () { return [{ type: i1.Location }, { type: i1$1.WindowRef }, { type: i3.LaunchDialogService }, { type: i1$1.FeatureModulesService }]; } });\n\n/**\n * The ASM loader module takes care of loading the ASM UI\n * only in case there's a reason to do so.\n */\nclass AsmLoaderModule {\n}\nAsmLoaderModule.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: \"12.0.0\", version: \"12.0.5\", ngImport: i0, type: AsmLoaderModule, deps: [], target: i0.ɵɵFactoryTarget.NgModule });\nAsmLoaderModule.ɵmod = i0.ɵɵngDeclareNgModule({ minVersion: \"12.0.0\", version: \"12.0.5\", ngImport: i0, type: AsmLoaderModule, imports: [CommonModule, PageComponentModule] });\nAsmLoaderModule.ɵinj = i0.ɵɵngDeclareInjector({ minVersion: \"12.0.0\", version: \"12.0.5\", ngImport: i0, type: AsmLoaderModule, providers: [\n        {\n            provide: APP_INITIALIZER,\n            useFactory: asmFactory,\n            deps: [AsmEnablerService],\n            multi: true,\n        },\n    ], imports: [[CommonModule, PageComponentModule]] });\ni0.ɵɵngDeclareClassMetadata({ minVersion: \"12.0.0\", version: \"12.0.5\", ngImport: i0, type: AsmLoaderModule, decorators: [{\n            type: NgModule,\n            args: [{\n                    imports: [CommonModule, PageComponentModule],\n                    providers: [\n                        {\n                            provide: APP_INITIALIZER,\n                            useFactory: asmFactory,\n                            deps: [AsmEnablerService],\n                            multi: true,\n                        },\n                    ],\n                }]\n        }] });\n/**\n *\n * We do not like to block the UI, which is why we delgate loading of ASM\n * to a real component; the router and state aren't available in an optimized\n * way during the APP_INITIALIZER.\n */\nfunction asmFactory(asmEnablerService) {\n    const isReady = () => {\n        asmEnablerService.load();\n    };\n    return isReady;\n}\n\n/**\n * Indicates if auth token is for regular user or CS Agent.\n */\nvar TokenTarget;\n(function (TokenTarget) {\n    TokenTarget[\"CSAgent\"] = \"CSAgent\";\n    TokenTarget[\"User\"] = \"User\";\n})(TokenTarget || (TokenTarget = {}));\n/**\n * With AsmAuthStorageService apart from storing the token we also need to store\n * information for which user is the token (regular user or CS Agent).\n *\n * Overrides `AuthStorageService`.\n */\nclass AsmAuthStorageService extends AuthStorageService {\n    constructor() {\n        super(...arguments);\n        this._tokenTarget$ = new BehaviorSubject(TokenTarget.User);\n    }\n    /**\n     * Get target user for current auth token.\n     *\n     * @return observable with TokenTarget\n     */\n    getTokenTarget() {\n        return this._tokenTarget$;\n    }\n    /**\n     * Set new token target.\n     *\n     * @param tokenTarget\n     */\n    setTokenTarget(tokenTarget) {\n        this._tokenTarget$.next(tokenTarget);\n    }\n    /**\n     * Get token for previously user session, when it was interrupted by CS agent login.\n     *\n     * @return previously logged in user token.\n     */\n    getEmulatedUserToken() {\n        return this.emulatedUserToken;\n    }\n    /**\n     * Save user token on CS agent login.\n     *\n     * @param token\n     */\n    setEmulatedUserToken(token) {\n        this.emulatedUserToken = token;\n    }\n    /**\n     * Change token target to CS Agent.\n     */\n    switchTokenTargetToCSAgent() {\n        this._tokenTarget$.next(TokenTarget.CSAgent);\n    }\n    /**\n     * Change token target to user.\n     */\n    switchTokenTargetToUser() {\n        this._tokenTarget$.next(TokenTarget.User);\n    }\n    /**\n     * When we start emulation from the UI (not by ASM login) we can't restore user session on cs agent logout.\n     * Only available solution is to drop session we could restore, to avoid account hijack.\n     */\n    clearEmulatedUserToken() {\n        this.emulatedUserToken = undefined;\n    }\n}\nAsmAuthStorageService.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: \"12.0.0\", version: \"12.0.5\", ngImport: i0, type: AsmAuthStorageService, deps: null, target: i0.ɵɵFactoryTarget.Injectable });\nAsmAuthStorageService.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: \"12.0.0\", version: \"12.0.5\", ngImport: i0, type: AsmAuthStorageService, providedIn: 'root' });\ni0.ɵɵngDeclareClassMetadata({ minVersion: \"12.0.0\", version: \"12.0.5\", ngImport: i0, type: AsmAuthStorageService, decorators: [{\n            type: Injectable,\n            args: [{\n                    providedIn: 'root',\n                }]\n        }] });\n\n/**\n * Auth service for CS agent. Useful to login/logout agent, start emulation\n * or get information about the status of emulation.\n */\nclass CsAgentAuthService {\n    constructor(authService, authStorageService, userIdService, oAuthLibWrapperService, store, userService) {\n        this.authService = authService;\n        this.authStorageService = authStorageService;\n        this.userIdService = userIdService;\n        this.oAuthLibWrapperService = oAuthLibWrapperService;\n        this.store = store;\n        this.userService = userService;\n    }\n    /**\n     * Loads access token for a customer support agent.\n     * @param userId\n     * @param password\n     */\n    authorizeCustomerSupportAgent(userId, password) {\n        return __awaiter(this, void 0, void 0, function* () {\n            let userToken;\n            this.authStorageService\n                .getToken()\n                .subscribe((token) => (userToken = token))\n                .unsubscribe();\n            this.authStorageService.switchTokenTargetToCSAgent();\n            try {\n                yield this.oAuthLibWrapperService.authorizeWithPasswordFlow(userId, password);\n                // Start emulation for currently logged in user\n                let customerId;\n                this.userService\n                    .get()\n                    .subscribe((user) => (customerId = user === null || user === void 0 ? void 0 : user.customerId))\n                    .unsubscribe();\n                this.store.dispatch(new AuthActions.Logout());\n                if (customerId !== undefined && userToken !== undefined) {\n                    // OCC specific user id handling. Customize when implementing different backend\n                    this.userIdService.setUserId(customerId);\n                    this.authStorageService.setEmulatedUserToken(userToken);\n                    this.store.dispatch(new AuthActions.Login());\n                }\n                else {\n                    // When we can't get the customerId just end all current sessions\n                    this.userIdService.setUserId(OCC_USER_ID_ANONYMOUS);\n                    this.authStorageService.clearEmulatedUserToken();\n                }\n            }\n            catch (_a) {\n                this.authStorageService.switchTokenTargetToUser();\n            }\n        });\n    }\n    /**\n     * Starts an ASM customer emulation session.\n     * A customer emulation session is stopped by calling logout().\n     * @param customerId\n     */\n    startCustomerEmulationSession(customerId) {\n        this.authStorageService.clearEmulatedUserToken();\n        // OCC specific user id handling. Customize when implementing different backend\n        this.store.dispatch(new AuthActions.Logout());\n        this.userIdService.setUserId(customerId);\n        this.store.dispatch(new AuthActions.Login());\n    }\n    /**\n     * Check if CS agent is currently logged in.\n     *\n     * @returns observable emitting true when CS agent is logged in or false when not.\n     */\n    isCustomerSupportAgentLoggedIn() {\n        return combineLatest([\n            this.authStorageService.getToken(),\n            this.authStorageService.getTokenTarget(),\n        ]).pipe(map(([token, tokenTarget]) => Boolean((token === null || token === void 0 ? void 0 : token.access_token) && tokenTarget === TokenTarget.CSAgent)));\n    }\n    /**\n     * Utility function to determine if customer is emulated.\n     *\n     * @returns observable emitting true when there is active emulation session or false when not.\n     */\n    isCustomerEmulated() {\n        return this.userIdService.isEmulated();\n    }\n    /**\n     * Returns the customer support agent's token loading status\n     */\n    getCustomerSupportAgentTokenLoading() {\n        // TODO(#8248): Create new loading state outside of store\n        return of(false);\n    }\n    /**\n     * Logout a customer support agent.\n     */\n    logoutCustomerSupportAgent() {\n        return __awaiter(this, void 0, void 0, function* () {\n            const emulatedToken = this.authStorageService.getEmulatedUserToken();\n            let isCustomerEmulated;\n            this.userIdService\n                .isEmulated()\n                .subscribe((emulated) => (isCustomerEmulated = emulated))\n                .unsubscribe();\n            yield this.oAuthLibWrapperService.revokeAndLogout();\n            this.store.dispatch({ type: '[Auth] Logout Customer Support Agent' });\n            this.authStorageService.setTokenTarget(TokenTarget.User);\n            if (isCustomerEmulated && emulatedToken) {\n                this.store.dispatch(new AuthActions.Logout());\n                this.authStorageService.setToken(emulatedToken);\n                this.userIdService.setUserId(OCC_USER_ID_CURRENT);\n                this.authStorageService.clearEmulatedUserToken();\n                this.store.dispatch(new AuthActions.Login());\n            }\n            else {\n                this.authService.logout();\n            }\n        });\n    }\n}\nCsAgentAuthService.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: \"12.0.0\", version: \"12.0.5\", ngImport: i0, type: CsAgentAuthService, deps: [{ token: i1$1.AuthService }, { token: AsmAuthStorageService }, { token: i1$1.UserIdService }, { token: i1$1.OAuthLibWrapperService }, { token: i3$1.Store }, { token: i1$1.UserService }], target: i0.ɵɵFactoryTarget.Injectable });\nCsAgentAuthService.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: \"12.0.0\", version: \"12.0.5\", ngImport: i0, type: CsAgentAuthService, providedIn: 'root' });\ni0.ɵɵngDeclareClassMetadata({ minVersion: \"12.0.0\", version: \"12.0.5\", ngImport: i0, type: CsAgentAuthService, decorators: [{\n            type: Injectable,\n            args: [{\n                    providedIn: 'root',\n                }]\n        }], ctorParameters: function () { return [{ type: i1$1.AuthService }, { type: AsmAuthStorageService }, { type: i1$1.UserIdService }, { type: i1$1.OAuthLibWrapperService }, { type: i3$1.Store }, { type: i1$1.UserService }]; } });\n\n/**\n * Overrides `AuthHttpHeaderService` to handle asm calls as well (not only OCC)\n * in cases of normal user session and on customer emulation.\n */\nclass AsmAuthHttpHeaderService extends AuthHttpHeaderService {\n    constructor(authService, authStorageService, csAgentAuthService, oAuthLibWrapperService, routingService, globalMessageService, occEndpointsService, authRedirectService) {\n        super(authService, authStorageService, oAuthLibWrapperService, routingService, occEndpointsService, globalMessageService, authRedirectService);\n        this.authService = authService;\n        this.authStorageService = authStorageService;\n        this.csAgentAuthService = csAgentAuthService;\n        this.oAuthLibWrapperService = oAuthLibWrapperService;\n        this.routingService = routingService;\n        this.globalMessageService = globalMessageService;\n        this.occEndpointsService = occEndpointsService;\n        this.authRedirectService = authRedirectService;\n    }\n    /**\n     * Checks if the authorization header should be added to the request\n     *\n     *  @override\n     */\n    shouldAddAuthorizationHeader(request) {\n        return (super.shouldAddAuthorizationHeader(request) ||\n            this.isCSAgentTokenRequest(request));\n    }\n    /**\n     * @override\n     *\n     * Checks if particular request should be handled by this service.\n     */\n    shouldCatchError(request) {\n        return (super.shouldCatchError(request) || this.isCSAgentTokenRequest(request));\n    }\n    /**\n     * @override\n     *\n     * Adds `Authorization` header to occ and CS agent requests.\n     * For CS agent requests also removes the `cx-use-csagent-token` header (to avoid problems with CORS).\n     */\n    alterRequest(request, token) {\n        const hasAuthorizationHeader = !!this.getAuthorizationHeader(request);\n        const isCSAgentRequest = this.isCSAgentTokenRequest(request);\n        let req = super.alterRequest(request, token);\n        if (!hasAuthorizationHeader && isCSAgentRequest) {\n            req = request.clone({\n                setHeaders: Object.assign({}, this.createAuthorizationHeader(token)),\n            });\n            return InterceptorUtil.removeHeader(USE_CUSTOMER_SUPPORT_AGENT_TOKEN, req);\n        }\n        return req;\n    }\n    isCSAgentTokenRequest(request) {\n        const isRequestWithCSAgentToken = InterceptorUtil.getInterceptorParam(USE_CUSTOMER_SUPPORT_AGENT_TOKEN, request.headers);\n        return Boolean(isRequestWithCSAgentToken);\n    }\n    /**\n     * @override\n     *\n     * On backend errors indicating expired `refresh_token` we need to logout\n     * currently logged in user and CS agent.\n     */\n    handleExpiredRefreshToken() {\n        this.csAgentAuthService\n            .isCustomerSupportAgentLoggedIn()\n            .pipe(take(1))\n            .subscribe((csAgentLoggedIn) => {\n            if (csAgentLoggedIn) {\n                this.authService.setLogoutProgress(true);\n                this.csAgentAuthService.logoutCustomerSupportAgent();\n                this.globalMessageService.add({\n                    key: 'asm.csagentTokenExpired',\n                }, GlobalMessageType.MSG_TYPE_ERROR);\n            }\n            else {\n                super.handleExpiredRefreshToken();\n            }\n        });\n    }\n}\nAsmAuthHttpHeaderService.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: \"12.0.0\", version: \"12.0.5\", ngImport: i0, type: AsmAuthHttpHeaderService, deps: [{ token: i1$1.AuthService }, { token: i1$1.AuthStorageService }, { token: CsAgentAuthService }, { token: i1$1.OAuthLibWrapperService }, { token: i1$1.RoutingService }, { token: i1$1.GlobalMessageService }, { token: i1$1.OccEndpointsService }, { token: i1$1.AuthRedirectService }], target: i0.ɵɵFactoryTarget.Injectable });\nAsmAuthHttpHeaderService.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: \"12.0.0\", version: \"12.0.5\", ngImport: i0, type: AsmAuthHttpHeaderService, providedIn: 'root' });\ni0.ɵɵngDeclareClassMetadata({ minVersion: \"12.0.0\", version: \"12.0.5\", ngImport: i0, type: AsmAuthHttpHeaderService, decorators: [{\n            type: Injectable,\n            args: [{\n                    providedIn: 'root',\n                }]\n        }], ctorParameters: function () { return [{ type: i1$1.AuthService }, { type: i1$1.AuthStorageService }, { type: CsAgentAuthService }, { type: i1$1.OAuthLibWrapperService }, { type: i1$1.RoutingService }, { type: i1$1.GlobalMessageService }, { type: i1$1.OccEndpointsService }, { type: i1$1.AuthRedirectService }]; } });\n\n/**\n * Version of AuthService that is working for both user na CS agent.\n * Overrides AuthService when ASM module is enabled.\n */\nclass AsmAuthService extends AuthService {\n    constructor(store, userIdService, oAuthLibWrapperService, authStorageService, authRedirectService, globalMessageService, routingService) {\n        super(store, userIdService, oAuthLibWrapperService, authStorageService, authRedirectService, routingService);\n        this.store = store;\n        this.userIdService = userIdService;\n        this.oAuthLibWrapperService = oAuthLibWrapperService;\n        this.authStorageService = authStorageService;\n        this.authRedirectService = authRedirectService;\n        this.globalMessageService = globalMessageService;\n        this.routingService = routingService;\n    }\n    canUserLogin() {\n        let tokenTarget;\n        let token;\n        this.authStorageService\n            .getToken()\n            .subscribe((tok) => (token = tok))\n            .unsubscribe();\n        this.authStorageService\n            .getTokenTarget()\n            .subscribe((tokTarget) => (tokenTarget = tokTarget))\n            .unsubscribe();\n        return !(Boolean(token === null || token === void 0 ? void 0 : token.access_token) && tokenTarget === TokenTarget.CSAgent);\n    }\n    warnAboutLoggedCSAgent() {\n        this.globalMessageService.add({\n            key: 'asm.auth.agentLoggedInError',\n        }, GlobalMessageType.MSG_TYPE_ERROR);\n    }\n    /**\n     * Loads a new user token with Resource Owner Password Flow when CS agent is not logged in.\n     * @param userId\n     * @param password\n     */\n    loginWithCredentials(userId, password) {\n        const _super = Object.create(null, {\n            loginWithCredentials: { get: () => super.loginWithCredentials }\n        });\n        return __awaiter(this, void 0, void 0, function* () {\n            if (this.canUserLogin()) {\n                yield _super.loginWithCredentials.call(this, userId, password);\n            }\n            else {\n                this.warnAboutLoggedCSAgent();\n            }\n        });\n    }\n    /**\n     * Initialize Implicit/Authorization Code flow by redirecting to OAuth server when CS agent is not logged in.\n     */\n    loginWithRedirect() {\n        if (this.canUserLogin()) {\n            super.loginWithRedirect();\n            return true;\n        }\n        else {\n            this.warnAboutLoggedCSAgent();\n            return false;\n        }\n    }\n    /**\n     * Revokes tokens and clears state for logged user (tokens, userId).\n     * To perform logout it is best to use `logout` method. Use this method with caution.\n     */\n    coreLogout() {\n        return this.userIdService\n            .isEmulated()\n            .pipe(take(1), switchMap((isEmulated) => {\n            if (isEmulated) {\n                this.authStorageService.clearEmulatedUserToken();\n                this.userIdService.clearUserId();\n                this.store.dispatch(new AuthActions.Logout());\n                return of(true);\n            }\n            else {\n                return from(super.coreLogout());\n            }\n        }))\n            .toPromise();\n    }\n    /**\n     * Returns `true` if user is logged in or being emulated.\n     */\n    isUserLoggedIn() {\n        return combineLatest([\n            this.authStorageService.getToken(),\n            this.userIdService.isEmulated(),\n            this.authStorageService.getTokenTarget(),\n        ]).pipe(map(([token, isEmulated, tokenTarget]) => Boolean(token === null || token === void 0 ? void 0 : token.access_token) &&\n            (tokenTarget === TokenTarget.User ||\n                (tokenTarget === TokenTarget.CSAgent && isEmulated))));\n    }\n}\nAsmAuthService.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: \"12.0.0\", version: \"12.0.5\", ngImport: i0, type: AsmAuthService, deps: [{ token: i3$1.Store }, { token: i1$1.UserIdService }, { token: i1$1.OAuthLibWrapperService }, { token: AsmAuthStorageService }, { token: i1$1.AuthRedirectService }, { token: i1$1.GlobalMessageService }, { token: i1$1.RoutingService }], target: i0.ɵɵFactoryTarget.Injectable });\nAsmAuthService.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: \"12.0.0\", version: \"12.0.5\", ngImport: i0, type: AsmAuthService, providedIn: 'root' });\ni0.ɵɵngDeclareClassMetadata({ minVersion: \"12.0.0\", version: \"12.0.5\", ngImport: i0, type: AsmAuthService, decorators: [{\n            type: Injectable,\n            args: [{\n                    providedIn: 'root',\n                }]\n        }], ctorParameters: function () { return [{ type: i3$1.Store }, { type: i1$1.UserIdService }, { type: i1$1.OAuthLibWrapperService }, { type: AsmAuthStorageService }, { type: i1$1.AuthRedirectService }, { type: i1$1.GlobalMessageService }, { type: i1$1.RoutingService }]; } });\n\nclass AsmRootModule {\n}\nAsmRootModule.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: \"12.0.0\", version: \"12.0.5\", ngImport: i0, type: AsmRootModule, deps: [], target: i0.ɵɵFactoryTarget.NgModule });\nAsmRootModule.ɵmod = i0.ɵɵngDeclareNgModule({ minVersion: \"12.0.0\", version: \"12.0.5\", ngImport: i0, type: AsmRootModule, imports: [AsmLoaderModule] });\nAsmRootModule.ɵinj = i0.ɵɵngDeclareInjector({ minVersion: \"12.0.0\", version: \"12.0.5\", ngImport: i0, type: AsmRootModule, providers: [\n        {\n            provide: AuthStorageService,\n            useExisting: AsmAuthStorageService,\n        },\n        {\n            provide: AuthService,\n            useExisting: AsmAuthService,\n        },\n        {\n            provide: AuthHttpHeaderService,\n            useExisting: AsmAuthHttpHeaderService,\n        },\n    ], imports: [[AsmLoaderModule]] });\ni0.ɵɵngDeclareClassMetadata({ minVersion: \"12.0.0\", version: \"12.0.5\", ngImport: i0, type: AsmRootModule, decorators: [{\n            type: NgModule,\n            args: [{\n                    imports: [AsmLoaderModule],\n                    providers: [\n                        {\n                            provide: AuthStorageService,\n                            useExisting: AsmAuthStorageService,\n                        },\n                        {\n                            provide: AuthService,\n                            useExisting: AsmAuthService,\n                        },\n                        {\n                            provide: AuthHttpHeaderService,\n                            useExisting: AsmAuthHttpHeaderService,\n                        },\n                    ],\n                }]\n        }] });\n\nconst ASM_FEATURE = 'asm';\n\n/**\n * Generated bundle index. Do not edit.\n */\n\nexport { ASM_ENABLED_LOCAL_STORAGE_KEY, ASM_FEATURE, AsmAuthHttpHeaderService, AsmAuthService, AsmAuthStorageService, AsmEnablerService, AsmLoaderModule, AsmRootModule, CsAgentAuthService, TokenTarget, asmFactory };\n//# sourceMappingURL=spartacus-asm-root.js.map\n"],"mappings":"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"},"metadata":{},"sourceType":"module"}