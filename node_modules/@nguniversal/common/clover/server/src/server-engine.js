/**
 * @license
 * Copyright Google LLC All Rights Reserved.
 *
 * Use of this source code is governed by an MIT-style license that can be
 * found in the LICENSE file at https://angular.io/license
 */
(function (factory) {
    if (typeof module === "object" && typeof module.exports === "object") {
        var v = factory(require, exports);
        if (v !== undefined) module.exports = v;
    }
    else if (typeof define === "function" && define.amd) {
        define("@nguniversal/common/clover/server/src/server-engine", ["require", "exports", "tslib", "fs", "jsdom", "path", "url", "@nguniversal/common/clover/server/src/custom-resource-loader", "@nguniversal/common/clover/server/src/inline-css-processor", "@nguniversal/common/clover/server/src/stubs"], factory);
    }
})(function (require, exports) {
    "use strict";
    Object.defineProperty(exports, "__esModule", { value: true });
    exports.Engine = void 0;
    const tslib_1 = require("tslib");
    const fs = tslib_1.__importStar(require("fs"));
    const jsdom_1 = require("jsdom");
    const path = tslib_1.__importStar(require("path"));
    const url_1 = require("url");
    const custom_resource_loader_1 = require("@nguniversal/common/clover/server/src/custom-resource-loader");
    const inline_css_processor_1 = require("@nguniversal/common/clover/server/src/inline-css-processor");
    const stubs_1 = require("@nguniversal/common/clover/server/src/stubs");
    class Engine {
        constructor() {
            this.fileExistsCache = new Map();
            this.htmlFileCache = new Map();
            this.resourceLoaderCache = new Map();
            this.inlineCriticalCssProcessor = new inline_css_processor_1.InlineCriticalCssProcessor({ minify: true }, this.resourceLoaderCache);
        }
        render(options) {
            var _a, _b, _c, _d, _e;
            return tslib_1.__awaiter(this, void 0, void 0, function* () {
                const { pathname, origin } = new url_1.URL(options.url);
                const prerenderedSnapshot = yield this.getPrerenderedSnapshot(options.publicPath, pathname);
                if (prerenderedSnapshot) {
                    return prerenderedSnapshot;
                }
                let htmlContent = yield this.getHtmlTemplate(options.publicPath, pathname, options.htmlFilename);
                const inlineCriticalCss = options.inlineCriticalCss !== false;
                const customResourceLoader = new custom_resource_loader_1.CustomResourceLoader(origin, options.publicPath, this.resourceLoaderCache);
                let dom;
                if (inlineCriticalCss) {
                    // Workaround for https://github.com/GoogleChromeLabs/critters/issues/64
                    htmlContent = htmlContent.replace(/ media=\"print\" onload=\"this\.media='all'"><noscript><link .+?><\/noscript>/g, '>');
                }
                try {
                    dom = new jsdom_1.JSDOM(htmlContent, {
                        runScripts: 'dangerously',
                        resources: customResourceLoader,
                        url: options.url,
                        referrer: (_a = options.headers) === null || _a === void 0 ? void 0 : _a.referrer,
                        userAgent: (_b = options.headers) === null || _b === void 0 ? void 0 : _b['user-agent'],
                        beforeParse: (window) => {
                            stubs_1.augmentWindowWithStubs(window);
                            window.ngRenderMode = true;
                        },
                    });
                    const doc = dom.window.document;
                    // 60s timeout.
                    const stablizationTimeout = setTimeout(() => {
                        throw new Error('Angular application failed to stablize after in time.');
                    }, 60000);
                    // tslint:disable-next-line: no-shadowed-variable
                    const ngRenderMode = yield new Promise((resolve) => {
                        const interval = setInterval(() => {
                            const ngDOMMode = dom === null || dom === void 0 ? void 0 : dom.window.ngRenderMode;
                            if (ngDOMMode && typeof ngDOMMode === 'object') {
                                // Poll until ngDOMMode is an object.
                                clearTimeout(stablizationTimeout);
                                clearInterval(interval);
                                resolve(ngDOMMode);
                            }
                        }, 30);
                    });
                    yield ngRenderMode.getWhenStable();
                    (_c = doc.querySelector('[ng-version]')) === null || _c === void 0 ? void 0 : _c.setAttribute('ng-clover', '');
                    // Add Angular state
                    const state = ngRenderMode.getSerializedState();
                    if (state) {
                        const script = doc.createElement('script');
                        script.id = `${ngRenderMode.appId}-state`;
                        script.setAttribute('type', 'application/json');
                        script.textContent = state;
                        doc.body.appendChild(script);
                    }
                    const content = dom.serialize();
                    if (!inlineCriticalCss) {
                        return content;
                    }
                    const baseHref = (_e = (_d = doc.querySelector('base[href]')) === null || _d === void 0 ? void 0 : _d.getAttribute('href')) !== null && _e !== void 0 ? _e : '';
                    const { content: contentWithInlineCSS, warnings, errors, } = yield this.inlineCriticalCssProcessor.process(content, {
                        outputPath: path.join(options.publicPath, baseHref),
                    });
                    // tslint:disable-next-line: no-console
                    warnings === null || warnings === void 0 ? void 0 : warnings.forEach((m) => console.warn(m));
                    // tslint:disable-next-line: no-console
                    errors === null || errors === void 0 ? void 0 : errors.forEach((m) => console.error(m));
                    return contentWithInlineCSS;
                }
                finally {
                    dom === null || dom === void 0 ? void 0 : dom.window.close();
                }
            });
        }
        getPrerenderedSnapshot(publicPath, pathname) {
            return tslib_1.__awaiter(this, void 0, void 0, function* () {
                // Remove leading forward slash.
                const pagePath = path.resolve(publicPath, pathname.substring(1), 'index.html');
                const content = yield this.readHTMLFile(pagePath);
                return (content === null || content === void 0 ? void 0 : content.includes('ng-version='))
                    ? content // Page is pre-rendered
                    : undefined;
            });
        }
        getHtmlTemplate(publicPath, pathname, htmlFilename = 'index.html') {
            return tslib_1.__awaiter(this, void 0, void 0, function* () {
                const files = [path.join(publicPath, htmlFilename)];
                const potentialLocalePath = pathname.split('/', 2)[1]; // potential base href
                if (potentialLocalePath) {
                    files.push(path.join(publicPath, potentialLocalePath, htmlFilename));
                }
                for (const file of files) {
                    const content = yield this.readHTMLFile(file);
                    if (content) {
                        return content;
                    }
                }
                throw new Error(`Cannot file HTML file. Looked in: ${files.join(', ')}`);
            });
        }
        fileExists(filePath) {
            return tslib_1.__awaiter(this, void 0, void 0, function* () {
                const fileExists = this.fileExistsCache.get(filePath);
                if (fileExists === undefined) {
                    try {
                        yield fs.promises.access(filePath, fs.constants.F_OK);
                        this.fileExistsCache.set(filePath, true);
                        return true;
                    }
                    catch (_a) {
                        this.fileExistsCache.set(filePath, false);
                        return false;
                    }
                }
                return fileExists;
            });
        }
        readHTMLFile(filePath) {
            return tslib_1.__awaiter(this, void 0, void 0, function* () {
                if (this.htmlFileCache.has(filePath)) {
                    return this.htmlFileCache.get(filePath);
                }
                if (yield this.fileExists(filePath)) {
                    const content = yield fs.promises.readFile(filePath, 'utf-8');
                    this.htmlFileCache.set(filePath, content);
                    return content;
                }
                return undefined;
            });
        }
    }
    exports.Engine = Engine;
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2VydmVyLWVuZ2luZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uLy4uLy4uL21vZHVsZXMvY29tbW9uL2Nsb3Zlci9zZXJ2ZXIvc3JjL3NlcnZlci1lbmdpbmUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7OztHQU1HOzs7Ozs7Ozs7Ozs7OztJQU1ILCtDQUF5QjtJQUN6QixpQ0FBOEI7SUFDOUIsbURBQTZCO0lBQzdCLDZCQUEwQjtJQUMxQix5R0FBZ0U7SUFDaEUscUdBQW9FO0lBQ3BFLHVFQUFpRDtJQVVqRCxNQUFhLE1BQU07UUFBbkI7WUFDbUIsb0JBQWUsR0FBRyxJQUFJLEdBQUcsRUFBbUIsQ0FBQztZQUM3QyxrQkFBYSxHQUFHLElBQUksR0FBRyxFQUFrQixDQUFDO1lBQzFDLHdCQUFtQixHQUFHLElBQUksR0FBRyxFQUFrQixDQUFDO1lBQ2hELCtCQUEwQixHQUFHLElBQUksaURBQTBCLENBQzFFLEVBQUUsTUFBTSxFQUFFLElBQUksRUFBRSxFQUNoQixJQUFJLENBQUMsbUJBQW1CLENBQ3pCLENBQUM7UUEyS0osQ0FBQztRQXpLTyxNQUFNLENBQUMsT0FBc0I7OztnQkFDakMsTUFBTSxFQUFFLFFBQVEsRUFBRSxNQUFNLEVBQUUsR0FBRyxJQUFJLFNBQUcsQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLENBQUM7Z0JBQ2xELE1BQU0sbUJBQW1CLEdBQUcsTUFBTSxJQUFJLENBQUMsc0JBQXNCLENBQUMsT0FBTyxDQUFDLFVBQVUsRUFBRSxRQUFRLENBQUMsQ0FBQztnQkFFNUYsSUFBSSxtQkFBbUIsRUFBRTtvQkFDdkIsT0FBTyxtQkFBbUIsQ0FBQztpQkFDNUI7Z0JBRUQsSUFBSSxXQUFXLEdBQUcsTUFBTSxJQUFJLENBQUMsZUFBZSxDQUMxQyxPQUFPLENBQUMsVUFBVSxFQUNsQixRQUFRLEVBQ1IsT0FBTyxDQUFDLFlBQVksQ0FDckIsQ0FBQztnQkFDRixNQUFNLGlCQUFpQixHQUFH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QUUsRUFBRSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsQ0FBQzt3QkFDdEQsSUFBSSxDQUFDLGVBQWUsQ0FBQyxHQUFHLENBQUMsUUFBUSxFQUFFLElBQUksQ0FBQyxDQUFDO3dCQUV6QyxPQUFPLElBQUksQ0FBQztxQkFDYjtvQkFBQyxXQUFNO3dCQUNOLElBQUksQ0FBQyxlQUFlLENBQUMsR0FBRyxDQUFDLFFBQVEsRUFBRSxLQUFLLENBQUMsQ0FBQzt3QkFFMUMsT0FBTyxLQUFLLENBQUM7cUJBQ2Q7aUJBQ0Y7Z0JBRUQsT0FBTyxVQUFVLENBQUM7WUFDcEIsQ0FBQztTQUFBO1FBRWEsWUFBWSxDQUFDLFFBQWdCOztnQkFDekMsSUFBSSxJQUFJLENBQUMsYUFBYSxDQUFDLEdBQUcsQ0FBQyxRQUFRLENBQUMsRUFBRTtvQkFDcEMsT0FBTyxJQUFJLENBQUMsYUFBYSxDQUFDLEdBQUcsQ0FBQyxRQUFRLENBQUMsQ0FBQztpQkFDekM7Z0JBRUQsSUFBSSxNQUFNLElBQUksQ0FBQyxVQUFVLENBQUMsUUFBUSxDQUFDLEVBQUU7b0JBQ25DLE1BQU0sT0FBTyxHQUFHLE1BQU0sRUFBRSxDQUFDLFFBQVEsQ0FBQyxRQUFRLENBQUMsUUFBUSxFQUFFLE9BQU8sQ0FBQyxDQUFDO29CQUM5RCxJQUFJLENBQUMsYUFBYSxDQUFDLEdBQUcsQ0FBQyxRQUFRLEVBQUUsT0FBTyxDQUFDLENBQUM7b0JBRTFDLE9BQU8sT0FBTyxDQUFDO2lCQUNoQjtnQkFFRCxPQUFPLFNBQVMsQ0FBQztZQUNuQixDQUFDO1NBQUE7S0FDRjtJQWxMRCx3QkFrTEMiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIEBsaWNlbnNlXG4gKiBDb3B5cmlnaHQgR29vZ2xlIExMQyBBbGwgUmlnaHRzIFJlc2VydmVkLlxuICpcbiAqIFVzZSBvZiB0aGlzIHNvdXJjZSBjb2RlIGlzIGdvdmVybmVkIGJ5IGFuIE1JVC1zdHlsZSBsaWNlbnNlIHRoYXQgY2FuIGJlXG4gKiBmb3VuZCBpbiB0aGUgTElDRU5TRSBmaWxlIGF0IGh0dHBzOi8vYW5ndWxhci5pby9saWNlbnNlXG4gKi9cblxuaW1wb3J0IHtcbiAgybVOR1JlbmRlck1vZGUgYXMgTkdSZW5kZXJNb2RlLFxuICDJtU5HUmVuZGVyTW9kZUFQSSBhcyBOR1JlbmRlck1vZGVBUEksXG59IGZyb20gJ0BuZ3VuaXZlcnNhbC9jb21tb24vY2xvdmVyJztcbmltcG9ydCAqIGFzIGZzIGZyb20gJ2ZzJztcbmltcG9ydCB7IEpTRE9NIH0gZnJvbSAnanNkb20nO1xuaW1wb3J0ICogYXMgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCB7IFVSTCB9IGZyb20gJ3VybCc7XG5pbXBvcnQgeyBDdXN0b21SZXNvdXJjZUxvYWRlciB9IGZyb20gJy4vY3VzdG9tLXJlc291cmNlLWxvYWRlcic7XG5pbXBvcnQgeyBJbmxpbmVDcml0aWNhbENzc1Byb2Nlc3NvciB9IGZyb20gJy4vaW5saW5lLWNzcy1wcm9jZXNzb3InO1xuaW1wb3J0IHsgYXVnbWVudFdpbmRvd1dpdGhTdHVicyB9IGZyb20gJy4vc3R1YnMnO1xuXG5leHBvcnQgaW50ZXJmYWNlIFJlbmRlck9wdGlvbnMge1xuICBoZWFkZXJzPzogUmVjb3JkPHN0cmluZywgc3RyaW5nIHwgdW5kZWZpbmVkIHwgc3RyaW5nW10+O1xuICB1cmw6IHN0cmluZztcbiAgaW5saW5lQ3JpdGljYWxDc3M/OiBib29sZWFuO1xuICBodG1sRmlsZW5hbWU/OiBzdHJpbmc7XG4gIHB1YmxpY1BhdGg6IHN0cmluZztcbn1cblxuZXhwb3J0IGNsYXNzIEVuZ2luZSB7XG4gIHByaXZhdGUgcmVhZG9ubHkgZmlsZUV4aXN0c0NhY2hlID0gbmV3IE1hcDxzdHJpbmcsIGJvb2xlYW4+KCk7XG4gIHByaXZhdGUgcmVhZG9ubHkgaHRtbEZpbGVDYWNoZSA9IG5ldyBNYXA8c3RyaW5nLCBzdHJpbmc+KCk7XG4gIHByaXZhdGUgcmVhZG9ubHkgcmVzb3VyY2VMb2FkZXJDYWNoZSA9IG5ldyBNYXA8c3RyaW5nLCBCdWZmZXI+KCk7XG4gIHByaXZhdGUgcmVhZG9ubHkgaW5saW5lQ3JpdGljYWxDc3NQcm9jZXNzb3IgPSBuZXcgSW5saW5lQ3JpdGljYWxDc3NQcm9jZXNzb3IoXG4gICAgeyBtaW5pZnk6IHRydWUgfSxcbiAgICB0aGlzLnJlc291cmNlTG9hZGVyQ2FjaGUsXG4gICk7XG5cbiAgYXN5bmMgcmVuZGVyKG9wdGlvbnM6IFJlbmRlck9wdGlvbnMpOiBQcm9taXNlPHN0cmluZz4ge1xuICAgIGNvbnN0IHsgcGF0aG5hbWUsIG9yaWdpbiB9ID0gbmV3IFVSTChvcHRpb25zLnVybCk7XG4gICAgY29uc3QgcHJlcmVuZGVyZWRTbmFwc2hvdCA9IGF3YWl0IHRoaXMuZ2V0UHJlcmVuZGVyZWRTbmFwc2hvdChvcHRpb25zLnB1YmxpY1BhdGgsIHBhdGhuYW1lKTtcblxuICAgIGlmIChwcmVyZW5kZXJlZFNuYXBzaG90KSB7XG4gICAgICByZXR1cm4gcHJlcmVuZGVyZWRTbmFwc2hvdDtcbiAgICB9XG5cbiAgICBsZXQgaHRtbENvbnRlbnQgPSBhd2FpdCB0aGlzLmdldEh0bWxUZW1wbGF0ZShcbiAgICAgIG9wdGlvbnMucHVibGljUGF0aCxcbiAgICAgIHBhdGhuYW1lLFxuICAgICAgb3B0aW9ucy5odG1sRmlsZW5hbWUsXG4gICAgKTtcbiAgICBjb25zdCBpbmxpbmVDcml0aWNhbENzcyA9IG9wdGlvbnMuaW5saW5lQ3JpdGljYWxDc3MgIT09IGZhbHNlO1xuXG4gICAgY29uc3QgY3VzdG9tUmVzb3VyY2VMb2FkZXIgPSBuZXcgQ3VzdG9tUmVzb3VyY2VMb2FkZXIoXG4gICAgICBvcmlnaW4sXG4gICAgICBvcHRpb25zLnB1YmxpY1BhdGgsXG4gICAgICB0aGlzLnJlc291cmNlTG9hZGVyQ2FjaGUsXG4gICAgKTtcblxuICAgIGxldCBkb206IEpTRE9NIHwgdW5kZWZpbmVkO1xuXG4gICAgaWYgKGlubGluZUNyaXRpY2FsQ3NzKSB7XG4gICAgICAvLyBXb3JrYXJvdW5kIGZvciBodHRwczovL2dpdGh1Yi5jb20vR29vZ2xlQ2hyb21lTGFicy9jcml0dGVycy9pc3N1ZXMvNjRcbiAgICAgIGh0bWxDb250ZW50ID0gaHRtbENvbnRlbnQucmVwbGFjZShcbiAgICAgICAgLyBtZWRpYT1cXFwicHJpbnRcXFwiIG9ubG9hZD1cXFwidGhpc1xcLm1lZGlhPSdhbGwnXCI+PG5vc2NyaXB0PjxsaW5rIC4rPz48XFwvbm9zY3JpcHQ+L2csXG4gICAgICAgICc+JyxcbiAgICAgICk7XG4gICAgfVxuXG4gICAgdHJ5IHtcbiAgICAgIGRvbSA9IG5ldyBKU0RPTShodG1sQ29udGVudCwge1xuICAgICAgICBydW5TY3JpcHRzOiAnZGFuZ2Vyb3VzbHknLFxuICAgICAgICByZXNvdXJjZXM6IGN1c3RvbVJlc291cmNlTG9hZGVyLFxuICAgICAgICB1cmw6IG9wdGlvbnMudXJsLFxuICAgICAgICByZWZlcnJlcjogb3B0aW9ucy5oZWFkZXJzPy5yZWZlcnJlciBhcyBzdHJpbmcgfCB1bmRlZmluZWQsXG4gICAgICAgIHVzZXJBZ2VudDogb3B0aW9ucy5oZWFkZXJzPy5bJ3VzZXItYWdlbnQnXSBhcyBzdHJpbmcgfCB1bmRlZmluZWQsXG4gICAgICAgIGJlZm9yZVBhcnNlOiAod2luZG93KSA9PiB7XG4gICAgICAgICAgYXVnbWVudFdpbmRvd1dpdGhTdHVicyh3aW5kb3cpO1xuICAgICAgICAgIHdpbmRvdy5uZ1JlbmRlck1vZGUgPSB0cnVlO1xuICAgICAgICB9LFxuICAgICAgfSk7XG5cbiAgICAgIGNvbnN0IGRvYyA9IGRvbS53aW5kb3cuZG9jdW1lbnQ7XG5cbiAgICAgIC8vIDYwcyB0aW1lb3V0LlxuICAgICAgY29uc3Qgc3RhYmxpemF0aW9uVGltZW91dCA9IHNldFRpbWVvdXQoKCkgPT4ge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0FuZ3VsYXIgYXBwbGljYXRpb24gZmFpbGVkIHRvIHN0YWJsaXplIGFmdGVyIGluIHRpbWUuJyk7XG4gICAgICB9LCA2MDAwMCk7XG5cbiAgICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTogbm8tc2hhZG93ZWQtdmFyaWFibGVcbiAgICAgIGNvbnN0IG5nUmVuZGVyTW9kZSA9IGF3YWl0IG5ldyBQcm9taXNlPE5HUmVuZGVyTW9kZUFQST4oKHJlc29sdmUpID0+IHtcbiAgICAgICAgY29uc3QgaW50ZXJ2YWwgPSBzZXRJbnRlcnZhbCgoKSA9PiB7XG4gICAgICAgICAgY29uc3QgbmdET01Nb2RlID0gZG9tPy53aW5kb3cubmdSZW5kZXJNb2RlIGFzIE5HUmVuZGVyTW9kZTtcbiAgICAgICAgICBpZiAobmdET01Nb2RlICYmIHR5cGVvZiBuZ0RPTU1vZGUgPT09ICdvYmplY3QnKSB7XG4gICAgICAgICAgICAvLyBQb2xsIHVudGlsIG5nRE9NTW9kZSBpcyBhbiBvYmplY3QuXG4gICAgICAgICAgICBjbGVhclRpbWVvdXQoc3RhYmxpemF0aW9uVGltZW91dCk7XG4gICAgICAgICAgICBjbGVhckludGVydmFsKGludGVydmFsKTtcbiAgICAgICAgICAgIHJlc29sdmUobmdET01Nb2RlKTtcbiAgICAgICAgICB9XG4gICAgICAgIH0sIDMwKTtcbiAgICAgIH0pO1xuXG4gICAgICBhd2FpdCBuZ1JlbmRlck1vZGUuZ2V0V2hlblN0YWJsZSgpO1xuICAgICAgZG9jLnF1ZXJ5U2VsZWN0b3IoJ1tuZy12ZXJzaW9uXScpPy5zZXRBdHRyaWJ1dGUoJ25nLWNsb3ZlcicsICcnKTtcblxuICAgICAgLy8gQWRkIEFuZ3VsYXIgc3RhdGVcbiAgICAgIGNvbnN0IHN0YXRlID0gbmdSZW5kZXJNb2RlLmdldFNlcmlhbGl6ZWRTdGF0ZSgpO1xuICAgICAgaWYgKHN0YXRlKSB7XG4gICAgICAgIGNvbnN0IHNjcmlwdCA9IGRvYy5jcmVhdGVFbGVtZW50KCdzY3JpcHQnKTtcbiAgICAgICAgc2NyaXB0LmlkID0gYCR7bmdSZW5kZXJNb2RlLmFwcElkfS1zdGF0ZWA7XG4gICAgICAgIHNjcmlwdC5zZXRBdHRyaWJ1dGUoJ3R5cGUnLCAnYXBwbGljYXRpb24vanNvbicpO1xuICAgICAgICBzY3JpcHQudGV4dENvbnRlbnQgPSBzdGF0ZTtcbiAgICAgICAgZG9jLmJvZHkuYXBwZW5kQ2hpbGQoc2NyaXB0KTtcbiAgICAgIH1cblxuICAgICAgY29uc3QgY29udGVudCA9IGRvbS5zZXJpYWxpemUoKTtcbiAgICAgIGlmICghaW5saW5lQ3JpdGljYWxDc3MpIHtcbiAgICAgICAgcmV0dXJuIGNvbnRlbnQ7XG4gICAgICB9XG5cbiAgICAgIGNvbnN0IGJhc2VIcmVmID0gZG9jLnF1ZXJ5U2VsZWN0b3IoJ2Jhc2VbaHJlZl0nKT8uZ2V0QXR0cmlidXRlKCdocmVmJykgPz8gJyc7XG4gICAgICBjb25zdCB7XG4gICAgICAgIGNvbnRlbnQ6IGNvbnRlbnRXaXRoSW5saW5lQ1NTLFxuICAgICAgICB3YXJuaW5ncyxcbiAgICAgICAgZXJyb3JzLFxuICAgICAgfSA9IGF3YWl0IHRoaXMuaW5saW5lQ3JpdGljYWxDc3NQcm9jZXNzb3IucHJvY2Vzcyhjb250ZW50LCB7XG4gICAgICAgIG91dHB1dFBhdGg6IHBhdGguam9pbihvcHRpb25zLnB1YmxpY1BhdGgsIGJhc2VIcmVmKSxcbiAgICAgIH0pO1xuXG4gICAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6IG5vLWNvbnNvbGVcbiAgICAgIHdhcm5pbmdzPy5mb3JFYWNoKChtKSA9PiBjb25zb2xlLndhcm4obSkpO1xuICAgICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOiBuby1jb25zb2xlXG4gICAgICBlcnJvcnM/LmZvckVhY2goKG0pID0+IGNvbnNvbGUuZXJyb3IobSkpO1xuXG4gICAgICByZXR1cm4gY29udGVudFdpdGhJbmxpbmVDU1M7XG4gICAgfSBmaW5hbGx5IHtcbiAgICAgIGRvbT8ud2luZG93LmNsb3NlKCk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyBnZXRQcmVyZW5kZXJlZFNuYXBzaG90KFxuICAgIHB1YmxpY1BhdGg6IHN0cmluZyxcbiAgICBwYXRobmFtZTogc3RyaW5nLFxuICApOiBQcm9taXNlPHN0cmluZyB8IHVuZGVmaW5lZD4ge1xuICAgIC8vIFJlbW92ZSBsZWFkaW5nIGZvcndhcmQgc2xhc2guXG4gICAgY29uc3QgcGFnZVBhdGggPSBwYXRoLnJlc29sdmUocHVibGljUGF0aCwgcGF0aG5hbWUuc3Vic3RyaW5nKDEpLCAnaW5kZXguaHRtbCcpO1xuICAgIGNvbnN0IGNvbnRlbnQgPSBhd2FpdCB0aGlzLnJlYWRIVE1MRmlsZShwYWdlUGF0aCk7XG5cbiAgICByZXR1cm4gY29udGVudD8uaW5jbHVkZXMoJ25nLXZlcnNpb249JylcbiAgICAgID8gY29udGVudCAvLyBQYWdlIGlzIHByZS1yZW5kZXJlZFxuICAgICAgOiB1bmRlZmluZWQ7XG4gIH1cblxuICBwcml2YXRlIGFzeW5jIGdldEh0bWxUZW1wbGF0ZShcbiAgICBwdWJsaWNQYXRoOiBzdHJpbmcsXG4gICAgcGF0aG5hbWU6IHN0cmluZyxcbiAgICBodG1sRmlsZW5hbWUgPSAnaW5kZXguaHRtbCcsXG4gICk6IFByb21pc2U8c3RyaW5nPiB7XG4gICAgY29uc3QgZmlsZXMgPSBbcGF0aC5qb2luKHB1YmxpY1BhdGgsIGh0bWxGaWxlbmFtZSldO1xuXG4gICAgY29uc3QgcG90ZW50aWFsTG9jYWxlUGF0aCA9IHBhdGhuYW1lLnNwbGl0KCcvJywgMilbMV07IC8vIHBvdGVudGlhbCBiYXNlIGhyZWZcbiAgICBpZiAocG90ZW50aWFsTG9jYWxlUGF0aCkge1xuICAgICAgZmlsZXMucHVzaChwYXRoLmpvaW4ocHVibGljUGF0aCwgcG90ZW50aWFsTG9jYWxlUGF0aCwgaHRtbEZpbGVuYW1lKSk7XG4gICAgfVxuXG4gICAgZm9yIChjb25zdCBmaWxlIG9mIGZpbGVzKSB7XG4gICAgICBjb25zdCBjb250ZW50ID0gYXdhaXQgdGhpcy5yZWFkSFRNTEZpbGUoZmlsZSk7XG4gICAgICBpZiAoY29udGVudCkge1xuICAgICAgICByZXR1cm4gY29udGVudDtcbiAgICAgIH1cbiAgICB9XG5cbiAgICB0aHJvdyBuZXcgRXJyb3IoYENhbm5vdCBmaWxlIEhUTUwgZmlsZS4gTG9va2VkIGluOiAke2ZpbGVzLmpvaW4oJywgJyl9YCk7XG4gIH1cblxuICBwcml2YXRlIGFzeW5jIGZpbGVFeGlzdHMoZmlsZVBhdGg6IHN0cmluZyk6IFByb21pc2U8Ym9vbGVhbj4ge1xuICAgIGNvbnN0IGZpbGVFeGlzdHMgPSB0aGlzLmZpbGVFeGlzdHNDYWNoZS5nZXQoZmlsZVBhdGgpO1xuICAgIGlmIChmaWxlRXhpc3RzID09PSB1bmRlZmluZWQpIHtcbiAgICAgIHRyeSB7XG4gICAgICAgIGF3YWl0IGZzLnByb21pc2VzLmFjY2VzcyhmaWxlUGF0aCwgZnMuY29uc3RhbnRzLkZfT0spO1xuICAgICAgICB0aGlzLmZpbGVFeGlzdHNDYWNoZS5zZXQoZmlsZVBhdGgsIHRydWUpO1xuXG4gICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgfSBjYXRjaCB7XG4gICAgICAgIHRoaXMuZmlsZUV4aXN0c0NhY2hlLnNldChmaWxlUGF0aCwgZmFsc2UpO1xuXG4gICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICByZXR1cm4gZmlsZUV4aXN0cztcbiAgfVxuXG4gIHByaXZhdGUgYXN5bmMgcmVhZEhUTUxGaWxlKGZpbGVQYXRoOiBzdHJpbmcpOiBQcm9taXNlPHN0cmluZyB8IHVuZGVmaW5lZD4ge1xuICAgIGlmICh0aGlzLmh0bWxGaWxlQ2FjaGUuaGFzKGZpbGVQYXRoKSkge1xuICAgICAgcmV0dXJuIHRoaXMuaHRtbEZpbGVDYWNoZS5nZXQoZmlsZVBhdGgpO1xuICAgIH1cblxuICAgIGlmIChhd2FpdCB0aGlzLmZpbGVFeGlzdHMoZmlsZVBhdGgpKSB7XG4gICAgICBjb25zdCBjb250ZW50ID0gYXdhaXQgZnMucHJvbWlzZXMucmVhZEZpbGUoZmlsZVBhdGgsICd1dGYtOCcpO1xuICAgICAgdGhpcy5odG1sRmlsZUNhY2hlLnNldChmaWxlUGF0aCwgY29udGVudCk7XG5cbiAgICAgIHJldHVybiBjb250ZW50O1xuICAgIH1cblxuICAgIHJldHVybiB1bmRlZmluZWQ7XG4gIH1cbn1cbiJdfQ==