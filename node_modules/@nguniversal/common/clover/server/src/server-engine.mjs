/**
 * @license
 * Copyright Google LLC All Rights Reserved.
 *
 * Use of this source code is governed by an MIT-style license that can be
 * found in the LICENSE file at https://angular.io/license
 */
import { __awaiter } from "tslib";
import * as fs from 'fs';
import { JSDOM } from 'jsdom';
import * as path from 'path';
import { URL } from 'url';
import { CustomResourceLoader } from './custom-resource-loader';
import { InlineCriticalCssProcessor } from './inline-css-processor';
import { augmentWindowWithStubs } from './stubs';
export class Engine {
    constructor() {
        this.fileExistsCache = new Map();
        this.htmlFileCache = new Map();
        this.resourceLoaderCache = new Map();
        this.inlineCriticalCssProcessor = new InlineCriticalCssProcessor({ minify: true }, this.resourceLoaderCache);
    }
    render(options) {
        var _a, _b, _c, _d, _e;
        return __awaiter(this, void 0, void 0, function* () {
            const { pathname, origin } = new URL(options.url);
            const prerenderedSnapshot = yield this.getPrerenderedSnapshot(options.publicPath, pathname);
            if (prerenderedSnapshot) {
                return prerenderedSnapshot;
            }
            let htmlContent = yield this.getHtmlTemplate(options.publicPath, pathname, options.htmlFilename);
            const inlineCriticalCss = options.inlineCriticalCss !== false;
            const customResourceLoader = new CustomResourceLoader(origin, options.publicPath, this.resourceLoaderCache);
            let dom;
            if (inlineCriticalCss) {
                // Workaround for https://github.com/GoogleChromeLabs/critters/issues/64
                htmlContent = htmlContent.replace(/ media=\"print\" onload=\"this\.media='all'"><noscript><link .+?><\/noscript>/g, '>');
            }
            try {
                dom = new JSDOM(htmlContent, {
                    runScripts: 'dangerously',
                    resources: customResourceLoader,
                    url: options.url,
                    referrer: (_a = options.headers) === null || _a === void 0 ? void 0 : _a.referrer,
                    userAgent: (_b = options.headers) === null || _b === void 0 ? void 0 : _b['user-agent'],
                    beforeParse: (window) => {
                        augmentWindowWithStubs(window);
                        window.ngRenderMode = true;
                    },
                });
                const doc = dom.window.document;
                // 60s timeout.
                const stablizationTimeout = setTimeout(() => {
                    throw new Error('Angular application failed to stablize after in time.');
                }, 60000);
                // tslint:disable-next-line: no-shadowed-variable
                const ngRenderMode = yield new Promise((resolve) => {
                    const interval = setInterval(() => {
                        const ngDOMMode = dom === null || dom === void 0 ? void 0 : dom.window.ngRenderMode;
                        if (ngDOMMode && typeof ngDOMMode === 'object') {
                            // Poll until ngDOMMode is an object.
                            clearTimeout(stablizationTimeout);
                            clearInterval(interval);
                            resolve(ngDOMMode);
                        }
                    }, 30);
                });
                yield ngRenderMode.getWhenStable();
                (_c = doc.querySelector('[ng-version]')) === null || _c === void 0 ? void 0 : _c.setAttribute('ng-clover', '');
                // Add Angular state
                const state = ngRenderMode.getSerializedState();
                if (state) {
                    const script = doc.createElement('script');
                    script.id = `${ngRenderMode.appId}-state`;
                    script.setAttribute('type', 'application/json');
                    script.textContent = state;
                    doc.body.appendChild(script);
                }
                const content = dom.serialize();
                if (!inlineCriticalCss) {
                    return content;
                }
                const baseHref = (_e = (_d = doc.querySelector('base[href]')) === null || _d === void 0 ? void 0 : _d.getAttribute('href')) !== null && _e !== void 0 ? _e : '';
                const { content: contentWithInlineCSS, warnings, errors, } = yield this.inlineCriticalCssProcessor.process(content, {
                    outputPath: path.join(options.publicPath, baseHref),
                });
                // tslint:disable-next-line: no-console
                warnings === null || warnings === void 0 ? void 0 : warnings.forEach((m) => console.warn(m));
                // tslint:disable-next-line: no-console
                errors === null || errors === void 0 ? void 0 : errors.forEach((m) => console.error(m));
                return contentWithInlineCSS;
            }
            finally {
                dom === null || dom === void 0 ? void 0 : dom.window.close();
            }
        });
    }
    getPrerenderedSnapshot(publicPath, pathname) {
        return __awaiter(this, void 0, void 0, function* () {
            // Remove leading forward slash.
            const pagePath = path.resolve(publicPath, pathname.substring(1), 'index.html');
            const content = yield this.readHTMLFile(pagePath);
            return (content === null || content === void 0 ? void 0 : content.includes('ng-version='))
                ? content // Page is pre-rendered
                : undefined;
        });
    }
    getHtmlTemplate(publicPath, pathname, htmlFilename = 'index.html') {
        return __awaiter(this, void 0, void 0, function* () {
            const files = [path.join(publicPath, htmlFilename)];
            const potentialLocalePath = pathname.split('/', 2)[1]; // potential base href
            if (potentialLocalePath) {
                files.push(path.join(publicPath, potentialLocalePath, htmlFilename));
            }
            for (const file of files) {
                const content = yield this.readHTMLFile(file);
                if (content) {
                    return content;
                }
            }
            throw new Error(`Cannot file HTML file. Looked in: ${files.join(', ')}`);
        });
    }
    fileExists(filePath) {
        return __awaiter(this, void 0, void 0, function* () {
            const fileExists = this.fileExistsCache.get(filePath);
            if (fileExists === undefined) {
                try {
                    yield fs.promises.access(filePath, fs.constants.F_OK);
                    this.fileExistsCache.set(filePath, true);
                    return true;
                }
                catch (_a) {
                    this.fileExistsCache.set(filePath, false);
                    return false;
                }
            }
            return fileExists;
        });
    }
    readHTMLFile(filePath) {
        return __awaiter(this, void 0, void 0, function* () {
            if (this.htmlFileCache.has(filePath)) {
                return this.htmlFileCache.get(filePath);
            }
            if (yield this.fileExists(filePath)) {
                const content = yield fs.promises.readFile(filePath, 'utf-8');
                this.htmlFileCache.set(filePath, content);
                return content;
            }
            return undefined;
        });
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2VydmVyLWVuZ2luZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uLy4uLy4uL21vZHVsZXMvY29tbW9uL2Nsb3Zlci9zZXJ2ZXIvc3JjL3NlcnZlci1lbmdpbmUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7OztHQU1HOztBQU1ILE9BQU8sS0FBSyxFQUFFLE1BQU0sSUFBSSxDQUFDO0FBQ3pCLE9BQU8sRUFBRSxLQUFLLEVBQUUsTUFBTSxPQUFPLENBQUM7QUFDOUIsT0FBTyxLQUFLLElBQUksTUFBTSxNQUFNLENBQUM7QUFDN0IsT0FBTyxFQUFFLEdBQUcsRUFBRSxNQUFNLEtBQUssQ0FBQztBQUMxQixPQUFPLEVBQUUsb0JBQW9CLEVBQUUsTUFBTSwwQkFBMEIsQ0FBQztBQUNoRSxPQUFPLEVBQUUsMEJBQTBCLEVBQUUsTUFBTSx3QkFBd0IsQ0FBQztBQUNwRSxPQUFPLEVBQUUsc0JBQXNCLEVBQUUsTUFBTSxTQUFTLENBQUM7QUFVakQsTUFBTSxPQUFPLE1BQU07SUFBbkI7UUFDbUIsb0JBQWUsR0FBRyxJQUFJLEdBQUcsRUFBbUIsQ0FBQztRQUM3QyxrQkFBYSxHQUFHLElBQUksR0FBRyxFQUFrQixDQUFDO1FBQzFDLHdCQUFtQixHQUFHLElBQUksR0FBRyxFQUFrQixDQUFDO1FBQ2hELCtCQUEwQixHQUFHLElBQUksMEJBQTBCLENBQzFFLEVBQUUsTUFBTSxFQUFFLElBQUksRUFBRSxFQUNoQixJQUFJLENBQUMsbUJBQW1CLENBQ3pCLENBQUM7SUEyS0osQ0FBQztJQXpLTyxNQUFNLENBQUMsT0FBc0I7OztZQUNqQyxNQUFNLEVBQUUsUUFBUSxFQUFFLE1BQU0sRUFBRSxHQUFHLElBQUksR0FBRyxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsQ0FBQztZQUNsRCxNQUFNLG1CQUFtQixHQUFHLE1BQU0sSUFBSSxDQUFDLHNCQUFzQixDQUFDLE9BQU8sQ0FBQyxVQUFVLEVBQUUsUUFBUSxDQUFD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bCBSaWdodHMgUmVzZXJ2ZWQuXG4gKlxuICogVXNlIG9mIHRoaXMgc291cmNlIGNvZGUgaXMgZ292ZXJuZWQgYnkgYW4gTUlULXN0eWxlIGxpY2Vuc2UgdGhhdCBjYW4gYmVcbiAqIGZvdW5kIGluIHRoZSBMSUNFTlNFIGZpbGUgYXQgaHR0cHM6Ly9hbmd1bGFyLmlvL2xpY2Vuc2VcbiAqL1xuXG5pbXBvcnQge1xuICDJtU5HUmVuZGVyTW9kZSBhcyBOR1JlbmRlck1vZGUsXG4gIMm1TkdSZW5kZXJNb2RlQVBJIGFzIE5HUmVuZGVyTW9kZUFQSSxcbn0gZnJvbSAnQG5ndW5pdmVyc2FsL2NvbW1vbi9jbG92ZXInO1xuaW1wb3J0ICogYXMgZnMgZnJvbSAnZnMnO1xuaW1wb3J0IHsgSlNET00gfSBmcm9tICdqc2RvbSc7XG5pbXBvcnQgKiBhcyBwYXRoIGZyb20gJ3BhdGgnO1xuaW1wb3J0IHsgVVJMIH0gZnJvbSAndXJsJztcbmltcG9ydCB7IEN1c3RvbVJlc291cmNlTG9hZGVyIH0gZnJvbSAnLi9jdXN0b20tcmVzb3VyY2UtbG9hZGVyJztcbmltcG9ydCB7IElubGluZUNyaXRpY2FsQ3NzUHJvY2Vzc29yIH0gZnJvbSAnLi9pbmxpbmUtY3NzLXByb2Nlc3Nvcic7XG5pbXBvcnQgeyBhdWdtZW50V2luZG93V2l0aFN0dWJzIH0gZnJvbSAnLi9zdHVicyc7XG5cbmV4cG9ydCBpbnRlcmZhY2UgUmVuZGVyT3B0aW9ucyB7XG4gIGhlYWRlcnM/OiBSZWNvcmQ8c3RyaW5nLCBzdHJpbmcgfCB1bmRlZmluZWQgfCBzdHJpbmdbXT47XG4gIHVybDogc3RyaW5nO1xuICBpbmxpbmVDcml0aWNhbENzcz86IGJvb2xlYW47XG4gIGh0bWxGaWxlbmFtZT86IHN0cmluZztcbiAgcHVibGljUGF0aDogc3RyaW5nO1xufVxuXG5leHBvcnQgY2xhc3MgRW5naW5lIHtcbiAgcHJpdmF0ZSByZWFkb25seSBmaWxlRXhpc3RzQ2FjaGUgPSBuZXcgTWFwPHN0cmluZywgYm9vbGVhbj4oKTtcbiAgcHJpdmF0ZSByZWFkb25seSBodG1sRmlsZUNhY2hlID0gbmV3IE1hcDxzdHJpbmcsIHN0cmluZz4oKTtcbiAgcHJpdmF0ZSByZWFkb25seSByZXNvdXJjZUxvYWRlckNhY2hlID0gbmV3IE1hcDxzdHJpbmcsIEJ1ZmZlcj4oKTtcbiAgcHJpdmF0ZSByZWFkb25seSBpbmxpbmVDcml0aWNhbENzc1Byb2Nlc3NvciA9IG5ldyBJbmxpbmVDcml0aWNhbENzc1Byb2Nlc3NvcihcbiAgICB7IG1pbmlmeTogdHJ1ZSB9LFxuICAgIHRoaXMucmVzb3VyY2VMb2FkZXJDYWNoZSxcbiAgKTtcblxuICBhc3luYyByZW5kZXIob3B0aW9uczogUmVuZGVyT3B0aW9ucyk6IFByb21pc2U8c3RyaW5nPiB7XG4gICAgY29uc3QgeyBwYXRobmFtZSwgb3JpZ2luIH0gPSBuZXcgVVJMKG9wdGlvbnMudXJsKTtcbiAgICBjb25zdCBwcmVyZW5kZXJlZFNuYXBzaG90ID0gYXdhaXQgdGhpcy5nZXRQcmVyZW5kZXJlZFNuYXBzaG90KG9wdGlvbnMucHVibGljUGF0aCwgcGF0aG5hbWUpO1xuXG4gICAgaWYgKHByZXJlbmRlcmVkU25hcHNob3QpIHtcbiAgICAgIHJldHVybiBwcmVyZW5kZXJlZFNuYXBzaG90O1xuICAgIH1cblxuICAgIGxldCBodG1sQ29udGVudCA9IGF3YWl0IHRoaXMuZ2V0SHRtbFRlbXBsYXRlKFxuICAgICAgb3B0aW9ucy5wdWJsaWNQYXRoLFxuICAgICAgcGF0aG5hbWUsXG4gICAgICBvcHRpb25zLmh0bWxGaWxlbmFtZSxcbiAgICApO1xuICAgIGNvbnN0IGlubGluZUNyaXRpY2FsQ3NzID0gb3B0aW9ucy5pbmxpbmVDcml0aWNhbENzcyAhPT0gZmFsc2U7XG5cbiAgICBjb25zdCBjdXN0b21SZXNvdXJjZUxvYWRlciA9IG5ldyBDdXN0b21SZXNvdXJjZUxvYWRlcihcbiAgICAgIG9yaWdpbixcbiAgICAgIG9wdGlvbnMucHVibGljUGF0aCxcbiAgICAgIHRoaXMucmVzb3VyY2VMb2FkZXJDYWNoZSxcbiAgICApO1xuXG4gICAgbGV0IGRvbTogSlNET00gfCB1bmRlZmluZWQ7XG5cbiAgICBpZiAoaW5saW5lQ3JpdGljYWxDc3MpIHtcbiAgICAgIC8vIFdvcmthcm91bmQgZm9yIGh0dHBzOi8vZ2l0aHViLmNvbS9Hb29nbGVDaHJvbWVMYWJzL2NyaXR0ZXJzL2lzc3Vlcy82NFxuICAgICAgaHRtbENvbnRlbnQgPSBodG1sQ29udGVudC5yZXBsYWNlKFxuICAgICAgICAvIG1lZGlhPVxcXCJwcmludFxcXCIgb25sb2FkPVxcXCJ0aGlzXFwubWVkaWE9J2FsbCdcIj48bm9zY3JpcHQ+PGxpbmsgLis/PjxcXC9ub3NjcmlwdD4vZyxcbiAgICAgICAgJz4nLFxuICAgICAgKTtcbiAgICB9XG5cbiAgICB0cnkge1xuICAgICAgZG9tID0gbmV3IEpTRE9NKGh0bWxDb250ZW50LCB7XG4gICAgICAgIHJ1blNjcmlwdHM6ICdkYW5nZXJvdXNseScsXG4gICAgICAgIHJlc291cmNlczogY3VzdG9tUmVzb3VyY2VMb2FkZXIsXG4gICAgICAgIHVybDogb3B0aW9ucy51cmwsXG4gICAgICAgIHJlZmVycmVyOiBvcHRpb25zLmhlYWRlcnM/LnJlZmVycmVyIGFzIHN0cmluZyB8IHVuZGVmaW5lZCxcbiAgICAgICAgdXNlckFnZW50OiBvcHRpb25zLmhlYWRlcnM/LlsndXNlci1hZ2VudCddIGFzIHN0cmluZyB8IHVuZGVmaW5lZCxcbiAgICAgICAgYmVmb3JlUGFyc2U6ICh3aW5kb3cpID0+IHtcbiAgICAgICAgICBhdWdtZW50V2luZG93V2l0aFN0dWJzKHdpbmRvdyk7XG4gICAgICAgICAgd2luZG93Lm5nUmVuZGVyTW9kZSA9IHRydWU7XG4gICAgICAgIH0sXG4gICAgICB9KTtcblxuICAgICAgY29uc3QgZG9jID0gZG9tLndpbmRvdy5kb2N1bWVudDtcblxuICAgICAgLy8gNjBzIHRpbWVvdXQuXG4gICAgICBjb25zdCBzdGFibGl6YXRpb25UaW1lb3V0ID0gc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcignQW5ndWxhciBhcHBsaWNhdGlvbiBmYWlsZWQgdG8gc3RhYmxpemUgYWZ0ZXIgaW4gdGltZS4nKTtcbiAgICAgIH0sIDYwMDAwKTtcblxuICAgICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOiBuby1zaGFkb3dlZC12YXJpYWJsZVxuICAgICAgY29uc3QgbmdSZW5kZXJNb2RlID0gYXdhaXQgbmV3IFByb21pc2U8TkdSZW5kZXJNb2RlQVBJPigocmVzb2x2ZSkgPT4ge1xuICAgICAgICBjb25zdCBpbnRlcnZhbCA9IHNldEludGVydmFsKCgpID0+IHtcbiAgICAgICAgICBjb25zdCBuZ0RPTU1vZGUgPSBkb20/LndpbmRvdy5uZ1JlbmRlck1vZGUgYXMgTkdSZW5kZXJNb2RlO1xuICAgICAgICAgIGlmIChuZ0RPTU1vZGUgJiYgdHlwZW9mIG5nRE9NTW9kZSA9PT0gJ29iamVjdCcpIHtcbiAgICAgICAgICAgIC8vIFBvbGwgdW50aWwgbmdET01Nb2RlIGlzIGFuIG9iamVjdC5cbiAgICAgICAgICAgIGNsZWFyVGltZW91dChzdGFibGl6YXRpb25UaW1lb3V0KTtcbiAgICAgICAgICAgIGNsZWFySW50ZXJ2YWwoaW50ZXJ2YWwpO1xuICAgICAgICAgICAgcmVzb2x2ZShuZ0RPTU1vZGUpO1xuICAgICAgICAgIH1cbiAgICAgICAgfSwgMzApO1xuICAgICAgfSk7XG5cbiAgICAgIGF3YWl0IG5nUmVuZGVyTW9kZS5nZXRXaGVuU3RhYmxlKCk7XG4gICAgICBkb2MucXVlcnlTZWxlY3RvcignW25nLXZlcnNpb25dJyk/LnNldEF0dHJpYnV0ZSgnbmctY2xvdmVyJywgJycpO1xuXG4gICAgICAvLyBBZGQgQW5ndWxhciBzdGF0ZVxuICAgICAgY29uc3Qgc3RhdGUgPSBuZ1JlbmRlck1vZGUuZ2V0U2VyaWFsaXplZFN0YXRlKCk7XG4gICAgICBpZiAoc3RhdGUpIHtcbiAgICAgICAgY29uc3Qgc2NyaXB0ID0gZG9jLmNyZWF0ZUVsZW1lbnQoJ3NjcmlwdCcpO1xuICAgICAgICBzY3JpcHQuaWQgPSBgJHtuZ1JlbmRlck1vZGUuYXBwSWR9LXN0YXRlYDtcbiAgICAgICAgc2NyaXB0LnNldEF0dHJpYnV0ZSgndHlwZScsICdhcHBsaWNhdGlvbi9qc29uJyk7XG4gICAgICAgIHNjcmlwdC50ZXh0Q29udGVudCA9IHN0YXRlO1xuICAgICAgICBkb2MuYm9keS5hcHBlbmRDaGlsZChzY3JpcHQpO1xuICAgICAgfVxuXG4gICAgICBjb25zdCBjb250ZW50ID0gZG9tLnNlcmlhbGl6ZSgpO1xuICAgICAgaWYgKCFpbmxpbmVDcml0aWNhbENzcykge1xuICAgICAgICByZXR1cm4gY29udGVudDtcbiAgICAgIH1cblxuICAgICAgY29uc3QgYmFzZUhyZWYgPSBkb2MucXVlcnlTZWxlY3RvcignYmFzZVtocmVmXScpPy5nZXRBdHRyaWJ1dGUoJ2hyZWYnKSA/PyAnJztcbiAgICAgIGNvbnN0IHtcbiAgICAgICAgY29udGVudDogY29udGVudFdpdGhJbmxpbmVDU1MsXG4gICAgICAgIHdhcm5pbmdzLFxuICAgICAgICBlcnJvcnMsXG4gICAgICB9ID0gYXdhaXQgdGhpcy5pbmxpbmVDcml0aWNhbENzc1Byb2Nlc3Nvci5wcm9jZXNzKGNvbnRlbnQsIHtcbiAgICAgICAgb3V0cHV0UGF0aDogcGF0aC5qb2luKG9wdGlvbnMucHVibGljUGF0aCwgYmFzZUhyZWYpLFxuICAgICAgfSk7XG5cbiAgICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTogbm8tY29uc29sZVxuICAgICAgd2FybmluZ3M/LmZvckVhY2goKG0pID0+IGNvbnNvbGUud2FybihtKSk7XG4gICAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6IG5vLWNvbnNvbGVcbiAgICAgIGVycm9ycz8uZm9yRWFjaCgobSkgPT4gY29uc29sZS5lcnJvcihtKSk7XG5cbiAgICAgIHJldHVybiBjb250ZW50V2l0aElubGluZUNTUztcbiAgICB9IGZpbmFsbHkge1xuICAgICAgZG9tPy53aW5kb3cuY2xvc2UoKTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGFzeW5jIGdldFByZXJlbmRlcmVkU25hcHNob3QoXG4gICAgcHVibGljUGF0aDogc3RyaW5nLFxuICAgIHBhdGhuYW1lOiBzdHJpbmcsXG4gICk6IFByb21pc2U8c3RyaW5nIHwgdW5kZWZpbmVkPiB7XG4gICAgLy8gUmVtb3ZlIGxlYWRpbmcgZm9yd2FyZCBzbGFzaC5cbiAgICBjb25zdCBwYWdlUGF0aCA9IHBhdGgucmVzb2x2ZShwdWJsaWNQYXRoLCBwYXRobmFtZS5zdWJzdHJpbmcoMSksICdpbmRleC5odG1sJyk7XG4gICAgY29uc3QgY29udGVudCA9IGF3YWl0IHRoaXMucmVhZEhUTUxGaWxlKHBhZ2VQYXRoKTtcblxuICAgIHJldHVybiBjb250ZW50Py5pbmNsdWRlcygnbmctdmVyc2lvbj0nKVxuICAgICAgPyBjb250ZW50IC8vIFBhZ2UgaXMgcHJlLXJlbmRlcmVkXG4gICAgICA6IHVuZGVmaW5lZDtcbiAgfVxuXG4gIHByaXZhdGUgYXN5bmMgZ2V0SHRtbFRlbXBsYXRlKFxuICAgIHB1YmxpY1BhdGg6IHN0cmluZyxcbiAgICBwYXRobmFtZTogc3RyaW5nLFxuICAgIGh0bWxGaWxlbmFtZSA9ICdpbmRleC5odG1sJyxcbiAgKTogUHJvbWlzZTxzdHJpbmc+IHtcbiAgICBjb25zdCBmaWxlcyA9IFtwYXRoLmpvaW4ocHVibGljUGF0aCwgaHRtbEZpbGVuYW1lKV07XG5cbiAgICBjb25zdCBwb3RlbnRpYWxMb2NhbGVQYXRoID0gcGF0aG5hbWUuc3BsaXQoJy8nLCAyKVsxXTsgLy8gcG90ZW50aWFsIGJhc2UgaHJlZlxuICAgIGlmIChwb3RlbnRpYWxMb2NhbGVQYXRoKSB7XG4gICAgICBmaWxlcy5wdXNoKHBhdGguam9pbihwdWJsaWNQYXRoLCBwb3RlbnRpYWxMb2NhbGVQYXRoLCBodG1sRmlsZW5hbWUpKTtcbiAgICB9XG5cbiAgICBmb3IgKGNvbnN0IGZpbGUgb2YgZmlsZXMpIHtcbiAgICAgIGNvbnN0IGNvbnRlbnQgPSBhd2FpdCB0aGlzLnJlYWRIVE1MRmlsZShmaWxlKTtcbiAgICAgIGlmIChjb250ZW50KSB7XG4gICAgICAgIHJldHVybiBjb250ZW50O1xuICAgICAgfVxuICAgIH1cblxuICAgIHRocm93IG5ldyBFcnJvcihgQ2Fubm90IGZpbGUgSFRNTCBmaWxlLiBMb29rZWQgaW46ICR7ZmlsZXMuam9pbignLCAnKX1gKTtcbiAgfVxuXG4gIHByaXZhdGUgYXN5bmMgZmlsZUV4aXN0cyhmaWxlUGF0aDogc3RyaW5nKTogUHJvbWlzZTxib29sZWFuPiB7XG4gICAgY29uc3QgZmlsZUV4aXN0cyA9IHRoaXMuZmlsZUV4aXN0c0NhY2hlLmdldChmaWxlUGF0aCk7XG4gICAgaWYgKGZpbGVFeGlzdHMgPT09IHVuZGVmaW5lZCkge1xuICAgICAgdHJ5IHtcbiAgICAgICAgYXdhaXQgZnMucHJvbWlzZXMuYWNjZXNzKGZpbGVQYXRoLCBmcy5jb25zdGFudHMuRl9PSyk7XG4gICAgICAgIHRoaXMuZmlsZUV4aXN0c0NhY2hlLnNldChmaWxlUGF0aCwgdHJ1ZSk7XG5cbiAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICB9IGNhdGNoIHtcbiAgICAgICAgdGhpcy5maWxlRXhpc3RzQ2FjaGUuc2V0KGZpbGVQYXRoLCBmYWxzZSk7XG5cbiAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgfVxuICAgIH1cblxuICAgIHJldHVybiBmaWxlRXhpc3RzO1xuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyByZWFkSFRNTEZpbGUoZmlsZVBhdGg6IHN0cmluZyk6IFByb21pc2U8c3RyaW5nIHwgdW5kZWZpbmVkPiB7XG4gICAgaWYgKHRoaXMuaHRtbEZpbGVDYWNoZS5oYXMoZmlsZVBhdGgpKSB7XG4gICAgICByZXR1cm4gdGhpcy5odG1sRmlsZUNhY2hlLmdldChmaWxlUGF0aCk7XG4gICAgfVxuXG4gICAgaWYgKGF3YWl0IHRoaXMuZmlsZUV4aXN0cyhmaWxlUGF0aCkpIHtcbiAgICAgIGNvbnN0IGNvbnRlbnQgPSBhd2FpdCBmcy5wcm9taXNlcy5yZWFkRmlsZShmaWxlUGF0aCwgJ3V0Zi04Jyk7XG4gICAgICB0aGlzLmh0bWxGaWxlQ2FjaGUuc2V0KGZpbGVQYXRoLCBjb250ZW50KTtcblxuICAgICAgcmV0dXJuIGNvbnRlbnQ7XG4gICAgfVxuXG4gICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgfVxufVxuIl19